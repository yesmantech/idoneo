import{j as e}from"./framer-BdaCTGm4.js";import{a as L,r as i}from"./router-ClfHAwMg.js";import{A as T}from"./AdminLayout-kYIYYLNk.js";import{A as O}from"./AdminPageHeader-CVyPYYOb.js";import{A as P,E as R}from"./EmptyState-DbBsm3yu.js";import{S as D}from"./StatusBadge-CYGANFXg.js";import{s as y}from"./index-BBBGEo7o.js";import{q as Q,X as _,ap as B,I as G,h as H,aq as K,ag as W}from"./icons-ByDj-hsa.js";import"./react-vendor-B--z-fyW.js";import"./supabase-CIvuJI4W.js";const I={quizId:"",name:"",code:"",description:"",isArchived:!1};function X(){const[h,m]=L(),[p,l]=i.useState([]),[n,b]=i.useState([]),[v,g]=i.useState(!0),[u,f]=i.useState(null),[j,w]=i.useState(!1),o=h.get("quiz")||"",[a,S]=i.useState(null),[c,N]=i.useState(I),[A,k]=i.useState(!1),[F,d]=i.useState(null),[C,x]=i.useState(null),z=i.useCallback(async()=>{g(!0),f(null);try{const[t,r]=await Promise.all([y.from("subjects").select("*").order("name"),y.from("quizzes").select("*").order("title")]);if(t.error)throw t.error;if(r.error)throw r.error;l(t.data||[]),b(r.data||[])}catch(t){const r=t instanceof Error?t.message:"Errore nel caricamento";console.error(t),f(r)}finally{g(!1)}},[]);i.useEffect(()=>{z()},[z]);const q=t=>{m(t?{quiz:t}:{})};return{visibleSubjects:p.filter(t=>!(o&&t.quiz_id!==o||!j&&t.is_archived)),quizzes:n,loading:v,error:u,filterQuizId:o,setFilterQuizId:q,showArchived:j,setShowArchived:w,editingId:a,formData:c,formSaving:A,formError:F,formSuccess:C,startCreate:()=>{S(null),N({...I,quizId:o||(n.length>0?n[0].id:"")}),d(null),x(null)},startEdit:t=>{S(t.id),N({quizId:t.quiz_id,name:t.name,code:t.code||"",description:t.description||"",isArchived:t.is_archived||!1}),d(null),x(null)},updateFormField:(t,r)=>{N(E=>({...E,[t]:r})),d(null)},saveSubject:async()=>{k(!0),d(null),x(null);try{if(!c.name.trim())throw new Error("Il nome della materia Ã¨ obbligatorio.");if(!c.quizId)throw new Error("Seleziona un concorso di appartenenza.");const t={quiz_id:c.quizId,name:c.name.trim(),code:c.code.trim()||null,description:c.description.trim()||null,is_archived:c.isArchived};if(a){const{error:r}=await y.from("subjects").update(t).eq("id",a);if(r)throw r;x("Materia aggiornata âœ…")}else{const{error:r}=await y.from("subjects").insert(t);if(r)throw r;x("Materia creata âœ…")}await z(),a||N(r=>({...I,quizId:r.quizId}))}catch(t){const r=t instanceof Error?t.message:"Errore salvataggio";console.error("Save Error:",t),d(r)}finally{k(!1)}},toggleArchive:async t=>{try{const{error:r}=await y.from("subjects").update({is_archived:!t.is_archived}).eq("id",t.id);if(r)throw r;await z()}catch(r){console.error(r),alert("Errore aggiornamento stato.")}},getQuizTitle:t=>{const r=n.find(E=>E.id===t);return r?r.title:"???"}}}function $({isOpen:h,onClose:m,editingId:p,formData:l,formSaving:n,formError:b,formSuccess:v,quizzes:g,updateFormField:u,onSave:f}){if(!h)return null;const j=a=>{a.preventDefault(),f()},w=g.filter(a=>!a.is_archived||a.id===l.quizId),o="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[#00B1FF]/30 focus:border-[#00B1FF] transition-all";return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:m}),e.jsxs("div",{className:"relative bg-white rounded-[20px] shadow-2xl w-full max-w-lg overflow-hidden flex flex-col animate-in fade-in zoom-in-95 duration-200",children:[e.jsxs("div",{className:"p-6 border-b border-slate-100 flex items-center justify-between bg-gradient-to-r from-slate-50 to-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-violet-50 flex items-center justify-center",children:e.jsx(Q,{className:"w-5 h-5 text-violet-500"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-slate-900",children:p?"Modifica Materia":"Nuova Materia"}),e.jsx("p",{className:"text-sm text-slate-500",children:p?"Modifica i dettagli della materia":"Aggiungi una nuova materia al concorso"})]})]}),e.jsx("button",{onClick:m,className:"w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-500 hover:text-slate-700 transition-all",children:e.jsx(_,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:j,className:"p-6 space-y-5 bg-[#F5F5F7]",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1.5",children:"Concorso di appartenenza *"}),e.jsxs("select",{value:l.quizId,onChange:a=>u("quizId",a.target.value),className:o,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Seleziona un concorso..."}),w.map(a=>e.jsx("option",{value:a.id,children:a.title},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1.5",children:"Nome Materia *"}),e.jsx("input",{type:"text",value:l.name,onChange:a=>u("name",a.target.value),placeholder:"Es. Diritto Costituzionale",className:o,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1.5",children:"Codice (opzionale)"}),e.jsx("input",{type:"text",value:l.code,onChange:a=>u("code",a.target.value),placeholder:"Es. MAT-01",className:o})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1.5",children:"Descrizione"}),e.jsx("textarea",{value:l.description,onChange:a=>u("description",a.target.value),rows:3,placeholder:"Descrizione opzionale della materia...",className:`${o} resize-none`})]}),e.jsx("div",{className:"bg-white rounded-xl p-4 border border-slate-100",children:e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer select-none",children:[e.jsxs("div",{className:"relative flex items-center",children:[e.jsx("input",{type:"checkbox",id:"isArchived",checked:l.isArchived,onChange:a=>u("isArchived",a.target.checked),className:"peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-slate-300 transition-all checked:border-orange-500 checked:bg-orange-500"}),e.jsx("div",{className:"pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white opacity-0 peer-checked:opacity-100",children:e.jsx(B,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-4 h-4 text-orange-500"}),e.jsx("span",{className:"text-sm font-medium text-slate-700",children:"Archivia materia (nascondi dagli elenchi)"})]})]})}),b&&e.jsxs("div",{className:"p-4 bg-red-50 border border-red-100 rounded-xl text-red-600 text-sm flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0",children:e.jsx(_,{className:"w-4 h-4 text-red-500"})}),b]}),v&&e.jsxs("div",{className:"p-4 bg-emerald-50 border border-emerald-100 rounded-xl text-emerald-600 text-sm flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center flex-shrink-0",children:e.jsx(G,{className:"w-4 h-4 text-emerald-500"})}),v]})]}),e.jsxs("div",{className:"p-4 border-t border-slate-100 flex justify-end gap-3 bg-white",children:[e.jsx("button",{type:"button",onClick:m,disabled:n,className:"px-5 py-2.5 text-slate-600 hover:text-slate-900 hover:bg-slate-100 font-medium rounded-xl transition-colors disabled:opacity-50",children:"Chiudi"}),e.jsx("button",{type:"button",onClick:f,disabled:n,className:"px-6 py-2.5 bg-[#00B1FF] hover:bg-[#00a0e6] text-white font-bold rounded-xl shadow-lg shadow-blue-500/20 transition-all disabled:opacity-50 flex items-center gap-2",children:n?e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"w-4 h-4 animate-spin"}),"Salvataggio..."]}):p?"Salva Modifiche":"Crea Materia"})]})]})]})}function de(){const{visibleSubjects:h,quizzes:m,loading:p,error:l,filterQuizId:n,setFilterQuizId:b,showArchived:v,setShowArchived:g,editingId:u,formData:f,formSaving:j,formError:w,formSuccess:o,startCreate:a,startEdit:S,updateFormField:c,saveSubject:N,toggleArchive:A,getQuizTitle:k}=X(),[F,d]=i.useState(!1),C=()=>{a(),d(!0)},x=s=>{S(s),d(!0)},z=async()=>{await N(),w||d(!1)},q=[{key:"name",label:"Materia",render:s=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-violet-50 flex items-center justify-center",children:e.jsx(Q,{className:"w-5 h-5 text-violet-500"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-slate-900",children:s.name}),s.code&&e.jsx("div",{className:"text-xs text-slate-400 font-mono",children:s.code})]})]})},{key:"quiz",label:"Concorso",render:s=>e.jsx("span",{className:"text-slate-600 text-sm font-medium",children:k(s.quiz_id)})},{key:"status",label:"Stato",width:"100px",render:s=>e.jsx(D,{label:s.is_archived?"Archiviato":"Attivo",variant:s.is_archived?"warning":"success"})}],M=s=>[{label:"Modifica",icon:"âœï¸",onClick:()=>x(s)},{label:s.is_archived?"Ripristina":"Archivia",icon:s.is_archived?"ðŸ“¤":"ðŸ“",onClick:()=>A(s)}];return e.jsxs(T,{children:[e.jsx(O,{title:"Materie",subtitle:"Gestisci le materie di studio suddivise per concorso",breadcrumb:[{label:"Quiz",path:"/admin/quiz"},{label:"Materie"}],action:{label:"Nuova Materia",icon:"+",onClick:C}}),e.jsxs("div",{className:"mb-6 p-4 bg-white border border-slate-200 rounded-2xl shadow-sm flex flex-col md:flex-row gap-4 items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 w-full md:w-auto",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-slate-500",children:[e.jsx(K,{className:"w-4 h-4"}),e.jsx("span",{children:"Concorso:"})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:n,onChange:s=>b(s.target.value),className:"appearance-none bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-xl px-4 py-2.5 pr-10 focus:ring-2 focus:ring-[#00B1FF]/30 focus:border-[#00B1FF] outline-none min-w-[220px] font-medium transition-all",children:[e.jsx("option",{value:"",children:"Tutti i concorsi"}),m.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]}),e.jsx(W,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"})]})]}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"text-sm text-slate-500",children:[e.jsx("span",{className:"font-bold text-slate-900",children:h.length})," materi",h.length===1?"a":"e"]}),e.jsxs("label",{className:"flex items-center gap-2.5 text-sm text-slate-600 cursor-pointer select-none",children:[e.jsxs("div",{className:"relative flex items-center",children:[e.jsx("input",{type:"checkbox",checked:v,onChange:s=>g(s.target.checked),className:"peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-slate-300 transition-all checked:border-[#00B1FF] checked:bg-[#00B1FF]"}),e.jsx("div",{className:"pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white opacity-0 peer-checked:opacity-100",children:e.jsx("svg",{className:"h-3.5 w-3.5",viewBox:"0 0 14 14",fill:"none",children:e.jsx("path",{d:"M11.6666 3.5L5.24992 9.91667L2.33325 7",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]}),"Mostra archiviati"]})]})]}),l&&e.jsxs("div",{className:"mb-4 p-4 bg-red-50 border border-red-100 rounded-xl text-red-600 text-sm",children:["âŒ ",l]}),e.jsx(P,{columns:q,data:h,loading:p,rowKey:s=>s.id,onRowClick:x,rowActions:M,emptyState:e.jsx(R,{icon:"ðŸ“š",title:"Nessuna materia trovata",description:n?"Questo concorso non ha ancora materie associate.":"Non hai ancora creato nessuna materia.",action:{label:"Crea Materia",onClick:C}})}),e.jsx($,{isOpen:F,onClose:()=>d(!1),editingId:u,formData:f,formSaving:j,formError:w,formSuccess:o,quizzes:m,updateFormField:c,onSave:z})]})}export{de as default};
