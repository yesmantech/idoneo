import{j as e}from"./framer-BdaCTGm4.js";import{b as E,u as I,r as d}from"./router-ClfHAwMg.js";import{s as o,b as Q}from"./index-BBBGEo7o.js";import{t as B,j as A,u as R,o as q,m as U,v as L}from"./icons-ByDj-hsa.js";import"./react-vendor-B--z-fyW.js";import"./supabase-CIvuJI4W.js";function w(t){return t?t.replace(/[.,:;()[\]]/g,"").trim().toLowerCase():null}function O(t){return t?t.correct_option?w(t.correct_option):t.correct_answer?w(t.correct_answer):t.answer?w(t.answer):null:null}function G(){const{id:t}=E(),c=I(),[j,f]=d.useState(null),[F,p]=d.useState(!0),[k,N]=d.useState(!1),[v,z]=d.useState(!1),[a,C]=d.useState(null);d.useEffect(()=>{(async()=>{if(!t){f("Quiz non specificato"),p(!1);return}try{const{data:{user:i}}=await o.auth.getUser();if(!i){c("/login");return}let l=null;const g=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t);let n=o.from("quizzes").select("id, title, time_limit");g?n=n.eq("id",t):n=n.eq("slug",t);const m=await n.single();if(m.error||!m.data)throw new Error("Quiz non trovato");l=m.data;const{data:h}=await o.from("subjects").select("id").eq("quiz_id",l.id).eq("is_archived",!1),x=(h==null?void 0:h.map(s=>s.id))||[],{count:b}=await o.from("questions").select("*",{count:"exact",head:!0}).in("subject_id",x).eq("is_archived",!1),u={id:l.id,title:l.title,time_limit:l.time_limit,question_count:b||0};if(C(u),localStorage.getItem("skip_official_rules")==="true"&&await _(u))return;p(!1)}catch(i){console.error("Quiz details error:",i),f(i.message),p(!1)}})()},[t,c]);const _=async(r=a)=>{if(!r)return!1;N(!0),f(null),v&&localStorage.setItem("skip_official_rules","true");try{const{data:{user:i}}=await o.auth.getUser();if(!i)throw new Error("Utente non autenticato");const{data:l}=await o.from("subjects").select("id").eq("quiz_id",r.id).eq("is_archived",!1);if(!(l!=null&&l.length))throw new Error("Nessuna materia trovata");const g=l.map(s=>s.id),{data:n,error:m}=await o.from("questions").select("*, subject:subjects(name)").in("subject_id",g).eq("is_archived",!1);if(m||!(n!=null&&n.length))throw new Error("Nessuna domanda disponibile");const x=n.sort(()=>Math.random()-.5).map(s=>{var S;return{questionId:s.id,text:s.text,subjectId:s.subject_id,subjectName:((S=s.subject)==null?void 0:S.name)||"Materia",selectedOption:null,correctOption:O(s),isCorrect:!1,isSkipped:!1,explanation:s.explanation||null,options:{a:s.option_a,b:s.option_b,c:s.option_c,d:s.option_d}}}),{data:b,error:u}=await o.from("quiz_attempts").insert({quiz_id:r.id,user_id:i.id,score:0,answers:x,total_questions:x.length,correct:0,wrong:0,blank:0,started_at:new Date().toISOString(),mode:"official"}).select().single();if(u||!b)throw u;Q.track("quiz_started",{quiz_id:r.id,title:r.title,mode:"official",questions_count:x.length});const y=r.time_limit?`time=${r.time_limit}`:"time=0";return c(`/quiz/run/${b.id}?mode=official&${y}`),!0}catch(i){return console.error("Start error:",i),f(i.message),N(!1),!1}};return F?e.jsx("div",{className:"min-h-screen bg-[#F5F5F7] flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 border-2 border-[#00B1FF] border-t-transparent rounded-full animate-spin"})}):j?e.jsx("div",{className:"min-h-screen bg-[#F5F5F7] flex flex-col items-center justify-center p-4",children:e.jsxs("div",{className:"bg-red-50 text-red-600 p-4 rounded-xl max-w-sm text-center",children:[e.jsx(B,{className:"w-8 h-8 mx-auto mb-2"}),e.jsx("p",{className:"font-medium",children:j}),e.jsx("button",{onClick:()=>c(-1),className:"mt-4 text-sm font-bold underline",children:"Torna indietro"})]})}):e.jsxs("div",{className:"min-h-screen bg-slate-50 dark:bg-slate-900 pb-20 transition-colors duration-300",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-white dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 pt-safe transition-colors",children:e.jsxs("div",{className:"px-4 h-14 flex items-center gap-3 max-w-3xl mx-auto w-full",children:[e.jsx("button",{onClick:()=>c(-1),className:"w-10 h-10 -ml-2 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors",children:e.jsx(A,{className:"w-5 h-5 text-slate-400 dark:text-slate-500 rotate-180"})}),e.jsx("span",{className:"font-semibold text-slate-900 dark:text-white",children:"Simulazione Ufficiale"})]})}),e.jsxs("main",{className:"px-5 py-6 max-w-lg mx-auto w-full",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white mb-2",children:a==null?void 0:a.title}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 mb-8",children:"Questa simulazione replica le condizioni reali dell'esame ufficiale."}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-8",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(R,{className:"w-4 h-4 text-[#00B1FF]"}),e.jsx("span",{className:"text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider",children:"QUESITI"})]}),e.jsx("p",{className:"text-xl font-bold text-slate-900 dark:text-white",children:a==null?void 0:a.question_count})]}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(q,{className:"w-4 h-4 text-[#00B1FF]"}),e.jsx("span",{className:"text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider",children:"TEMPO"})]}),e.jsx("p",{className:"text-xl font-bold text-slate-900 dark:text-white",children:a!=null&&a.time_limit?`${a.time_limit} min`:"Illimitato"})]})]}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-sm border border-slate-100 dark:border-slate-700 mb-6 transition-colors",children:[e.jsxs("h3",{className:"font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2",children:[e.jsx(U,{className:"w-5 h-5 text-amber-500"}),"Regole Punteggio"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl",children:[e.jsx("span",{className:"text-sm font-medium text-slate-600 dark:text-slate-300",children:"Risposta Corretta"}),e.jsx("span",{className:"text-sm font-bold text-emerald-600 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-900/30 px-2 py-1 rounded-md",children:"+1.00"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl",children:[e.jsx("span",{className:"text-sm font-medium text-slate-600 dark:text-slate-300",children:"Risposta Errata"}),e.jsx("span",{className:"text-sm font-bold text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/30 px-2 py-1 rounded-md",children:"-0.10"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl",children:[e.jsx("span",{className:"text-sm font-medium text-slate-600 dark:text-slate-300",children:"Risposta Non data"}),e.jsx("span",{className:"text-sm font-bold text-slate-600 dark:text-slate-400 bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded-md",children:"0.00"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 px-2",children:[e.jsxs("div",{className:"relative flex items-center",children:[e.jsx("input",{type:"checkbox",id:"dontShowAgain",checked:v,onChange:r=>z(r.target.checked),className:"peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 transition-all checked:border-[#00B1FF] checked:bg-[#00B1FF]"}),e.jsx("div",{className:"pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white opacity-0 peer-checked:opacity-100",children:e.jsx("svg",{className:"h-3.5 w-3.5",viewBox:"0 0 14 14",fill:"none",children:e.jsx("path",{d:"M11.6666 3.5L5.24992 9.91667L2.33325 7",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]}),e.jsx("label",{htmlFor:"dontShowAgain",className:"text-sm text-slate-500 dark:text-slate-400 cursor-pointer select-none",children:"Non mostrare piÃ¹ questa schermata"})]})]}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 py-3 px-4 bg-white/95 dark:bg-slate-900/95 backdrop-blur-lg border-t border-slate-100 dark:border-slate-800 transition-colors",style:{paddingBottom:"max(12px, env(safe-area-inset-bottom))"},children:e.jsx("div",{className:"max-w-lg mx-auto",children:e.jsx("button",{onClick:()=>_(),disabled:k,className:"w-full py-4 rounded-2xl bg-[#00B1FF] text-white font-bold text-lg shadow-lg shadow-blue-500/20 active:scale-[0.98] transition-all flex items-center justify-center gap-2",children:k?e.jsx("div",{className:"w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsxs(e.Fragment,{children:["Avvia Simulazione ",e.jsx(L,{className:"w-5 h-5 fill-current"})]})})})})]})}export{G as default};
