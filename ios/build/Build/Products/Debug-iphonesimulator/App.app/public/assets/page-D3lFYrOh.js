import{j as e}from"./framer-BdaCTGm4.js";import{u as ee,r as n}from"./router-ClfHAwMg.js";import{s as g}from"./index-BBBGEo7o.js";import{A as te}from"./AdminLayout-kYIYYLNk.js";import{A as se}from"./AdminPageHeader-CVyPYYOb.js";import"./react-vendor-B--z-fyW.js";import"./supabase-CIvuJI4W.js";import"./icons-ByDj-hsa.js";const V="question-images";function T(v){return v.trim().replace(/\s+/g,"_").toLowerCase()}function me(){ee();const[v,D]=n.useState([]),[G,C]=n.useState([]),[m,Q]=n.useState(""),[y,k]=n.useState(""),[u,S]=n.useState(null),[z,N]=n.useState([]),[I,F]=n.useState(!1),[f,b]=n.useState(null),[x,J]=n.useState(null),[E,U]=n.useState(!1),[j,w]=n.useState(null);n.useEffect(()=>{g.from("quizzes").select("*").order("created_at",{ascending:!1}).then(({data:t})=>D(t||[]))},[]),n.useEffect(()=>{if(!m){C([]);return}g.from("subjects").select("*").eq("quiz_id",m).then(({data:t})=>{const a=t||[];C(a),a.length>0&&k(a[0].id)})},[m]);const $=async t=>{const o=(await t.text()).split(/\r?\n/).filter(c=>c.trim().length>0);if(o.length<2)throw new Error("CSV vuoto o senza righe.");const s=o[0],i=s.includes(";")?";":",",r=c=>{const l=i===";"?/(".*?"|[^";]+)(?=\s*;|\s*$)/g:/(".*?"|[^",]+)(?=\s*,|\s*$)/g;return(c.match(l)||[]).map(h=>h.replace(/^"|"$/g,"").trim())},p=r(s).map(c=>c.toLowerCase().replace(/['"]/g,"").trim()),d=c=>p.findIndex(l=>c.includes(l)),q=d(["question_text","question","domanda","testo"]),P=d(["option_a","a","opzione_a"]),X=d(["option_b","b","opzione_b"]),Y=d(["option_c","c","opzione_c"]),Z=d(["option_d","d","opzione_d"]),B=d(["correct_option","correct","correct_answer","risposta","esatta"]),L=d(["subject_id","subject","materia"]),A=d(["image_name","image","immagine","img"]),M=d(["explanation","spiegazione","commento"]);if(q===-1||P===-1||B===-1)throw new Error(`Colonne obbligatorie mancanti. Trovate: ${p.join(", ")}. Servono: question_text, option_a... correct_option`);const R=[];for(let c=1;c<o.length;c++){const l=r(o[c]);if(l.length<3)continue;const _=l[B]??"",h=_.replace(/[.,:;()\[\]"' ]/g,"").toLowerCase().substring(0,1);if(!["a","b","c","d"].includes(h)){console.warn(`Row ${c}: Invalid correct option '${_}' (cleaned: '${h}'). Skipping.`);continue}R.push({question_text:l[q]??"",option_a:l[P]??"",option_b:l[X]??"",option_c:l[Y]??"",option_d:l[Z]??"",correct_option:h,subject_id:L>-1?l[L]:void 0,image_name:A>-1?l[A]:void 0,explanation:M>-1?l[M]:void 0})}return R},O=async t=>{var o;const a=(o=t.target.files)==null?void 0:o[0];if(S(a||null),N([]),b(null),a)try{const s=await $(a);N(s.slice(0,5)),b({type:"success",text:`File letto correttamente. ${s.length} domande valide trovate.`})}catch(s){b({type:"error",text:s.message})}},H=async()=>{if(!(!m||!u)){F(!0);try{const t=await $(u),a=[];for(const s of t){let i=s.subject_id;if(!i&&y&&(i=y),!i)continue;let r=null;if(s.image_name){const{data:p}=g.storage.from(V).getPublicUrl(T(s.image_name));r=p.publicUrl}a.push({quiz_id:m,subject_id:i,text:s.question_text,option_a:s.option_a,option_b:s.option_b,option_c:s.option_c,option_d:s.option_d,correct_option:s.correct_option,image_url:r,explanation:s.explanation})}if(a.length===0)throw new Error("Nessuna riga valida da importare.");const{error:o}=await g.from("questions").insert(a);if(o)throw o;b({type:"success",text:`Importazione completata! ${a.length} domande aggiunte.`}),S(null),N([])}catch(t){console.error(t),b({type:"error",text:t.message||"Errore import."})}finally{F(!1)}}},K=async()=>{if(!x||x.length===0)return;U(!0),w(null);let t=0,a=0;try{for(let o=0;o<x.length;o++){const s=x[o],i=T(s.name),{error:r}=await g.storage.from(V).upload(i,s,{upsert:!0});r?(console.error("Upload fail:",i,r),a++):t++}w({type:t>0?"success":"error",text:`Caricate: ${t}, Errori: ${a}`})}catch{w({type:"error",text:"Errore upload massivo."})}finally{U(!1)}},W=()=>{const t=["question_text","option_a","option_b","option_c","option_d","correct_option","subject","image_name","explanation"],a=[[`"Qual √® la capitale d'Italia?"`,'"Roma"','"Milano"','"Napoli"','"Torino"','"A"','"Geografia"','"capitale.jpg"','"Roma √® la capitale dal 1871..."'],['"Quanto fa 2+2?"','"3"','"4"','"5"','"6"','"B"','"Matematica"','""','""']],o=[t.join(","),...a.map(p=>p.join(","))].join(`
`),s=new Blob(["\uFEFF"+o],{type:"text/csv;charset=utf-8"}),i=URL.createObjectURL(s),r=document.createElement("a");r.style.display="none",r.href=i,r.download="template_domande.csv",document.body.appendChild(r),r.click(),setTimeout(()=>{document.body.removeChild(r),URL.revokeObjectURL(i)},100)};return e.jsx(te,{children:e.jsxs("div",{className:"mx-auto max-w-5xl",children:[e.jsx(se,{title:"Import Massivo",subtitle:"Carica domande e immagini in blocco per popolare i tuoi concorsi.",breadcrumb:[{label:"Admin",path:"/admin"},{label:"Import CSV"}]}),e.jsxs("div",{className:"flex gap-3 mb-8",children:[e.jsx("span",{className:"px-3 py-1.5 rounded-lg bg-emerald-50 text-emerald-600 text-xs font-bold border border-emerald-200",children:".CSV (UTF-8)"}),e.jsx("span",{className:"px-3 py-1.5 rounded-lg bg-sky-50 text-sky-600 text-xs font-bold border border-sky-200",children:".JPG / .PNG"})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-8 items-start",children:[e.jsxs("div",{className:"bg-white border border-slate-200/50 rounded-[20px] p-8 shadow-[0_4px_16px_rgba(0,0,0,0.04)] relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 right-0 p-4 opacity-5",children:e.jsx("span",{className:"text-9xl grayscale",children:"üìÑ"})}),e.jsxs("h2",{className:"text-xl font-black mb-6 text-slate-900 flex items-center gap-3 relative z-10",children:[e.jsx("span",{className:"w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-sm font-bold",children:"1"}),"Domande (CSV)"]}),e.jsxs("div",{className:"space-y-5 relative z-10",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2",children:"Concorso Destinazione"}),e.jsxs("select",{className:"w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm text-slate-900 outline-none focus:ring-2 focus:ring-[#00B1FF]/20 focus:border-[#00B1FF] transition-all font-medium",value:m,onChange:t=>Q(t.target.value),children:[e.jsx("option",{value:"",children:"Seleziona un concorso..."}),v.map(t=>e.jsx("option",{value:t.id,children:t.title},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2",children:"Materia Default (Fallback)"}),e.jsxs("select",{className:"w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm text-slate-900 outline-none focus:ring-2 focus:ring-[#00B1FF]/20 focus:border-[#00B1FF] transition-all font-medium disabled:opacity-50 disabled:cursor-not-allowed",value:y,onChange:t=>k(t.target.value),disabled:!m,children:[e.jsx("option",{value:"",children:"-- Seleziona Materia --"}),G.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("p",{className:"text-[10px] text-slate-400 mt-1.5 leading-snug",children:["Usata se la colonna ",e.jsx("code",{className:"bg-slate-100 px-1 py-0.5 rounded text-slate-600 font-mono",children:"subject_id"})," nel CSV √® vuota."]})]}),e.jsxs("div",{className:"pt-2",children:[e.jsxs("label",{className:"flex justify-between items-center text-xs font-bold text-slate-400 uppercase tracking-wider mb-2",children:["File CSV",e.jsxs("button",{onClick:W,className:"text-[#00B1FF] hover:text-[#0091D5] underline transition-colors font-medium normal-case flex items-center gap-1",children:[e.jsx("span",{children:"‚¨áÔ∏è"})," Scarica Template"]})]}),e.jsxs("label",{className:"flex flex-col items-center justify-center w-full h-32 border-2 border-slate-200 border-dashed rounded-2xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-all group hover:border-slate-300",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center pt-5 pb-6",children:[e.jsx("p",{className:"mb-2 text-2xl group-hover:scale-110 transition-transform",children:"üìÇ"}),e.jsxs("p",{className:"mb-1 text-sm text-slate-500 font-medium",children:[e.jsx("span",{className:"font-bold text-slate-700",children:"Clicca per caricare"})," o trascina"]}),e.jsx("p",{className:"text-xs text-slate-400",children:"CSV delimitato da virgola o punto e virgola"})]}),e.jsx("input",{type:"file",accept:".csv",className:"hidden",onChange:O})]}),u&&e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs font-bold text-emerald-600 bg-emerald-50 px-3 py-2 rounded-lg border border-emerald-200",children:[e.jsx("span",{children:"‚úÖ File selezionato:"}),e.jsx("span",{className:"text-emerald-700",children:u.name})]})]}),f&&e.jsxs("div",{className:`text-xs p-3 rounded-xl border font-medium flex items-start gap-2 ${f.type==="error"?"bg-rose-50 border-rose-200 text-rose-600":"bg-emerald-50 border-emerald-200 text-emerald-600"}`,children:[e.jsx("span",{children:f.type==="error"?"‚ö†Ô∏è":"üéâ"}),f.text]}),z.length>0&&e.jsxs("div",{className:"bg-slate-50 p-4 rounded-xl border border-slate-200 overflow-hidden",children:[e.jsx("p",{className:"font-bold text-xs text-slate-400 uppercase tracking-wider mb-3",children:"Anteprima (Prime 5 righe)"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left text-xs bg-white rounded-lg overflow-hidden shadow-sm border border-slate-100",children:[e.jsx("thead",{className:"bg-slate-50 text-slate-400 font-bold border-b border-slate-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2",children:"Domanda"}),e.jsx("th",{className:"p-2 w-16 text-center text-emerald-600",children:"Risp"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100",children:z.map((t,a)=>e.jsxs("tr",{className:"group hover:bg-slate-50 transition-colors",children:[e.jsx("td",{className:"p-2 truncate max-w-[150px] text-slate-700 font-medium",children:t.question_text}),e.jsx("td",{className:"p-2 font-mono text-center font-bold text-emerald-600 bg-emerald-50",children:t.correct_option})]},a))})]})})]}),e.jsx("button",{onClick:H,disabled:I||!u||!m,className:"w-full py-4 bg-emerald-500 text-white text-sm font-black rounded-xl hover:bg-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-emerald-500/20 hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2",children:I?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin text-lg",children:"‚è≥"})," Importazione in corso..."]}):"üöÄ  Esegui Importazione CSV"})]})]}),e.jsxs("div",{className:"bg-white border border-slate-200/50 rounded-[20px] p-8 shadow-[0_4px_16px_rgba(0,0,0,0.04)] relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 right-0 p-4 opacity-5",children:e.jsx("span",{className:"text-9xl grayscale",children:"üñºÔ∏è"})}),e.jsxs("h2",{className:"text-xl font-black mb-6 text-slate-900 flex items-center gap-3 relative z-10",children:[e.jsx("span",{className:"w-8 h-8 rounded-full bg-sky-100 text-sky-600 flex items-center justify-center text-sm font-bold",children:"2"}),"Immagini (Bulk)"]}),e.jsxs("div",{className:"space-y-5 relative z-10",children:[e.jsx("div",{className:"bg-sky-50 p-4 rounded-xl border border-sky-200",children:e.jsxs("p",{className:"text-xs text-sky-700 font-medium leading-relaxed",children:["Carica tutte le immagini citate nel CSV (colonna ",e.jsx("code",{className:"bg-white px-1 py-0.5 rounded border border-sky-200 font-mono text-sky-600",children:"image_name"}),'). I nomi file verranno normalizzati automaticamente (es. "Fig 1.jpg" ‚Üí "fig_1.jpg").']})}),e.jsxs("label",{className:"flex flex-col items-center justify-center w-full h-32 border-2 border-slate-200 border-dashed rounded-2xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-all group hover:border-slate-300",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center pt-5 pb-6",children:[e.jsx("p",{className:"mb-2 text-2xl group-hover:scale-110 transition-transform",children:"üåá"}),e.jsxs("p",{className:"mb-1 text-sm text-slate-500 font-medium",children:[e.jsx("span",{className:"font-bold text-slate-700",children:"Seleziona immagini"})," (multiplo)"]}),e.jsx("p",{className:"text-xs text-slate-400",children:"JPG, PNG supportati"})]}),e.jsx("input",{type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:t=>J(t.target.files)})]}),x&&x.length>0&&e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs font-bold text-sky-600 bg-sky-50 px-3 py-2 rounded-lg border border-sky-200",children:[e.jsx("span",{children:"üì∏ Selezionate:"}),e.jsxs("span",{className:"text-sky-700",children:[x.length," immagini"]})]}),j&&e.jsxs("div",{className:`text-xs p-3 rounded-xl border font-medium flex items-start gap-2 ${j.type==="error"?"bg-rose-50 border-rose-200 text-rose-600":"bg-emerald-50 border-emerald-200 text-emerald-600"}`,children:[e.jsx("span",{children:j.type==="error"?"‚ö†Ô∏è":"‚úÖ"}),j.text]}),e.jsx("button",{onClick:K,disabled:E||!x,className:"w-full py-4 bg-sky-500 text-white text-sm font-black rounded-xl hover:bg-sky-600 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-sky-500/20 hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2",children:E?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin text-lg",children:"‚è≥"})," Caricamento..."]}):"‚òÅÔ∏è  Carica Immagini su Cloud"})]})]})]})]})})}export{me as default};
