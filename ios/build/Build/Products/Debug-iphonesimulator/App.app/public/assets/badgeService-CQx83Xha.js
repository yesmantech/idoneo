import{s as r,b as g}from"./index-BBBGEo7o.js";const f={async getUserBadges(a){const{data:e,error:t}=await r.from("user_badges").select("badge_id").eq("user_id",a);return t?(console.error("Error fetching user badges:",t),[]):e.map(o=>o.badge_id)},async awardBadge(a,e){try{const{error:t}=await r.from("user_badges").upsert({user_id:a,badge_id:e},{onConflict:"user_id, badge_id"});t&&t.code!=="42501"?console.warn(`Badge award skipped for ${e}:`,t.message):t||g.track("badge_earned",{badge_id:e})}catch{}},async checkAndAwardBadges(a){try{console.log("Badge Check: Starting for user",a);const{data:e,error:t}=await r.from("profiles").select("total_xp, referral_count, current_streak").eq("id",a).single();if(t){console.error("Badge Check: Profile Fetch Error",t);return}if(!e){console.warn("Badge Check: No profile found for",a);return}console.log("Badge Check: Data fetched",e),console.log("Badge Check: Total XP:",e.total_xp),console.log("Badge Check: Current Streak:",e.current_streak),(e.total_xp||0)>=1e3&&(console.log("Badge Check: Awarding veterano"),await this.awardBadge(a,"veterano")),(e.referral_count||0)>=5&&(console.log("Badge Check: Awarding social"),await this.awardBadge(a,"social")),(e.current_streak||0)>=7&&(console.log("Badge Check: Awarding costanza"),await this.awardBadge(a,"costanza")),(e.current_streak||0)>=14&&(console.log("Badge Check: Awarding maratona"),await this.awardBadge(a,"maratona")),(e.current_streak||0)>=30&&(console.log("Badge Check: Awarding inarrestabile"),await this.awardBadge(a,"inarrestabile")),(e.current_streak||0)>=60&&(console.log("Badge Check: Awarding diamante"),await this.awardBadge(a,"diamante")),(e.current_streak||0)>=100&&(console.log("Badge Check: Awarding immortale"),await this.awardBadge(a,"immortale"));const{data:o}=await r.from("quiz_attempts").select("quiz_id").eq("user_id",a);new Set(o==null?void 0:o.map(c=>c.quiz_id)).size>=5&&(console.log("Badge Check: Awarding hub_master"),await this.awardBadge(a,"hub_master"));const{data:i}=await r.from("quiz_attempts").select("created_at").eq("user_id",a);((i==null?void 0:i.filter(c=>{const n=new Date(c.created_at).getHours();return n>=1&&n<5}).length)||0)>=5&&(console.log("Badge Check: Awarding nottambulo"),await this.awardBadge(a,"nottambulo"));const{data:d}=await r.from("quiz_attempts").select("id").eq("user_id",a).filter("correct","eq","total_questions").gt("total_questions",9).limit(1).maybeSingle();d&&(console.log("Badge Check: Awarding secchione"),await this.awardBadge(a,"secchione"));const{count:s}=await r.from("quiz_attempts").select("*",{count:"exact",head:!0}).eq("user_id",a);s&&s>0&&(console.log("Badge Check: Awarding primo_passo"),await this.awardBadge(a,"primo_passo"))}catch(e){console.error("Error checking badges:",e)}}};export{f as b};
