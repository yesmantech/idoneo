import{s as b}from"./index-BBBGEo7o.js";function _(s,i=7){const n=new Date,c=new Date(n.getTime()-i*24*60*60*1e3),g=new Date(c.getTime()-i*24*60*60*1e3),r=s.filter(d=>new Date(d.created_at)>=c),e=s.filter(d=>{const l=new Date(d.created_at);return l>=g&&l<c}),o=d=>d.length>0?d.reduce((l,m)=>l+(m.score||0),0)/d.length:0,t=d=>{const l=d.filter(m=>m.total_questions>0);return l.length===0?0:l.reduce((m,w)=>m+w.correct/w.total_questions*100,0)/l.length},a=o(r),u=o(e),f=u>0?(a-u)/u*100:0,p=t(r),y=t(e),v=y>0?(p-y)/y*100:0;return{scoreTrend:{currentValue:a,previousValue:u,delta:f,direction:f>2?"up":f<-2?"down":"stable",label:`${f>=0?"+":""}${f.toFixed(0)}% vs last ${i}d`},accuracyTrend:{currentValue:p,previousValue:y,delta:v,direction:v>2?"up":v<-2?"down":"stable",label:`${v>=0?"+":""}${v.toFixed(0)}% vs last ${i}d`}}}function h(s){const i={},c=[...s].sort((r,e)=>new Date(e.created_at).getTime()-new Date(r.created_at).getTime()).slice(0,3),g=new Set(c.map(r=>r.id));return s.forEach(r=>{Array.isArray(r.answers)&&r.answers.forEach(e=>{const o=e.subjectName||"Generale",t=e.subjectId||o;i[t]||(i[t]={correct:0,total:0,recentCorrect:0,recentTotal:0}),i[t].total++,e.isCorrect&&i[t].correct++,g.has(r.id)&&(i[t].recentTotal++,e.isCorrect&&i[t].recentCorrect++)})}),Object.entries(i).map(([r,e])=>{var v,d;const o=e.correct/e.total*100,a=(e.recentTotal>0?e.recentCorrect/e.recentTotal*100:o)-o,u=a>5?"improving":a<-5?"declining":"stable",f=o>=70?"good":o>=50?"warning":"critical",p=s.find(l=>Array.isArray(l.answers)&&l.answers.some(m=>m.subjectId===r||m.subjectName===r)),y=((d=(v=p==null?void 0:p.answers)==null?void 0:v.find(l=>l.subjectId===r||l.subjectName===r))==null?void 0:d.subjectName)||r;return{subjectId:r,subjectName:y,accuracy:o,totalQuestions:e.total,correctAnswers:e.correct,trend:u,status:f}}).sort((r,e)=>r.accuracy-e.accuracy)}function j(s,i,n){const c=[],g=s.reduce((t,a)=>Array.isArray(a.answers)?t+a.answers.filter(u=>!u.isCorrect&&!u.isSkipped).length:t,0);g>5&&c.push({id:"review-wrong",type:"review",title:`Ripassa ${g} errori`,description:"Rivedi le domande sbagliate per capire dove migliorare.",priority:1,actionUrl:`/quiz/${n}/review`,actionLabel:"Inizia ripasso"});const r=i.find(t=>t.status==="critical");r&&c.push({id:"practice-weak",type:"practice",title:`Allenati su ${r.subjectName}`,description:`Accuratezza solo ${r.accuracy.toFixed(0)}%. Questa materia richiede più pratica.`,priority:2,actionUrl:`/quiz/${n}/practice?subject=${r.subjectId}`,actionLabel:"Fai esercizi"});const e=s[0],o=e?Math.floor((Date.now()-new Date(e.created_at).getTime())/(1e3*60*60*24)):999;return(o>=2||s.length<3)&&c.push({id:"do-simulation",type:"simulation",title:"Fai una simulazione completa",description:o>=2?`Sono passati ${o} giorni dall'ultimo test.`:"Fai più simulazioni per prepararti al meglio.",priority:3,actionUrl:`/quiz/${n}/official`,actionLabel:"Inizia simulazione"}),s.length>=3&&c.push({id:"set-goal",type:"goal",title:"Imposta un obiettivo",description:"Definisci un traguardo per rimanere motivato.",priority:4,actionLabel:"Imposta obiettivo"}),c.sort((t,a)=>t.priority-a.priority).slice(0,3)}function A(s,i,n,c){if(c&&c.score!==void 0){const a=c.score;let u="low",f="Da migliorare",p="semantic-error";return a>=85?(u="high",f="Pronto",p="semantic-success"):a>=50&&(u="medium",f="A buon punto",p="brand-orange"),{level:u,label:f,color:p,score:a,breakdown:{accuracy:c.accuracy_weighted||0,volume:(c.volume_factor||0)*100,coverage:(c.coverage_score||0)*100,reliability:(c.reliability||0)*100,recency:(c.recency_score||0)*100}}}const g=s>=90?2:s>=70?1:0,r=i>=90?2:i>=70?1:0,e=n>=10?2:n>=5?1:0,o=g+r+e,t=Math.min(o/6*100,100);return o>=5?{level:"high",label:"Pronto",color:"semantic-success",score:t,breakdown:{accuracy:i,volume:n/10*100,coverage:0,reliability:0,recency:100}}:o>=3?{level:"medium",label:"In progresso",color:"brand-orange",score:t,breakdown:{accuracy:i,volume:n/10*100,coverage:0,reliability:0,recency:100}}:{level:"low",label:"Da migliorare",color:"semantic-error",score:t,breakdown:{accuracy:i,volume:n/10*100,coverage:0,reliability:0,recency:100}}}async function $(s,i,n){const{data:c,error:g}=await b.from("test_goals").select("*").eq("user_id",s).eq("quiz_id",i).eq("status","active");if(g||!(c!=null&&c.length))return;const r=n.total>0?n.correct/n.total*100:0;for(const e of c){let o=e.current_value,t=!1;e.goal_type==="score"?(n.score>(e.current_value||0)&&(o=n.score),n.score>=e.target_value&&(t=!0)):e.goal_type==="accuracy"?(r>(e.current_value||0)&&(o=r),r>=e.target_value&&(t=!0)):e.goal_type==="attempts"&&(o=(e.current_value||0)+1,o>=e.target_value&&(t=!0)),(o!==e.current_value||t)&&await b.from("test_goals").update({current_value:o,status:t?"achieved":"active",updated_at:new Date().toISOString()}).eq("id",e.id)}}const T={calculateTrends:_,analyzeSubjectPerformance:h,generateRecommendations:j,calculateReadinessLevel:A,updateGoals:$};export{_ as a,h as b,A as c,j as g,T as s};
