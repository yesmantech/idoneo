import{j as e,A as re,m as se}from"./framer-BdaCTGm4.js";import{b as ae,u as ne,r as g}from"./router-ClfHAwMg.js";import{s as N}from"./index-BBBGEo7o.js";import{l as oe,k as ie,N as H,i as U,ag as le}from"./icons-ByDj-hsa.js";import"./react-vendor-B--z-fyW.js";import"./supabase-CIvuJI4W.js";async function ce(r,c,n,s){const f=n.filter(l=>l.count>0).map(l=>l.subjectId);if(f.length===0)return[];const{data:h}=await N.from("questions").select("id, subject_id").in("subject_id",f).eq("is_archived",!1);if(!h||h.length===0)return[];const b=new Map;for(const l of h){const o=l.subject_id;b.has(o)||b.set(o,[]),b.get(o).push(l.id)}let i=null;r&&s!=="random"&&s!=="hardest"&&(i=await de(r,c));const w=[];for(const l of n){if(l.count<=0)continue;const o=b.get(l.subjectId)||[];if(o.length===0)continue;let d=[];if(s==="random")d=k(o).slice(0,l.count);else if(s==="unseen"&&i){const p=o.filter(v=>!i.seen.has(v));d=$(p,o,l.count)}else if(s==="weak"&&i){const p=O(i.wrong,o);d=$(p,o,l.count)}else if(s==="unanswered"&&i){const p=O(i.skipped,o);d=$(p,o,l.count)}else if(s==="hardest"){const{data:p}=await N.from("question_stats").select("question_id").in("question_id",o).order("difficulty_index",{ascending:!1}).limit(l.count);if(p&&p.length>0){const v=p.map(j=>j.question_id);d=$(v,o,l.count)}else d=k(o).slice(0,l.count)}else s==="smart_mix"&&i&&(d=ue(o,i,l.count));d.length===0&&s!=="random"&&(d=k(o).slice(0,l.count)),d=[...new Set(d)],w.push(...d.map(p=>({questionId:p,subjectId:l.subjectId})))}return w}async function de(r,c){const{data:n}=await N.from("quiz_attempts").select("answers").eq("user_id",r).eq("quiz_id",c),s=new Set,f=new Map,h=new Map;return n==null||n.forEach(b=>{Array.isArray(b.answers)&&b.answers.forEach(i=>{i.questionId&&(s.add(i.questionId),i.isCorrect===!1&&i.isSkipped!==!0&&f.set(i.questionId,(f.get(i.questionId)||0)+1),(i.isSkipped===!0||i.selectedOption===null)&&h.set(i.questionId,(h.get(i.questionId)||0)+1))})}),{seen:s,wrong:f,skipped:h}}function O(r,c){const n=new Set(c);return Array.from(r.entries()).filter(([s])=>n.has(s)).sort((s,f)=>f[1]-s[1]).map(([s])=>s)}function $(r,c,n){if(r.length>=n)return k(r).slice(0,n);const s=new Set(r),f=c.filter(h=>!s.has(h));return[...r,...k(f).slice(0,n-r.length)]}function ue(r,c,n){const s=Math.round(n*.4),f=Math.round(n*.3),h=n-s-f,b=O(c.wrong,r),i=r.filter(j=>!c.seen.has(j)),w=k(b).slice(0,s),l=k(i.filter(j=>!w.includes(j))).slice(0,f),o=new Set([...w,...l]),d=r.filter(j=>!o.has(j)),p=k(d).slice(0,h);let v=[...w,...l,...p];if(v.length<n){const j=new Set(v),P=r.filter(A=>!j.has(A)),M=k(P).slice(0,n-v.length);v=[...v,...M]}return v}function k(r){const c=[...r];for(let n=c.length-1;n>0;n--){const s=Math.floor(Math.random()*(n+1));[c[n],c[s]]=[c[s],c[n]]}return c}function D(r){return r?r.replace(/[.,:;()\[\]]/g,"").trim().toLowerCase():null}function xe(r){return r?r.correct_option?D(r.correct_option):r.correct_answer?D(r.correct_answer):r.answer?D(r.answer):null:null}function je(){const{contestSlug:r}=ae(),c=ne(),[n,s]=g.useState(!0),[f,h]=g.useState(!1),[b,i]=g.useState(null),[w,l]=g.useState([]),[o,d]=g.useState({}),[p,v]=g.useState("random"),[j,P]=g.useState(0),[M,A]=g.useState(30),[T,R]=g.useState(0),[S,G]=g.useState(!1),[_,B]=g.useState({correct:1,wrong:0,blank:0});g.useEffect(()=>{(async()=>{const{data:a}=await N.from("quizzes").select("id").eq("slug",r).single();if(!a)return;i(a.id);const{data:u}=await N.from("subjects").select("id, name").eq("quiz_id",a.id).eq("is_archived",!1);if(u){const x=await Promise.all(u.map(async y=>{const{count:q}=await N.from("questions").select("*",{count:"exact",head:!0}).eq("subject_id",y.id).eq("is_archived",!1);return{...y,question_count:q||0}}));x.sort((y,q)=>y.name.localeCompare(q.name)),l(x)}s(!1)})()},[r]);const J=(t,a)=>{d(u=>{const x={...u};return x[t]!==void 0?delete x[t]:x[t]=Math.min(20,a),x})},E=(t,a,u)=>{const x=Math.max(1,Math.min(a,u));d(y=>({...y,[t]:x}))},V=()=>{if(Object.keys(o).length===w.length)d({});else{const t={};w.forEach(a=>{t[a.id]=Math.min(20,a.question_count)}),d(t)}},z=g.useMemo(()=>Object.values(o).reduce((t,a)=>t+a,0),[o]),Z=async()=>{var t,a;if(b){if(z<=0){alert("Seleziona almeno una domanda");return}h(!0);try{const u=Object.entries(o).map(([m,C])=>({subjectId:m,count:C})),x=await ce(((t=(await N.auth.getUser()).data.user)==null?void 0:t.id)||null,b,u,p);if(console.log("[CustomQuiz] configs:",u),console.log("[CustomQuiz] selection result:",x.length),!x||x.length===0)throw new Error(`Nessuna domanda trovata. Configs: ${JSON.stringify(u)}, Mode: ${p}`);const y=500,q=x.map(m=>m.questionId);let I=[];for(let m=0;m<q.length;m+=y){const C=q.slice(m,m+y),{data:F,error:Q}=await N.from("questions").select("*, subject:subjects(name)").in("id",C);if(Q)throw console.error("[CustomQuiz] Batch fetch error:",Q),new Error(`Errore nel recupero domande: ${Q.message}`);F&&(I=[...I,...F])}if(console.log("[CustomQuiz] fullQuestions fetched:",I.length),I.length===0)throw new Error("Nessuna domanda trovata con questi criteri.");const L=I.sort(()=>Math.random()-.5).map(m=>{var C;return{questionId:m.id,text:m.text,subjectId:m.subject_id,subjectName:((C=m.subject)==null?void 0:C.name)||"Materia",selectedOption:null,correctOption:xe(m),isCorrect:!1,isSkipped:!1,options:{a:m.option_a,b:m.option_b,c:m.option_c,d:m.option_d}}}),X=S?0:j*3600+M*60+T,{data:Y,error:W}=await N.from("quiz_attempts").insert({quiz_id:b,user_id:(a=(await N.auth.getUser()).data.user)==null?void 0:a.id,score:0,answers:L,total_questions:L.length,correct:0,wrong:0,blank:0,started_at:new Date().toISOString(),mode:"custom"}).select().single();if(W)throw W;const ee=`correct=${_.correct}&wrong=${_.wrong}&blank=${_.blank}`,te=S?"time=0":`time=${Math.ceil(X/60)}`;c(`/quiz/run/${Y.id}?mode=custom&${te}&${ee}`)}catch(u){console.error(u),alert("Errore: "+u.message)}finally{h(!1)}}},K={random:"Domande pescate a caso tra tutte quelle disponibili nelle materie selezionate.",weak:"Priorità alle domande che hai sbagliato in passato.",unseen:"Priorità alle domande mai affrontate prima.",unanswered:"Priorità alle domande saltate in passato.",hardest:"Le domande statisticamente più difficili.",smart_mix:"Mix bilanciato di errori, nuove e casuali."};return n?e.jsx("div",{className:"min-h-screen bg-[var(--background)] flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"})}):e.jsxs("div",{className:"min-h-screen bg-[var(--background)] pb-32",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-[var(--background)]/95 backdrop-blur border-b border-[var(--card-border)]",children:e.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[e.jsx("button",{onClick:()=>c(-1),className:"w-10 h-10 rounded-full bg-[var(--card)] flex items-center justify-center hover:opacity-80 active:scale-95 transition-all text-[var(--foreground)]",children:e.jsx(oe,{className:"w-5 h-5"})}),e.jsx("h1",{className:"text-[17px] font-semibold text-[var(--foreground)]",children:"Prova Personalizzata"}),e.jsx("div",{className:"w-10"})]})}),e.jsxs("div",{className:"px-5 max-w-lg mx-auto pt-6 space-y-6",children:[e.jsxs("section",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h2",{className:"text-[11px] font-semibold text-[var(--foreground)] opacity-40 uppercase tracking-wider",children:"Seleziona Materie"}),e.jsx("button",{onClick:V,className:"text-[13px] font-semibold text-purple-500 hover:text-purple-400 transition-colors",children:Object.keys(o).length===w.length?"Deseleziona tutte":"Seleziona tutte"})]}),e.jsx("div",{className:"bg-[var(--card)] rounded-2xl overflow-hidden border border-[var(--card-border)]",style:{boxShadow:"0 1px 3px rgba(0,0,0,0.06)"},children:w.map((t,a)=>{const u=o[t.id],x=u!==void 0;return e.jsx("div",{className:`${a!==0?"border-t border-[var(--card-border)]":""}`,children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-3 cursor-pointer",onClick:()=>J(t.id,t.question_count),children:[e.jsx("div",{className:`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0 ${x?"border-purple-500 bg-purple-500":"border-slate-300 dark:border-slate-600"}`,children:x&&e.jsx(ie,{className:"w-3.5 h-3.5 text-white",strokeWidth:3})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:`text-[15px] font-medium ${x?"text-[var(--foreground)]":"text-[var(--foreground)] opacity-50"}`,children:t.name}),e.jsxs("p",{className:"text-[12px] text-[var(--foreground)] opacity-40",children:[t.question_count," disponibili"]})]})]}),x&&e.jsxs("div",{className:"mt-3 ml-9 flex items-center gap-3",children:[e.jsx("input",{type:"range",min:1,max:t.question_count,value:u,onChange:y=>E(t.id,parseInt(y.target.value),t.question_count),className:"flex-1 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full appearance-none cursor-pointer accent-purple-500"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>E(t.id,u-1,t.question_count),className:"w-7 h-7 rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center hover:opacity-80 active:scale-95 transition-all",children:e.jsx(H,{className:"w-3.5 h-3.5 text-[var(--foreground)] opacity-60"})}),e.jsx("span",{className:"w-10 text-center font-bold text-purple-600 dark:text-purple-400 text-[15px]",children:u}),e.jsx("button",{onClick:()=>E(t.id,u+1,t.question_count),className:"w-7 h-7 rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center hover:opacity-80 active:scale-95 transition-all",children:e.jsx(U,{className:"w-3.5 h-3.5 text-[var(--foreground)] opacity-60"})})]})]})]})},t.id)})})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-[11px] font-semibold text-[var(--foreground)] opacity-40 uppercase tracking-wider mb-3",children:"Tipo di Domande"}),e.jsx("div",{className:"bg-[var(--card)] rounded-2xl p-4 relative border border-[var(--card-border)]",style:{boxShadow:"0 1px 3px rgba(0,0,0,0.06)"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("select",{value:p,onChange:t=>v(t.target.value),className:"w-full appearance-none bg-transparent text-[15px] font-semibold text-[var(--foreground)] outline-none cursor-pointer pr-8",children:[e.jsx("option",{value:"random",children:"Casuali"}),e.jsx("option",{value:"weak",children:"Sbagliate spesso"}),e.jsx("option",{value:"unanswered",children:"Non risposte"}),e.jsx("option",{value:"unseen",children:"Mai viste"}),e.jsx("option",{value:"hardest",children:"Più difficili (Globali)"}),e.jsx("option",{value:"smart_mix",children:"Mix Intelligente"})]}),e.jsx(le,{className:"w-5 h-5 text-[var(--foreground)] opacity-40 absolute right-4 pointer-events-none"})]})}),e.jsx("p",{className:"text-[12px] text-[var(--foreground)] opacity-40 mt-2 px-1",children:K[p]})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-[11px] font-semibold text-[var(--foreground)] opacity-40 uppercase tracking-wider mb-3",children:"Numero di Quiz Selezionati"}),e.jsxs("div",{className:"bg-[var(--card)] rounded-2xl p-4 flex items-center justify-between border border-[var(--card-border)]",style:{boxShadow:"0 1px 3px rgba(0,0,0,0.06)"},children:[e.jsx("span",{className:"text-[14px] font-medium text-[var(--foreground)] opacity-60",children:"Totale"}),e.jsx("span",{className:"text-[28px] font-bold text-purple-500",children:z})]})]}),e.jsxs("section",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h2",{className:"text-[11px] font-semibold text-[var(--foreground)] opacity-40 uppercase tracking-wider",children:"Durata Prova"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-[12px] font-semibold ${S?"text-purple-500":"text-[var(--foreground)] opacity-40"}`,children:"Senza limite"}),e.jsx("button",{onClick:()=>G(!S),className:`w-11 h-6 rounded-full p-0.5 transition-colors ${S?"bg-purple-500":"bg-slate-300 dark:bg-slate-600"}`,children:e.jsx("div",{className:`w-5 h-5 bg-white rounded-full shadow transition-transform ${S?"translate-x-5":"translate-x-0"}`})})]})]}),e.jsxs("div",{className:`bg-[var(--card)] rounded-2xl p-4 grid grid-cols-3 gap-3 transition-opacity border border-[var(--card-border)] ${S?"opacity-40 pointer-events-none":""}`,style:{boxShadow:"0 1px 3px rgba(0,0,0,0.06)"},children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-[10px] font-semibold text-[var(--foreground)] opacity-40 uppercase mb-2",children:"Ore"}),e.jsx("select",{value:j,onChange:t=>P(parseInt(t.target.value)),className:"w-full py-2 px-3 bg-slate-100 dark:bg-slate-800 rounded-xl text-[18px] font-bold text-[var(--foreground)] text-center outline-none appearance-none cursor-pointer",children:[0,1,2,3,4].map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-[10px] font-semibold text-[var(--foreground)] opacity-40 uppercase mb-2",children:"Minuti"}),e.jsx("select",{value:M,onChange:t=>A(parseInt(t.target.value)),className:"w-full py-2 px-3 bg-slate-100 dark:bg-slate-800 rounded-xl text-[18px] font-bold text-[var(--foreground)] text-center outline-none appearance-none cursor-pointer",children:Array.from({length:60},(t,a)=>a).map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-[10px] font-semibold text-[var(--foreground)] opacity-40 uppercase mb-2",children:"Secondi"}),e.jsx("select",{value:T,onChange:t=>R(parseInt(t.target.value)),className:"w-full py-2 px-3 bg-slate-100 dark:bg-slate-800 rounded-xl text-[18px] font-bold text-[var(--foreground)] text-center outline-none appearance-none cursor-pointer",children:Array.from({length:60},(t,a)=>a).map(t=>e.jsx("option",{value:t,children:t},t))})]})]})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-[11px] font-semibold text-[var(--foreground)] opacity-40 uppercase tracking-wider mb-3 px-1",children:"Punteggio"}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[{label:"Errate",key:"wrong",color:"red",value:_.wrong},{label:"Saltate",key:"blank",color:"amber",value:_.blank},{label:"Corrette",key:"correct",color:"emerald",value:_.correct}].map(t=>e.jsxs("div",{className:"bg-[var(--card)] rounded-[24px] p-3 flex flex-col items-center gap-3 active:scale-[0.98] transition-transform border border-[var(--card-border)]",style:{boxShadow:"0 4px 12px rgba(0,0,0,0.03), 0 1px 2px rgba(0,0,0,0.04)"},children:[e.jsx("span",{className:`text-[10px] font-bold uppercase tracking-wider ${t.color==="red"?"text-red-500":t.color==="amber"?"text-amber-500":"text-emerald-500"}`,children:t.label}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("button",{onClick:()=>B(a=>({...a,[t.key]:parseFloat((a[t.key]-.1).toFixed(1))})),className:`w-7 h-7 rounded-lg flex items-center justify-center transition-all ${t.color==="red"?"bg-red-50 dark:bg-red-500/10 text-red-500 hover:opacity-80":t.color==="amber"?"bg-amber-50 dark:bg-amber-500/10 text-amber-500 hover:opacity-80":"bg-emerald-50 dark:bg-emerald-500/10 text-emerald-500 hover:opacity-80"}`,children:e.jsx(H,{className:"w-3.5 h-3.5",strokeWidth:3})}),e.jsx("div",{className:"w-8 text-center relative h-5",children:e.jsx(re,{mode:"wait",children:e.jsx(se.span,{initial:{y:5,opacity:0},animate:{y:0,opacity:1},exit:{y:-5,opacity:0},transition:{duration:.15},className:"absolute inset-0 flex items-center justify-center text-[15px] font-bold text-[var(--foreground)]",children:t.key==="correct"?`+${t.value}`:t.value},t.value)})}),e.jsx("button",{onClick:()=>B(a=>({...a,[t.key]:parseFloat((a[t.key]+.1).toFixed(1))})),className:`w-7 h-7 rounded-lg flex items-center justify-center transition-all ${t.color==="red"?"bg-red-50 dark:bg-red-500/10 text-red-500 hover:opacity-80":t.color==="amber"?"bg-amber-50 dark:bg-amber-500/10 text-amber-500 hover:opacity-80":"bg-emerald-50 dark:bg-emerald-500/10 text-emerald-500 hover:opacity-80"}`,children:e.jsx(U,{className:"w-3.5 h-3.5",strokeWidth:3})})]})]},t.key))})]})]}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-[var(--background)]/95 backdrop-blur-md border-t border-[var(--card-border)] px-5 py-4 pb-safe z-50",children:e.jsx("div",{className:"max-w-lg mx-auto",children:e.jsx("button",{onClick:Z,disabled:f||z===0,className:`w-full py-4 rounded-2xl font-bold text-[16px] transition-all active:scale-[0.98] ${z>0?"bg-purple-500 text-white shadow-lg shadow-purple-500/25 hover:bg-purple-600":"bg-slate-100 dark:bg-slate-800 text-slate-400 cursor-not-allowed"}`,children:f?"Creazione in corso...":`Avvia Prova (${z})`})})})]})}export{je as default};
