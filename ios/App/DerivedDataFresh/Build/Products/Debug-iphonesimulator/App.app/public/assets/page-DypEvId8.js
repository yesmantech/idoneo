import{j as e,A as F,m as N}from"./framer-BdaCTGm4.js";import{u as C,r as m,R as $}from"./router-ClfHAwMg.js";import{l as D,u as q,s as b,a as L}from"./index-DBMi1b3R.js";import{T as I}from"./TierSLoader-BJdwavnO.js";import{as as M,r as T,m as S,Z as y,at as _,X as w,j as U,ab as G,ac as H,ad as O,G as X,ae as R,e as Q,a as V,w as Z,au as W,Q as E,av as J,q as K,am as Y,aw as ee,F as ae,ax as te,b as se,ay as re,x as A,h as le,k as P,az as ie,aa as ne}from"./icons-DIoLbN6D.js";import{b as z}from"./badgeService-Cz5uGXmX.js";import{u as oe,R as ce}from"./ReferralModal-ox2ovO4P.js";import{x as de}from"./xpService-kx5CAJsB.js";import"./react-vendor-B--z-fyW.js";import"./supabase-CIvuJI4W.js";function me({user:a,profile:s,xp:r=0}){const c=C(),[l,d]=m.useState(null),o=(s==null?void 0:s.nickname)||"Utente",i=s==null?void 0:s.avatar_url,n={xp:{title:"XP Totali",description:"Punti esperienza accumulati rispondendo alle domande. PiÃ¹ XP hai, piÃ¹ sali nelle classifiche globali!",icon:e.jsx(S,{className:"w-5 h-5 text-amber-500",fill:"currentColor"}),color:"bg-amber-50 text-amber-500"},score:{title:"Energia",description:"L'energia necessaria per affrontare i quiz. Come utente Premium, la tua energia Ã¨ infinita!",icon:e.jsx(y,{className:"w-5 h-5 text-emerald-500",fill:"currentColor"}),color:"bg-emerald-50 text-emerald-500"},gems:{title:"Gemme",description:"Valuta speciale per sbloccare contenuti esclusivi, temi e vantaggi extra.",icon:e.jsx(_,{className:"w-5 h-5 text-cyan-500",fill:"currentColor"}),color:"bg-cyan-50 text-cyan-500"}},h=u=>{u.preventDefault(),u.stopPropagation(),navigator.share?navigator.share({title:"Idoneo",text:"Mettiti alla prova con i quiz di Idoneo!",url:window.location.origin}).catch(console.error):alert("Condivisione in arrivo!")};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"w-full bg-[var(--card)] rounded-[32px] shadow-sm border border-[var(--card-border)] overflow-hidden transition-colors duration-300",children:[e.jsxs("div",{className:"relative px-6 pt-6 pb-5 flex flex-col items-center",children:[e.jsx("div",{className:"absolute top-5 left-5",children:e.jsx("button",{onClick:h,className:"w-9 h-9 rounded-full bg-slate-100/80 dark:bg-slate-700/80 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600 transition-all flex items-center justify-center backdrop-blur-sm",children:e.jsx(M,{className:"w-4 h-4"})})}),e.jsx("div",{className:"absolute top-5 right-5",children:e.jsx("button",{onClick:()=>c("/profile/settings"),className:"w-9 h-9 rounded-full bg-slate-100/80 dark:bg-slate-700/80 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600 transition-all flex items-center justify-center backdrop-blur-sm",children:e.jsx(T,{className:"w-4 h-4"})})}),e.jsxs("div",{className:"relative mb-3",children:[e.jsx("div",{className:"w-20 h-20 rounded-[20px] bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-600 shadow-inner relative overflow-hidden ring-[3px] ring-[var(--card)]",children:i?e.jsx("img",{src:i,alt:o,className:"w-full h-full object-cover"}):e.jsx("span",{className:"w-full h-full flex items-center justify-center text-4xl",children:"ðŸ‘¤"})}),e.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 p-0.5 bg-[var(--card)] rounded-full",children:e.jsx("div",{className:"w-3.5 h-3.5 bg-emerald-500 rounded-full ring-2 ring-[var(--card)]"})})]}),e.jsx("h1",{className:"text-xl font-black text-[var(--foreground)] tracking-tight text-center",children:o}),e.jsx("p",{className:"text-[13px] text-[var(--foreground)] opacity-50 font-medium text-center truncate w-full px-8",children:a==null?void 0:a.email})]}),e.jsx("div",{className:"mx-4 mb-4 -mt-1",children:e.jsx("div",{className:"bg-gradient-to-br from-[var(--card)] via-slate-50 dark:via-slate-700 to-[var(--card)] rounded-2xl p-4 border border-[var(--card-border)] shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1 flex flex-col items-center cursor-pointer active:scale-95 transition-transform",onClick:()=>d(n.xp),children:[e.jsx("div",{className:"w-11 h-11 rounded-2xl bg-gradient-to-br from-amber-100 to-amber-50 dark:from-amber-800/50 dark:to-amber-900/30 flex items-center justify-center mb-1.5 ring-1 ring-amber-200/50 dark:ring-amber-700/50",children:e.jsx(S,{className:"w-5 h-5 text-amber-500",fill:"currentColor"})}),e.jsx("span",{className:"text-xl font-black text-[var(--foreground)] tracking-tight",children:r}),e.jsx("span",{className:"text-[9px] font-bold text-amber-500 uppercase tracking-wider",children:"XP"})]}),e.jsx("div",{className:"w-px h-14 bg-gradient-to-b from-transparent via-slate-300 dark:via-slate-600 to-transparent"}),e.jsxs("div",{className:"flex-1 flex flex-col items-center cursor-pointer active:scale-95 transition-transform",onClick:()=>d(n.score),children:[e.jsx("div",{className:"w-11 h-11 rounded-2xl bg-gradient-to-br from-emerald-100 to-emerald-50 dark:from-emerald-800/50 dark:to-emerald-900/30 flex items-center justify-center mb-1.5 ring-1 ring-emerald-200/50 dark:ring-emerald-700/50 relative",children:e.jsx(y,{className:"w-5 h-5 text-emerald-500",fill:"currentColor"})}),e.jsx("span",{className:"text-2xl font-black text-[var(--foreground)] tracking-tight leading-none mb-1",children:"âˆž"}),e.jsx("span",{className:"text-[9px] font-bold text-emerald-500 uppercase tracking-wider",children:"Energia"})]}),e.jsx("div",{className:"w-px h-14 bg-gradient-to-b from-transparent via-slate-300 dark:via-slate-600 to-transparent"}),e.jsxs("div",{className:"flex-1 flex flex-col items-center cursor-pointer active:scale-95 transition-transform",onClick:()=>d(n.gems),children:[e.jsx("div",{className:"w-11 h-11 rounded-2xl bg-gradient-to-br from-cyan-100 to-cyan-50 dark:from-cyan-800/50 dark:to-cyan-900/30 flex items-center justify-center mb-1.5 ring-1 ring-cyan-200/50 dark:ring-cyan-700/50",children:e.jsx(_,{className:"w-5 h-5 text-cyan-500",fill:"currentColor"})}),e.jsx("span",{className:"text-xl font-black text-[var(--foreground)] tracking-tight",children:"0"}),e.jsx("span",{className:"text-[9px] font-bold text-cyan-500 uppercase tracking-wider",children:"Gemme"})]})]})})})]}),e.jsx(F,{children:l&&e.jsxs("div",{className:"fixed inset-0 z-[110] flex items-center justify-center p-6",children:[e.jsx(N.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>d(null),className:"absolute inset-0 bg-slate-900/60 backdrop-blur-md"}),e.jsxs(N.div,{initial:{scale:.9,opacity:0,y:20},animate:{scale:1,opacity:1,y:0},exit:{scale:.9,opacity:0,y:20},className:"relative bg-white dark:bg-slate-900 rounded-[32px] p-8 max-w-xs w-full shadow-2xl text-center overflow-y-auto max-h-[90vh] custom-scrollbar",children:[e.jsx("button",{onClick:()=>d(null),className:"absolute top-4 right-4 p-2 bg-slate-100 rounded-full text-slate-400 hover:text-slate-600 transition-colors",children:e.jsx(w,{className:"w-5 h-5"})}),e.jsx("div",{className:`w-16 h-16 rounded-2xl ${l.color} flex items-center justify-center mx-auto mb-5`,children:$.cloneElement(l.icon,{className:"w-8 h-8"})}),e.jsx("h3",{className:"text-xl font-black text-slate-900 mb-2",children:l.title}),e.jsx("p",{className:"text-slate-500 text-[14px] font-medium leading-relaxed mb-6",children:l.description}),e.jsx("button",{onClick:()=>d(null),className:"w-full py-3.5 bg-slate-900 text-white rounded-2xl font-bold hover:bg-slate-800 transition-colors text-[14px]",children:"Ho capito"})]})]})})]})}function xe({title:a,category:s,progress:r,onClick:c}){const d=(o=>{const i=(o||"").toLowerCase();return i.includes("sanitÃ ")||i.includes("infermier")||i.includes("medic")?G:i.includes("finanza")||i.includes("banca")||i.includes("econom")?H:i.includes("amministra")||i.includes("comun")||i.includes("regione")?O:i.includes("giustizia")||i.includes("magistrat")?X:i.includes("scuola")||i.includes("docent")?R:i.includes("patente")||i.includes("guida")?Q:V})(s||a);return e.jsxs("button",{onClick:c,className:"w-full bg-white dark:bg-[#1e2330] rounded-[24px] shadow-sm border border-slate-100 dark:border-slate-800 p-5 flex items-center gap-5 active:scale-[0.98] transition-all hover:shadow-md text-left group",children:[e.jsx("div",{className:"w-12 h-12 rounded-full flex items-center justify-center bg-[#E0F2FE] dark:bg-[#141820] flex-shrink-0 border border-transparent dark:border-sky-500/20",children:e.jsx(d,{className:"w-5 h-5 text-[#00B1FF] dark:text-sky-400"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex justify-between mb-2",children:e.jsx("h3",{className:"font-bold text-slate-900 dark:text-white truncate pr-2 text-[15px]",children:a})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("div",{className:"flex-1 h-1.5 bg-slate-100 dark:bg-[#2a3040] rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-[#00B1FF] rounded-full",style:{width:`${r}%`}})})})]}),e.jsx(U,{className:"w-5 h-5 text-slate-300 dark:text-slate-500 flex-shrink-0 group-hover:text-[#00B1FF] transition-colors"})]})}function ue({userId:a}){const s=C(),[r,c]=m.useState([]),[l,d]=m.useState(!0);return m.useEffect(()=>{async function o(){try{const i=await D.getUserActiveQuizzes(a);c(i)}catch(i){console.error(i)}finally{d(!1)}}a&&o()},[a]),l?e.jsx("div",{className:"py-8 text-center text-slate-400 animate-pulse",children:"Caricamento corsi..."}):r.length===0?e.jsxs("div",{className:"text-center py-12 bg-white dark:bg-[var(--card)] rounded-[32px] border border-slate-100/60 dark:border-slate-800 mb-8 shadow-sm transition-colors",children:[e.jsx("div",{className:"text-4xl mb-4",children:"â˜ï¸"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 font-medium mb-8",children:"Non hai ancora iniziato nessun corso."}),e.jsx("button",{onClick:()=>s("/"),className:"text-white bg-[#00B1FF] px-8 py-3.5 rounded-2xl font-bold hover:shadow-lg hover:scale-105 transition-all",children:"Inizia ora!"})]}):e.jsxs("div",{className:"space-y-6 mb-8",children:[e.jsx("div",{className:"flex items-center justify-between px-1",children:e.jsx("h3",{className:"text-lg font-bold text-[var(--foreground)]",children:"La tua Dashboard"})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:r.map(o=>e.jsx(xe,{quizId:o.id,title:o.title,category:o.category,progress:o.accuracy||0,onClick:()=>s(`/profile/stats/${o.id}`)},o.id))}),e.jsx("div",{className:"md:hidden",children:e.jsx("button",{onClick:()=>s("/"),className:"w-full py-4 rounded-[32px] border-2 border-dashed border-slate-200 dark:border-slate-700 text-slate-400 dark:text-slate-500 font-bold hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-600 dark:hover:text-slate-300 transition-colors",children:"+ Aggiungi corsi"})})]})}function B(){const{user:a,profile:s}=q(),[r,c]=m.useState([]),[l,d]=m.useState(null),[o,i]=m.useState(!0),[n,h]=m.useState(null),[u,p]=m.useState(!1),g=(s==null?void 0:s.role)==="admin";m.useEffect(()=>{a!=null&&a.id&&v()},[a==null?void 0:a.id]);const v=async()=>{if(!(a!=null&&a.id)){console.warn("BadgesBlock: No user ID found");return}i(!0),console.log("BadgesBlock: Fetching badges for",a.id);try{await z.checkAndAwardBadges(a.id),console.log("BadgesBlock: checkAndAwardBadges completed");const t=await z.getUserBadges(a.id);if(console.log("BadgesBlock: User ID:",a.id),console.log("BadgesBlock: Earned badges raw:",t),c(t),g){const{data:x}=await b.from("profiles").select("total_xp, current_streak, referral_count").eq("id",a.id).single();h(x)}}catch(t){console.error("BadgesBlock: Error fetching badges:",t)}finally{i(!1)}},f=[{id:"primo_passo",name:"Primo Passo",icon:e.jsx(Z,{className:"w-8 h-8"}),unlocked:r.includes("primo_passo"),description:"Benvenuto a bordo! Hai iniziato il tuo percorso verso il successo.",requirement:"Hai completato la tua prima simulazione su Idoneo.",color:"from-blue-400 to-cyan-400"},{id:"secchione",name:"Secchione",icon:e.jsx(R,{className:"w-8 h-8"}),unlocked:r.includes("secchione"),description:"La perfezione fatta persona. Non hai sbagliato neanche una virgola!",requirement:"Hai ottenuto il 100% in una simulazione ufficiale (min. 10 domande).",color:"from-amber-400 to-orange-500"},{id:"veterano",name:"Veterano",icon:e.jsx(W,{className:"w-8 h-8"}),unlocked:r.includes("veterano"),description:"La tua esperienza Ã¨ un esempio per tutti. Conosci i quiz a memoria!",requirement:"Rispondi correttamente a 1.000 quiz (Raggiungi 1.000 XP).",color:"from-slate-700 to-slate-900"},{id:"social",name:"Social-ONE",icon:e.jsx(E,{className:"w-8 h-8"}),unlocked:r.includes("social"),description:"Studiare in compagnia Ã¨ meglio! Sei un vero leader della community.",requirement:"Invita con successo 5 amici a iscriversi su Idoneo.",color:"from-pink-400 to-rose-500"},{id:"inarrestabile",name:"Inarrestabile",icon:e.jsx(y,{className:"w-8 h-8"}),unlocked:r.includes("inarrestabile"),description:"Niente puÃ² fermare la tua voglia di imparare. Sei un treno!",requirement:"Mantieni una streak di studio per 30 giorni consecutivi.",color:"from-yellow-400 to-amber-500"},{id:"cecchino",name:"Cecchino",icon:e.jsx(J,{className:"w-8 h-8"}),unlocked:r.includes("cecchino"),description:"Ogni colpo va a segno. La tua precisione Ã¨ chirurgica.",requirement:"Completa 10 simulazioni di fila con un'accuratezza superiore al 90%.",color:"from-red-500 to-maroon-700"},{id:"fulmine",name:"Fulmine",icon:e.jsx(y,{className:"w-8 h-8"}),unlocked:r.includes("fulmine"),description:"VelocitÃ  e precisione. Hai finito il test prima ancora di iniziarlo!",requirement:"Completa 5 simulazioni in meno della metÃ  del tempo con un punteggio > 80%.",color:"from-cyan-400 to-blue-600"},{id:"enciclopedia",name:"Enciclopedia",icon:e.jsx(K,{className:"w-8 h-8"}),unlocked:r.includes("enciclopedia"),description:"La tua conoscenza non ha confini. Hai esplorato ogni angolo del sapere.",requirement:"Completa almeno un quiz in tutte le categorie disponibili.",color:"from-emerald-400 to-teal-600"},{id:"nottambulo",name:"Nottambulo",icon:e.jsx(Y,{className:"w-8 h-8"}),unlocked:r.includes("nottambulo"),description:"Il successo non dorme mai. Le tue ore piccole porteranno grandi risultati.",requirement:"Completa 5 simulazioni tra l'una e le cinque del mattino.",color:"from-indigo-600 to-purple-900"},{id:"hub_master",name:"Master Hub",icon:e.jsx(ee,{className:"w-8 h-8"}),unlocked:r.includes("hub_master"),description:"Sei il re del territorio. Nessun concorso ha segreti per te.",requirement:"Partecipa a simulazioni per 5 concorsi diversi.",color:"from-orange-500 to-red-600"},{id:"costanza",name:"Costanza",icon:e.jsx(ae,{className:"w-8 h-8"}),unlocked:r.includes("costanza"),description:"Il segreto del successo Ã¨ la regolaritÃ . Continua cosÃ¬!",requirement:"Completa almeno una simulazione al giorno per 7 giorni di fila.",color:"from-orange-400 to-red-500"},{id:"leggenda",name:"Leggenda",icon:e.jsx(te,{className:"w-8 h-8"}),unlocked:r.includes("leggenda"),description:"Sei tra i migliori aspiranti d'Italia. Continua a scalare la vetta!",requirement:"Raggiungi la Top 10 nella classifica globale (Gold League).",color:"from-purple-400 to-indigo-600"}];return o&&!f.length?null:e.jsxs("div",{className:"mb-10 mt-6 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4 px-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-5 h-5 text-amber-500"}),e.jsx("h3",{className:"text-xl font-black text-slate-900 tracking-tight",children:"I tuoi Badge"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[g&&e.jsx("button",{onClick:()=>p(!u),className:"text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-full hover:bg-slate-200 transition-colors",children:"DEBUG"}),e.jsxs("span",{className:"text-xs font-bold text-brand-blue bg-brand-blue/10 px-2 py-1 rounded-full",children:[he(f)," / ",f.length]})]})]}),u&&n&&e.jsxs("div",{className:"mx-2 mb-4 p-4 bg-slate-900 rounded-3xl text-white text-[11px] font-mono leading-relaxed shadow-xl border border-white/10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-emerald-400 font-bold uppercase tracking-widest text-[9px]",children:"Admin Debug Mode"}),e.jsx("div",{className:"flex gap-2",children:e.jsx("button",{onClick:()=>v(),className:"text-blue-400 hover:text-blue-300",children:"REFRESH"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-y-1",children:[e.jsx("div",{className:"text-slate-400 text-[10px] uppercase",children:"Total XP:"}),e.jsx("div",{className:"text-right font-bold text-brand-green",children:n.total_xp||0}),e.jsx("div",{className:"text-slate-400 text-[10px] uppercase",children:"Streak:"}),e.jsxs("div",{className:"text-right font-bold text-orange-400",children:[n.current_streak||0," giorni"]}),e.jsx("div",{className:"text-slate-400 text-[10px] uppercase",children:"Referrals:"}),e.jsx("div",{className:"text-right font-bold text-pink-400",children:n.referral_count||0}),e.jsx("div",{className:"text-slate-400 text-[10px] uppercase",children:"Badge Count:"}),e.jsx("div",{className:"text-right font-bold text-cyan-400",children:r.length})]}),e.jsxs("div",{className:"mt-3 pt-2 border-t border-white/10 text-[9px] text-slate-500 overflow-x-auto whitespace-nowrap",children:["Earned: ",r.join(", ")]})]}),e.jsx("div",{className:"flex gap-5 overflow-x-auto pb-6 scrollbar-hide snap-x px-2 pt-2",children:f.map(t=>e.jsxs(N.div,{whileTap:{scale:.95},onClick:()=>d(t),className:"flex-none snap-start w-24 flex flex-col items-center gap-3 cursor-pointer",children:[e.jsxs("div",{className:`relative w-20 h-20 flex items-center justify-center rounded-[24px] transition-all duration-300 shadow-sm
                            ${t.unlocked?`bg-gradient-to-br ${t.color} text-white shadow-lg shadow-black/5`:"bg-slate-100/80 text-slate-400 grayscale border border-slate-100"}`,children:[t.unlocked&&e.jsx("div",{className:"absolute inset-0 bg-white/20 rounded-[24px] pointer-events-none opacity-50",style:{clipPath:"polygon(0 0, 100% 0, 0 100%)"}}),!t.unlocked&&e.jsx("div",{className:"absolute -top-1 -right-1 bg-white rounded-full p-1 shadow-sm border border-slate-50",children:e.jsx("div",{className:"w-4 h-4 bg-slate-200 rounded-full flex items-center justify-center",children:e.jsx(w,{className:"w-2.5 h-2.5 text-slate-400",strokeWidth:4})})}),e.jsx("div",{className:"z-10 relative drop-shadow-sm",children:t.icon})]}),e.jsx("span",{className:`text-[10px] font-black text-center leading-tight uppercase tracking-wide
                            ${t.unlocked?"text-slate-800":"text-slate-400"}`,children:t.name})]},t.id))}),e.jsx(F,{children:l&&e.jsxs("div",{className:"fixed inset-0 z-[120] flex items-center justify-center p-6",children:[e.jsx(N.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>d(null),className:"absolute inset-0 bg-slate-900/60 backdrop-blur-md"}),e.jsxs(N.div,{initial:{scale:.9,opacity:0,y:30},animate:{scale:1,opacity:1,y:0},exit:{scale:.9,opacity:0,y:30},transition:{type:"spring",damping:25,stiffness:300},className:"relative bg-white rounded-[40px] p-8 max-w-sm w-full shadow-2xl text-center overflow-hidden",children:[e.jsx("div",{className:`absolute -top-20 -right-20 w-40 h-40 bg-gradient-to-br ${l.color} opacity-10 rounded-full blur-3xl`}),e.jsx("div",{className:`absolute -bottom-20 -left-20 w-40 h-40 bg-gradient-to-br ${l.color} opacity-10 rounded-full blur-3xl`}),e.jsx("button",{onClick:()=>d(null),className:"absolute top-6 right-6 p-2 bg-slate-100 hover:bg-slate-200 rounded-full text-slate-400 hover:text-slate-600 transition-colors z-20",children:e.jsx(w,{className:"w-4 h-4"})}),e.jsxs("div",{className:`w-28 h-28 rounded-[32px] bg-gradient-to-br ${l.unlocked?l.color:"from-slate-100 to-slate-200"}
                                flex items-center justify-center mx-auto mb-8 shadow-2xl relative group`,children:[l.unlocked&&e.jsx("div",{className:"absolute inset-0 bg-white/20 rounded-[32px] pointer-events-none",style:{clipPath:"polygon(0 0, 100% 0, 0 100%)"}}),e.jsx("div",{className:`${l.unlocked?"text-white":"text-slate-400"} drop-shadow-md scale-125`,children:l.icon})]}),e.jsx("h3",{className:"text-2xl font-black text-slate-900 mb-3 uppercase tracking-tight",children:l.name}),e.jsxs("p",{className:"text-slate-600 text-sm font-bold leading-relaxed mb-6 px-4",children:['"',l.description,'"']}),e.jsxs("div",{className:`p-5 rounded-3xl text-left border mb-8
                                ${l.unlocked?"bg-emerald-50 border-emerald-100/50":"bg-slate-50 border-slate-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:`w-5 h-5 rounded-full flex items-center justify-center
                                        ${l.unlocked?"bg-emerald-500":"bg-slate-300"}`,children:e.jsx(re,{className:"w-3 h-3 text-white"})}),e.jsx("span",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest",children:l.unlocked?"Badge Ottenuto":"Come sbloccare"})]}),e.jsx("p",{className:`text-[13px] font-black leading-snug
                                    ${l.unlocked?"text-emerald-700":"text-slate-600"}`,children:l.requirement})]}),e.jsx("button",{onClick:()=>d(null),className:`w-full py-4 rounded-2xl font-black text-white shadow-lg transition-transform active:scale-95
                                    ${l.unlocked?`bg-gradient-to-r ${l.color} shadow-black/10`:"bg-slate-900 shadow-black/10"}`,children:l.unlocked?"Condividi Traguardo":"Ho capito"})]})]})})]})}function he(a){return a.filter(s=>s.unlocked).length}const k={async searchUsers(a,s){if(!a||a.length<3)return[];const{data:r,error:c}=await b.from("profiles").select("id, nickname, avatar_url, created_at").ilike("nickname",`%${a}%`).neq("id",s).limit(10);return c?(console.error("Search error:",c),[]):r||[]},async sendRequest(a,s){const{data:r}=await b.from("friendships").select("*").or(`and(user_id.eq.${a},friend_id.eq.${s}),and(user_id.eq.${s},friend_id.eq.${a})`).single();if(r)return r.status==="rejected"?{error:"Request previously rejected."}:{error:"Friendship already exists or is pending."};const{error:c}=await b.from("friendships").insert({user_id:a,friend_id:s,status:"pending"});return{error:c}},async acceptRequest(a){const{error:s}=await b.from("friendships").update({status:"accepted"}).eq("id",a);return{error:s}},async removeFriendship(a){const{error:s}=await b.from("friendships").delete().eq("id",a);return{error:s}},async getFriendsAndRequests(a){const{data:s}=await b.from("profiles").select("id, nickname, avatar_url, created_at").eq("referred_by",a).order("created_at",{ascending:!1}),r=(s||[]).map(n=>({...n,status:"referral"})),{data:c}=await b.from("friendships").select(`
                id,
                status,
                user_id,
                friend_id,
                created_at,
                sender:profiles!user_id(id, nickname, avatar_url),
                receiver:profiles!friend_id(id, nickname, avatar_url)
            `).or(`user_id.eq.${a},friend_id.eq.${a}`),l=[],d=[],o=[];c==null||c.forEach(n=>{const h=n.user_id===a,u=h?n.receiver:n.sender;if(!u)return;const p={id:u.id,nickname:u.nickname,avatar_url:u.avatar_url,created_at:n.created_at,friendship_id:n.id,status:n.status,is_requester:h};n.status==="accepted"?l.push(p):n.status==="pending"&&(h?o.push(p):d.push(p))});const i=new Map;return r.forEach(n=>i.set(n.id,n)),l.forEach(n=>i.set(n.id,n)),{friends:Array.from(i.values()),pendingReceived:d,pendingSent:o}}};function pe({isOpen:a,onClose:s,currentUserId:r,onRequestSent:c}){const[l,d]=m.useState(""),[o,i]=m.useState([]),[n,h]=m.useState(!1),[u,p]=m.useState(!1),[g,v]=m.useState(new Set);if(!a)return null;const f=async x=>{if(x.preventDefault(),!(l.length<3)){p(!0);try{const j=await k.searchUsers(l,r);i(j)}catch(j){console.error(j)}finally{p(!1)}}},t=async x=>{v(j=>new Set(j).add(x)),await k.sendRequest(r,x),c()};return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 animate-in fade-in duration-200",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:s}),e.jsxs("div",{className:"relative bg-white w-full max-w-md rounded-3xl shadow-2xl p-6 overflow-hidden animate-in zoom-in-95 duration-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900",children:"Aggiungi Amico"}),e.jsx("button",{onClick:s,className:"p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors",children:e.jsx(w,{className:"w-5 h-5 text-slate-500"})})]}),e.jsx("form",{onSubmit:f,className:"mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Cerca per nickname...",value:l,onChange:x=>d(x.target.value),className:"w-full pl-12 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#00B1FF]/50 transition-all font-medium placeholder:text-slate-400",autoFocus:!0}),e.jsx(A,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"})]})}),e.jsx("div",{className:"max-h-60 overflow-y-auto space-y-3 min-h-[100px]",children:u?e.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-slate-400",children:[e.jsx(le,{className:"w-6 h-6 animate-spin mb-2"}),e.jsx("p",{className:"text-sm",children:"Ricerca in corso..."})]}):o.length>0?o.map(x=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-xl hover:bg-slate-50 transition-colors border border-transparent hover:border-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-slate-200 overflow-hidden flex-shrink-0",children:x.avatar_url?e.jsx("img",{src:x.avatar_url,alt:x.nickname,className:"w-full h-full object-cover"}):e.jsx("span",{className:"w-full h-full flex items-center justify-center text-lg",children:"ðŸ‘¤"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-slate-900",children:x.nickname}),e.jsx("p",{className:"text-xs text-slate-400",children:"Utente Idoneo"})]})]}),g.has(x.id)?e.jsxs("span",{className:"px-3 py-1.5 bg-emerald-100 text-emerald-600 rounded-lg text-xs font-bold flex items-center gap-1",children:[e.jsx(P,{className:"w-3 h-3"})," Inviata"]}):e.jsx("button",{onClick:()=>t(x.id),className:"p-2 bg-[#00B1FF] rounded-lg text-white shadow-md shadow-blue-500/20 active:scale-95 transition-all",children:e.jsx(ie,{className:"w-4 h-4"})})]},x.id)):l.length>=3?e.jsx("div",{className:"text-center py-8 text-slate-400",children:e.jsx("p",{children:"Nessun utente trovato con questo nome."})}):e.jsx("div",{className:"text-center py-8 text-slate-400",children:e.jsx("p",{children:"Scrivi almeno 3 caratteri per cercare."})})})]})]})}function ge({userId:a}){const[s,r]=m.useState([]),[c,l]=m.useState([]),[d,o]=m.useState(!0);oe();const[i,n]=m.useState(!1),[h,u]=m.useState(!1),p=()=>{n(!0)},g=async()=>{if(a)try{const{friends:t,pendingReceived:x}=await k.getFriendsAndRequests(a);r(t),l(x)}catch(t){console.error("Error fetching friends:",t)}finally{o(!1)}};m.useEffect(()=>{g()},[a]);const v=async t=>{t&&(await k.acceptRequest(t),g())},f=async t=>{t&&(await k.removeFriendship(t),g())};return e.jsxs("div",{className:"bg-white dark:bg-[var(--card)] rounded-3xl p-6 shadow-sm border border-slate-100 dark:border-slate-800 transition-colors",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-[var(--foreground)]",children:"I tuoi Amici"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>u(!0),className:"p-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors",title:"Cerca amici",children:e.jsx(A,{className:"w-4 h-4"})}),s.length>0&&e.jsx("button",{onClick:p,className:"text-sm font-bold text-[#00B1FF] hover:text-[#0099e6] transition-colors",children:"Invita"})]})]}),c.length>0&&e.jsxs("div",{className:"mb-6 bg-amber-50 dark:bg-amber-900/10 rounded-2xl p-4 border border-amber-100 dark:border-amber-900/20",children:[e.jsx("h4",{className:"text-xs font-bold text-amber-600 dark:text-amber-500 uppercase tracking-wider mb-3",children:"Richieste in attesa"}),e.jsx("div",{className:"space-y-3",children:c.map(t=>e.jsxs("div",{className:"flex items-center justify-between bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 overflow-hidden",children:t.avatar_url?e.jsx("img",{src:t.avatar_url,className:"w-full h-full object-cover"}):e.jsx("span",{className:"flex items-center justify-center w-full h-full",children:"ðŸ‘¤"})}),e.jsx("span",{className:"text-sm font-bold text-slate-900 dark:text-slate-100",children:t.nickname})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>v(t.friendship_id),className:"p-1.5 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-lg hover:bg-emerald-200 dark:hover:bg-emerald-900/50",children:e.jsx(P,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>f(t.friendship_id),className:"p-1.5 bg-red-100 dark:bg-red-900/30 text-red-500 dark:text-red-400 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50",children:e.jsx(w,{className:"w-4 h-4"})})]})]},t.id))})]}),d?e.jsx("div",{className:"space-y-3",children:[1,2].map(t=>e.jsxs("div",{className:"flex gap-4 items-center animate-pulse",children:[e.jsx("div",{className:"w-10 h-10 bg-slate-100 dark:bg-slate-800 rounded-full"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 bg-slate-100 dark:bg-slate-800 rounded w-1/3"}),e.jsx("div",{className:"h-3 bg-slate-100 dark:bg-slate-800 rounded w-1/4"})]})]},t))}):s.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-center bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-dashed border-slate-200 dark:border-slate-700",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-[#E0F2FE] dark:bg-blue-900/20 flex items-center justify-center mb-3",children:e.jsx(E,{className:"w-7 h-7 text-[#00B1FF]"})}),e.jsxs("p",{className:"text-sm font-medium text-slate-500 dark:text-slate-400 mb-4 px-4",children:["Non hai ancora amici. ",e.jsx("br",{}),"Cerca per nickname o invitali!"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>u(!0),className:"px-5 py-2.5 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 font-bold rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-all text-sm",children:"Cerca"}),e.jsxs("button",{onClick:p,className:"px-5 py-2.5 bg-[#00B1FF] hover:bg-[#0099e6] active:scale-[0.98] text-white font-bold rounded-xl shadow-lg shadow-blue-500/20 flex items-center gap-2 transition-all text-sm",children:[e.jsx(ne,{className:"w-4 h-4"}),"Invita"]})]})]}):e.jsx("div",{className:"space-y-4 max-h-[400px] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-slate-200 dark:scrollbar-thumb-slate-700 scrollbar-track-transparent",children:s.map(t=>e.jsxs("div",{className:"flex gap-4 items-center group",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex-shrink-0 flex items-center justify-center overflow-hidden border border-slate-100 dark:border-slate-700",children:t.avatar_url?e.jsx("img",{src:t.avatar_url,alt:t.nickname,className:"w-full h-full object-cover"}):e.jsx("span",{className:"text-lg",children:"ðŸ‘¤"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-bold text-slate-900 dark:text-slate-100 leading-tight truncate",children:t.nickname||"Utente"}),e.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[t.status==="referral"&&e.jsx("span",{className:"text-[10px] font-bold bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 px-1.5 py-0.5 rounded",children:"INVITATO"}),e.jsxs("p",{className:"text-xs text-slate-400 dark:text-slate-500",children:["Iscritto il ",new Date(t.created_at).toLocaleDateString()]})]})]})]},t.id))}),e.jsx(ce,{isOpen:i,onClose:()=>n(!1)}),e.jsx(pe,{isOpen:h,onClose:()=>u(!1),currentUserId:a,onRequestSent:g})]})}const fe=()=>null;function ze(){const{user:a,profile:s,loading:r}=q(),c=C(),[l,d]=m.useState(0),{startOnboarding:o,hasCompletedContext:i}=L();return m.useEffect(()=>{if(!r&&!a){c("/login");return}async function n(){if(!a)return;const h=await de.getUserXp(a.id);d(h.totalXp)}n()},[a,r,c]),m.useEffect(()=>{if(!r&&s&&!i("profile")){const n=setTimeout(()=>o("profile"),500);return()=>clearTimeout(n)}},[r,s,i,o]),r||!s?e.jsx(I,{message:"Caricamento profilo..."}):e.jsxs("div",{className:"min-h-screen bg-[var(--background)] pb-24 relative overflow-hidden transition-colors duration-300",children:[e.jsx(fe,{}),e.jsx("div",{className:"pt-safe"}),e.jsx("div",{className:"max-w-6xl mx-auto relative px-4 lg:px-6",children:e.jsxs("div",{className:"lg:grid lg:grid-cols-[360px_1fr] lg:gap-10",children:[e.jsxs("div",{className:"lg:sticky lg:top-8 lg:self-start space-y-6",children:[e.jsx("div",{"data-onboarding":"stats",children:e.jsx(me,{user:a,profile:s,xp:l})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(B,{})})]}),e.jsxs("div",{className:"space-y-6 mt-6 lg:mt-0",children:[e.jsx(ue,{userId:(a==null?void 0:a.id)||""}),e.jsx(ge,{userId:(a==null?void 0:a.id)||""}),e.jsx("div",{className:"lg:hidden",children:e.jsx(B,{})})]})]})})]})}export{ze as default};
