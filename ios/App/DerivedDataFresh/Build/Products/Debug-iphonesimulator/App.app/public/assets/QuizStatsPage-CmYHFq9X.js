import{j as e,m as O,A as ye}from"./framer-CcO5Kjcw.js";import{r as x,u as Z,L as Ne,b as we}from"./router-ClfHAwMg.js";import{T as ke}from"./TierSLoader-CVYPZXYz.js";import{a as Se,s as I}from"./index-Z19V86or.js";import{a as Ce,c as ze,b as $e,g as Te}from"./statsService-Cb4H8UUT.js";import{a8 as le,m as ee,E as ne,w as M,ag as ce,O as K,X as Y,aT as _e,W as Fe,b as qe,s as J,Z as De,aU as Ie,j as ae,y as de,aH as Me,N as Pe,q as Ae,l as Re}from"./icons-Dvxa2Qho.js";import{A as Be}from"./AttemptCard-DaPFDozq.js";import"./react-vendor-B--z-fyW.js";import"./supabase-CIvuJI4W.js";function Le({totalTests:t,bestScore:u,avgScore:b,accuracy:n,maxPossibleScore:c=100,scoreTrend:i,accuracyTrend:h,readiness:a,onOpenInfo:f}){const[r,l]=x.useState(null),s=Z(),g={tests:{title:"Simulazioni fatte",description:"Indica il numero totale di simulazioni d'esame che hai completato per questo concorso.",icon:e.jsx(le,{className:"w-6 h-6"}),color:"text-brand-purple bg-brand-purple/10"},best:{title:"Miglior Risultato",description:"Il punteggio piÃ¹ alto che hai ottenuto in una singola simulazione, rapportato al punteggio massimo possibile.",icon:e.jsx(ee,{className:"w-6 h-6"}),color:"text-brand-orange bg-brand-orange/10"},avg:{title:"Punti su 100",description:"La tua media dei voti normalizzata su una scala da 0 a 100, per darti un'idea chiara del tuo livello medio.",icon:e.jsx(ne,{className:"w-6 h-6"}),color:"text-brand-blue bg-brand-blue/10"},accuracy:{title:"Risposte corrette",description:"La percentuale media di risposte esatte che dai durante i test. PiÃ¹ Ã¨ alta, piÃ¹ sei preciso.",icon:e.jsx(M,{className:"w-6 h-6"}),color:"text-semantic-success bg-semantic-success/10"}},m=()=>{var j,$,p,w;if(!a)s("/preparazione?hasData=false&level=low&score=0");else{const y=new URLSearchParams({hasData:"true",level:a.level,score:String(a.score||0),accuracy:String(((j=a.breakdown)==null?void 0:j.accuracy)||0),volume:String((($=a.breakdown)==null?void 0:$.volume)||0),coverage:String(((p=a.breakdown)==null?void 0:p.coverage)||0),reliability:String(((w=a.breakdown)==null?void 0:w.reliability)||0)});s(`/preparazione?${y.toString()}`)}};return e.jsxs("div",{className:"space-y-6 mb-8",children:[e.jsxs("div",{"data-onboarding":"stats-kpi",className:"grid grid-cols-2 gap-4",children:[e.jsx(X,{icon:e.jsx(le,{className:"w-5 h-5 text-brand-purple"}),iconBg:"bg-brand-purple/10",badgeColor:"bg-brand-purple/10 text-brand-purple",label:"Test fatti",value:t.toString(),subLabel:"Simulazioni fatte",onInfo:()=>l(g.tests)}),e.jsx(X,{icon:e.jsx(ee,{className:"w-5 h-5 text-brand-orange"}),iconBg:"bg-brand-orange/10",badgeColor:"bg-brand-orange/10 text-brand-orange",label:"Miglior voto",value:`${u.toFixed(0)}/${c}`,subLabel:"Miglior Risultato",onInfo:()=>l(g.best)}),e.jsx(X,{icon:e.jsx(ne,{className:"w-5 h-5 text-brand-blue"}),iconBg:"bg-brand-blue/10",badgeColor:"bg-brand-blue/10 text-brand-blue",label:"Media voto",value:b.toFixed(1),subLabel:"Punti su 100",onInfo:()=>l(g.avg)}),e.jsx(X,{icon:e.jsx(M,{className:"w-5 h-5 text-semantic-success"}),iconBg:"bg-semantic-success/10",badgeColor:"bg-semantic-success/10 text-semantic-success",label:"Accuratezza",value:`${n.toFixed(0)}%`,subLabel:"Risposte corrette",onInfo:()=>l(g.accuracy)})]}),a&&e.jsxs("div",{"data-onboarding":"stats-readiness",onClick:m,className:"group relative bg-[var(--card)] p-6 rounded-[32px] shadow-soft flex items-center justify-between overflow-hidden border border-[var(--card-border)] cursor-pointer hover:border-[#00B1FF]/30 transition-all",children:[e.jsx("div",{className:"absolute top-0 right-0 w-40 h-40 bg-gradient-to-bl from-[#00B1FF] to-emerald-500 opacity-[0.05] rounded-bl-[100px] pointer-events-none"}),e.jsxs("div",{className:"flex-1 pr-4 z-10",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:`px-2.5 py-0.5 rounded-full text-[10px] font-black uppercase tracking-wider ${a.level==="high"?"bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400":a.level==="medium"?"bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400":"bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400"}`,children:a.label}),e.jsx("div",{className:"w-4 h-4 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-400",children:e.jsx(ce,{className:"w-2.5 h-2.5"})})]}),e.jsx("h3",{className:"text-xl font-black text-[var(--foreground)] mb-1 leading-tight",children:a.level==="high"?"Sei pronto!":a.level==="medium"?"A buon punto":"Sei all'inizio"}),e.jsx("p",{className:"text-[14px] text-slate-500 dark:text-slate-400 leading-snug",children:a.level==="high"?"Ottima costanza. Sei pronto per la prova ufficiale.":a.level==="medium"?"Continua cosÃ¬, manca poco per l'eccellenza.":"Serve piÃ¹ allenamento. Non mollare!"})]}),e.jsxs("div",{className:"relative w-20 h-20 flex-shrink-0 flex items-center justify-center z-10",children:[e.jsxs("svg",{className:"w-full h-full transform -rotate-90",children:[e.jsx("circle",{cx:"40",cy:"40",r:"32",stroke:"currentColor",strokeWidth:"6",fill:"transparent",className:"text-slate-100 dark:text-slate-800"}),e.jsx(O.circle,{initial:{strokeDasharray:200,strokeDashoffset:200},animate:{strokeDashoffset:200-(a.score!==void 0?a.score:a.level==="high"?92:a.level==="medium"?65:35)/100*200},transition:{duration:1.5,ease:"easeOut"},cx:"40",cy:"40",r:"32",stroke:a.level==="high"?"#10B981":a.level==="medium"?"#F59E0B":"#EF4444",strokeWidth:"6",strokeLinecap:"round",fill:"transparent"})]}),e.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center",children:a.score!==void 0?e.jsx("span",{className:`text-lg font-black ${a.level==="high"?"text-emerald-600":a.level==="medium"?"text-amber-600":"text-red-600"}`,children:Math.round(a.score)}):e.jsx(e.Fragment,{children:a.level==="high"?e.jsx(ee,{className:"w-6 h-6 text-emerald-600 dark:text-emerald-400"}):a.level==="medium"?e.jsx(K,{className:"w-6 h-6 text-amber-600 dark:text-amber-400"}):e.jsx(M,{className:"w-6 h-6 text-red-600 dark:text-red-400"})})})]})]}),e.jsx(ye,{children:r&&e.jsxs("div",{className:"fixed inset-0 z-[110] flex items-center justify-center p-6",children:[e.jsx(O.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>l(null),className:"absolute inset-0 bg-slate-900/60 backdrop-blur-sm"}),e.jsxs(O.div,{initial:{scale:.9,opacity:0,y:20},animate:{scale:1,opacity:1,y:0},exit:{scale:.9,opacity:0,y:20},className:"relative bg-[var(--card)] border border-[var(--card-border)] rounded-[32px] p-8 max-w-xs w-full shadow-2xl text-center overflow-y-auto max-h-[90vh] custom-scrollbar",children:[e.jsx("button",{onClick:()=>l(null),className:"absolute top-4 right-4 p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-[var(--foreground)] opacity-40 hover:opacity-100 transition-colors",children:e.jsx(Y,{className:"w-4 h-4"})}),e.jsx("div",{className:`w-16 h-16 rounded-[22px] ${r.color} flex items-center justify-center mx-auto mb-5`,children:r.icon}),e.jsx("h3",{className:"text-xl font-black text-[var(--foreground)] mb-2",children:r.title}),e.jsx("p",{className:"text-[var(--foreground)] opacity-50 text-sm font-medium leading-relaxed",children:r.description}),e.jsx("button",{onClick:()=>l(null),className:"w-full mt-8 py-3 bg-[var(--foreground)] text-[var(--background)] rounded-2xl font-bold hover:opacity-90 transition-opacity",children:"Ho capito"})]})]})})]})}function X({icon:t,iconBg:u,badgeColor:b,label:n,value:c,subLabel:i,onInfo:h}){return e.jsxs("div",{onClick:h,className:"bg-[var(--card)] p-4 rounded-[24px] shadow-soft border border-[var(--card-border)] hover:shadow-card transition-all duration-300 group flex flex-col justify-between h-[150px] relative overflow-hidden cursor-pointer active:scale-95",children:[e.jsx("div",{className:"flex justify-between items-start z-10 relative",children:e.jsx("div",{className:`w-10 h-10 rounded-[14px] flex items-center justify-center ${u} transition-transform group-hover:scale-110 duration-300`,children:t})}),e.jsxs("div",{className:"z-10 relative",children:[e.jsx("div",{className:"text-[32px] font-black text-[var(--foreground)] leading-none tracking-tight mb-1",children:c}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-[11px] font-bold text-[var(--foreground)] opacity-40 uppercase tracking-wide",children:i}),e.jsx("button",{onClick:a=>{a.stopPropagation(),h()},className:"p-1.5 rounded-full bg-slate-50 dark:bg-slate-800 text-[var(--foreground)] opacity-20 hover:opacity-100 hover:text-brand-blue hover:bg-brand-blue/5 transition-all",children:e.jsx(ce,{className:"w-3.5 h-3.5"})})]})]})]})}function Oe({data:t}){if(t.length<3)return e.jsx(Ee,{data:t});const u=300,b=u/2,n=u/2-40,c=t.length,i=(r,l)=>{const s=Math.PI*2*l/c-Math.PI/2,g=b+n*(r/100)*Math.cos(s),m=b+n*(r/100)*Math.sin(s);return{x:g,y:m}},h=t.map((r,l)=>{const{x:s,y:g}=i(r.accuracy,l);return`${s},${g}`}).join(" "),a=t.map((r,l)=>{const{x:s,y:g}=i(100,l),m=Math.PI*2*l/c-Math.PI/2,j=b+(n+20)*Math.cos(m),$=b+(n+20)*Math.sin(m);return{x:s,y:g,lx:j,ly:$,label:r.subject}}),f=[20,40,60,80,100];return e.jsx("div",{className:"flex flex-col items-center",children:e.jsxs("svg",{width:u,height:u,className:"overflow-visible",children:[f.map(r=>{const l=t.map((s,g)=>{const{x:m,y:j}=i(r,g);return`${m},${j}`}).join(" ");return e.jsx("polygon",{points:l,fill:"none",stroke:"currentColor",strokeWidth:"1.5",className:"text-slate-100 dark:text-slate-800"},r)}),a.map((r,l)=>e.jsxs("g",{children:[e.jsx("line",{x1:b,y1:b,x2:r.x,y2:r.y,stroke:"currentColor",strokeWidth:"1.5",className:"text-slate-100 dark:text-slate-800"}),e.jsx("text",{x:r.lx,y:r.ly,textAnchor:"middle",dominantBaseline:"middle",className:"text-[10px] fill-[var(--foreground)] opacity-40 font-bold uppercase tracking-wider",children:r.label.substring(0,15)})]},l)),e.jsx("polygon",{points:h,fill:"rgba(6, 214, 211, 0.2)",stroke:"#06D6D3",strokeWidth:"3",strokeLinejoin:"round"}),t.map((r,l)=>{const{x:s,y:g}=i(r.accuracy,l);return e.jsx("circle",{cx:s,cy:g,r:"5",fill:"#06D6D3",stroke:"var(--card)",strokeWidth:"3"},l)})]})})}function Ee({data:t}){return e.jsxs("div",{className:"space-y-4 w-full",children:[t.map(u=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-bold text-[var(--foreground)] opacity-60",children:u.subject}),e.jsxs("span",{className:"text-sm font-bold text-[var(--foreground)]",children:[u.accuracy.toFixed(0),"%"]})]}),e.jsx("div",{className:"h-2 w-full bg-slate-100 dark:bg-slate-800 rounded-pill overflow-hidden",children:e.jsx("div",{className:`h-full rounded-pill transition-all duration-500 ${u.accuracy>=70?"bg-emerald-500":u.accuracy>=50?"bg-amber-500":"bg-rose-500"}`,style:{width:`${u.accuracy}%`}})})]},u.subject)),t.length===0&&e.jsx("p",{className:"text-slate-400 text-sm text-center",children:"Nessun dato materia."})]})}function Ge({attempts:t,quizId:u,onRepeatTest:b}){Z();const[n,c]=x.useState("all"),[i,h]=x.useState("all"),[a,f]=x.useState(!1),r=x.useMemo(()=>t.filter(s=>{if(n!=="all"&&(n==="official"&&s.mode!=="official"||n==="custom"&&s.mode!=="custom"))return!1;if(i!=="all"){const g=s.total_questions>0?s.correct/s.total_questions*100:0;let m="fail";if(g>=60?m="pass":g>=50&&(m="near"),i!==m)return!1}return!0}),[t,n,i]);if(t.length===0)return e.jsxs("div",{className:"text-center py-12 text-[var(--foreground)] opacity-40",children:[e.jsx("div",{className:"text-4xl mb-3",children:"ðŸ“"}),"Nessuna attivitÃ  recente."]});const l=n!=="all"||i!=="all";return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("button",{onClick:()=>f(!a),className:"flex items-center gap-2 text-xs font-bold text-[var(--foreground)] opacity-50 hover:opacity-100 transition-opacity",children:["Filtri",l&&e.jsx("span",{className:"w-2 h-2 rounded-full bg-[#00B1FF]"}),a?e.jsx(_e,{className:"w-4 h-4"}):e.jsx(Fe,{className:"w-4 h-4"})]}),a&&e.jsxs("div",{className:"flex flex-wrap gap-4 pb-2 p-4 bg-[var(--card)] rounded-2xl border border-[var(--card-border)] shadow-sm",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("span",{className:"text-[10px] font-bold text-slate-400 uppercase mr-2 self-center",children:"Tipo:"}),[{value:"all",label:"Tutti"},{value:"official",label:"Esame"},{value:"custom",label:"Personalizzata"}].map(s=>e.jsx("button",{onClick:()=>c(s.value),className:`px-3 py-1 text-xs font-bold rounded-full transition-all ${n===s.value?"bg-[#00B1FF] text-white":"bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700"}`,children:s.label},s.value))]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("span",{className:"text-[10px] font-bold text-slate-400 uppercase mr-2 self-center",children:"Risultato:"}),[{value:"all",label:"Tutti"},{value:"pass",label:"Idoneo"},{value:"near",label:"Quasi"},{value:"fail",label:"Non idoneo"}].map(s=>e.jsx("button",{onClick:()=>h(s.value),className:`px-3 py-1 text-xs font-bold rounded-full transition-all ${i===s.value?"bg-slate-900 dark:bg-slate-700 text-white":"bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700"}`,children:s.label},s.value))]})]}),l&&e.jsxs("p",{className:"text-xs text-[var(--foreground)] opacity-40",children:[r.length," risultat",r.length===1?"o":"i"," trovat",r.length===1?"o":"i"]}),e.jsx("div",{className:"space-y-3",children:r.map(s=>e.jsx(Be,{attempt:s},s.id))}),r.length===0&&e.jsxs("div",{className:"text-center py-12 text-[var(--foreground)] opacity-40",children:[e.jsx("div",{className:"text-4xl mb-3",children:"ðŸ”"}),"Nessun tentativo corrisponde ai filtri selezionati."]})]})}const te={score:{label:"Punteggio",unit:"pt",color:"#06D6D3"},accuracy:{label:"Accuratezza",unit:"%",color:"#22C55E"},responseTime:{label:"Tempo medio",unit:"s",color:"#F59E0B"}};function Qe({data:t,defaultMetric:u="score",defaultTimeRange:b="all"}){var R,H;const[n,c]=x.useState(u),[i,h]=x.useState(b),[a,f]=x.useState(null),r=x.useMemo(()=>{if(i==="all")return t;const o=new Date,k=i==="7d"?7:30,F=new Date(o.getTime()-k*24*60*60*1e3);return t.filter(B=>B.fullDate>=F)},[t,i]),l=o=>{switch(n){case"score":return o.score;case"accuracy":return o.accuracy;case"responseTime":return(o.responseTime||0)/1e3;default:return o.score}};if(r.length<2)return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-between items-center",children:[e.jsx("div",{className:"flex gap-1",children:["score","accuracy"].map(o=>e.jsx("button",{onClick:()=>c(o),className:`px-3 py-1.5 text-xs font-bold rounded-pill transition-all ${n===o?"bg-brand-cyan text-white":"bg-slate-100 dark:bg-slate-800 text-text-secondary dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700"}`,children:te[o].label},o))}),e.jsx("div",{className:"flex gap-1",children:["7d","30d","all"].map(o=>e.jsx("button",{onClick:()=>h(o),className:`px-3 py-1.5 text-xs font-bold rounded-pill transition-all ${i===o?"bg-[var(--foreground)] text-[var(--background)]":"bg-slate-100 dark:bg-slate-800 text-text-secondary dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700"}`,children:o==="all"?"Tutto":o},o))})]}),e.jsx("div",{className:"h-48 flex items-center justify-center text-slate-400 italic text-sm",children:"Non ci sono abbastanza dati per questo periodo."})]});const s=600,g=200,m=30,j=r.map(l),$=Math.max(...j,10),p=Math.min(...j,0),w=$-p||1,y=o=>m+o/(r.length-1)*(s-m*2),A=o=>g-m-(o-p)/w*(g-m*2),W=r.map((o,k)=>{const F=y(k),B=A(l(o));return`${k===0?"M":"L"} ${F} ${B}`}).join(" "),E=`${W} L ${s-m} ${g-m} L ${m} ${g-m} Z`,P=te[n];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-between items-center",children:[e.jsx("div",{className:"flex gap-1",children:["score","accuracy"].map(o=>e.jsx("button",{onClick:()=>c(o),className:`px-3 py-1.5 text-xs font-bold rounded-pill transition-all ${n===o?"bg-brand-cyan text-white":"bg-slate-100 dark:bg-slate-800 text-text-secondary dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700"}`,children:te[o].label},o))}),e.jsx("div",{className:"flex gap-1",children:["7d","30d","all"].map(o=>e.jsx("button",{onClick:()=>h(o),className:`px-3 py-1.5 text-xs font-bold rounded-pill transition-all ${i===o?"bg-[var(--foreground)] text-[var(--background)]":"bg-slate-100 dark:bg-slate-800 text-text-secondary dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700"}`,children:o==="all"?"Tutto":o},o))})]}),e.jsxs("div",{className:"w-full overflow-hidden relative",children:[e.jsxs("svg",{viewBox:`0 0 ${s} ${g}`,className:"w-full h-auto",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:`gradient-${n}`,x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:P.color,stopOpacity:"0.2"}),e.jsx("stop",{offset:"100%",stopColor:P.color,stopOpacity:"0"})]})}),[0,.5,1].map(o=>{const k=p+w*o,F=A(k);return e.jsxs("g",{children:[e.jsx("line",{x1:m,y1:F,x2:s-m,y2:F,stroke:"currentColor",className:"text-slate-200 dark:text-slate-800",strokeWidth:"1.5",strokeDasharray:"4"}),e.jsx("text",{x:m-8,y:F+4,textAnchor:"end",className:"text-[10px] fill-[var(--foreground)] opacity-40 font-medium",children:k.toFixed(0)})]},o)}),e.jsx("path",{d:E,fill:`url(#gradient-${n})`}),e.jsx("path",{d:W,fill:"none",stroke:P.color,strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round"}),r.map((o,k)=>e.jsx("g",{children:e.jsx("circle",{cx:y(k),cy:A(l(o)),r:a===k?8:5,fill:"var(--card)",stroke:P.color,strokeWidth:"3",className:"cursor-pointer transition-all",onMouseEnter:()=>f(k),onMouseLeave:()=>f(null)})},k))]}),a!==null&&r[a]&&e.jsxs("div",{className:"absolute bg-[var(--card)] rounded-xl shadow-lg border border-[var(--card-border)] p-3 z-10 pointer-events-none transition-colors",style:{left:`${y(a)/s*100}%`,top:`${A(l(r[a]))/g*100-20}%`,transform:"translateX(-50%)"},children:[e.jsx("p",{className:"text-xs text-[var(--foreground)] opacity-40 mb-1",children:r[a].date}),e.jsxs("p",{className:"text-sm font-bold text-[var(--foreground)]",children:[l(r[a]).toFixed(1)," ",P.unit]}),r[a].id&&e.jsx(Ne,{to:`/quiz/results/${r[a].id}`,className:"text-[10px] font-bold text-brand-cyan hover:underline pointer-events-auto",children:"Vedi dettagli â†’"})]})]}),e.jsxs("div",{className:"flex justify-between text-[10px] text-text-tertiary font-medium px-2",children:[e.jsx("span",{children:(R=r[0])==null?void 0:R.date}),e.jsx("span",{children:(H=r[r.length-1])==null?void 0:H.date})]})]})}const We={review:{icon:Ie,gradient:"from-amber-500 to-orange-500",bgGlow:"bg-gradient-to-br from-amber-500/10 to-orange-500/10",iconBg:"bg-gradient-to-br from-amber-500 to-orange-500",accentColor:"text-amber-600 dark:text-amber-400",borderHover:"hover:border-amber-300 dark:hover:border-amber-600"},practice:{icon:M,gradient:"from-rose-500 to-pink-500",bgGlow:"bg-gradient-to-br from-rose-500/10 to-pink-500/10",iconBg:"bg-gradient-to-br from-rose-500 to-pink-500",accentColor:"text-rose-600 dark:text-rose-400",borderHover:"hover:border-rose-300 dark:hover:border-rose-600"},simulation:{icon:De,gradient:"from-[#00B1FF] to-cyan-400",bgGlow:"bg-gradient-to-br from-[#00B1FF]/10 to-cyan-400/10",iconBg:"bg-gradient-to-br from-[#00B1FF] to-cyan-400",accentColor:"text-[#00B1FF]",borderHover:"hover:border-cyan-300 dark:hover:border-cyan-600"},goal:{icon:J,gradient:"from-emerald-500 to-green-500",bgGlow:"bg-gradient-to-br from-emerald-500/10 to-green-500/10",iconBg:"bg-gradient-to-br from-emerald-500 to-green-500",accentColor:"text-emerald-600 dark:text-emerald-400",borderHover:"hover:border-emerald-300 dark:hover:border-emerald-600"}};function He({recommendations:t,onSetGoal:u}){const b=Z();if(t.length===0)return null;const n=c=>{c.type==="goal"&&u?u():c.actionUrl&&b(c.actionUrl)};return e.jsxs(O.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"relative bg-[var(--card)] rounded-[32px] shadow-soft p-6 border border-[var(--card-border)] transition-colors overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 right-0 w-48 h-48 bg-gradient-to-bl from-[#00B1FF]/5 to-emerald-500/5 rounded-bl-[100px] pointer-events-none"}),e.jsxs("div",{className:"flex items-center justify-between mb-6 relative z-10",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-black text-[var(--foreground)]",children:"Cosa fare adesso"}),e.jsx("p",{className:"text-[13px] text-slate-500 dark:text-slate-400 mt-0.5",children:"Suggerimenti personalizzati per te"})]}),e.jsx(O.div,{animate:{rotate:[0,10,-10,0]},transition:{duration:2,repeat:1/0,repeatDelay:3},className:"w-14 h-14 rounded-[18px] bg-gradient-to-br from-[#00B1FF] to-emerald-500 flex items-center justify-center shadow-lg",children:e.jsx(qe,{className:"w-7 h-7 text-white"})})]}),e.jsx("div",{className:"space-y-3 relative z-10",children:t.map((c,i)=>{const h=We[c.type],a=h.icon;return e.jsxs(O.button,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:i*.1},onClick:()=>n(c),className:`w-full flex items-center gap-4 p-4 rounded-[20px] bg-white dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700/50 ${h.borderHover} hover:shadow-md active:scale-[0.98] transition-all text-left group relative overflow-hidden`,children:[e.jsx("div",{className:`absolute inset-0 ${h.bgGlow} opacity-0 group-hover:opacity-100 transition-opacity`}),e.jsx("div",{className:`relative w-12 h-12 rounded-2xl ${h.iconBg} flex items-center justify-center flex-shrink-0 shadow-md`,children:e.jsx(a,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0 relative z-10",children:[e.jsx("p",{className:"text-[15px] font-bold text-slate-900 dark:text-slate-100 leading-tight",children:c.title}),e.jsx("p",{className:"text-[13px] text-slate-500 dark:text-slate-400 mt-0.5 line-clamp-1",children:c.description})]}),e.jsx("div",{className:"relative z-10 w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center group-hover:bg-slate-200 dark:group-hover:bg-slate-600 transition-colors flex-shrink-0",children:e.jsx(ae,{className:"w-4 h-4 text-slate-500 dark:text-slate-400 group-hover:translate-x-0.5 transition-transform"})})]},c.id)})}),e.jsx("div",{className:"mt-5 pt-4 border-t border-slate-100 dark:border-slate-800 relative z-10",children:e.jsx("p",{className:"text-[12px] text-slate-400 dark:text-slate-500 text-center",children:"ðŸ’¡ Completa queste azioni per migliorare il tuo punteggio"})})]})}const Ue={score:{label:"Punteggio",unit:"punti",icon:M},accuracy:{label:"Accuratezza",unit:"%",icon:K},attempts:{label:"Simulazioni",unit:"",icon:J}};function Ve({goal:t,onCreateGoal:u,onDeleteGoal:b}){if(!t)return e.jsxs("div",{className:"bg-[var(--card)] rounded-card shadow-soft p-6 border border-[var(--card-border)]",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-[var(--foreground)]",children:"Il tuo obiettivo"}),e.jsx("div",{className:"w-10 h-10 rounded-squircle bg-brand-cyan/10 flex items-center justify-center",children:e.jsx(J,{className:"w-5 h-5 text-brand-cyan"})})]}),e.jsxs("div",{className:"text-center py-8 bg-slate-50 dark:bg-slate-900/50 rounded-2xl border border-dashed border-slate-200 dark:border-slate-800",children:[e.jsx("div",{className:"w-14 h-14 rounded-full bg-[var(--card)] shadow-sm flex items-center justify-center mx-auto mb-3",children:e.jsx(M,{className:"w-6 h-6 text-[var(--foreground)] opacity-30"})}),e.jsx("p",{className:"text-sm font-medium text-[var(--foreground)] opacity-50 mb-4",children:"Imposta un obiettivo per rimanere motivato"}),e.jsx("button",{onClick:u,className:"px-6 py-2.5 bg-brand-cyan text-white font-bold text-sm rounded-pill hover:bg-brand-cyan/90 active:scale-95 transition-all shadow-sm",children:"Imposta obiettivo"})]})]});const n=Ue[t.goal_type],c=n.icon,i=Math.min(t.current_value/t.target_value*100,100),h=t.deadline?Math.max(0,Math.ceil((new Date(t.deadline).getTime()-Date.now())/(1e3*60*60*24))):null,a={active:{label:"In corso",color:"text-brand-cyan bg-brand-cyan/10"},achieved:{label:"Raggiunto! ðŸŽ‰",color:"text-emerald-500 bg-emerald-500/10"},failed:{label:"Non raggiunto",color:"text-rose-500 bg-rose-500/10"},expired:{label:"Scaduto",color:"text-[var(--foreground)] opacity-40 bg-slate-100 dark:bg-slate-800"}},f=i>=100?"achieved":h!==null&&h<=3&&i<80?"at-risk":i>=60?"on-track":"behind",r={achieved:"Obiettivo raggiunto!","on-track":"Sei sulla buona strada",behind:"Devi accelerare","at-risk":"Obiettivo a rischio"};return e.jsxs("div",{className:"bg-[var(--card)] rounded-card shadow-soft p-6 border border-[var(--card-border)]",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-[var(--foreground)]",children:"Il tuo obiettivo"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-2.5 py-1 rounded-pill text-[10px] font-bold uppercase tracking-wide ${a[t.status].color}`,children:a[t.status].label}),b&&t.status==="active"&&e.jsx("button",{onClick:()=>b(t.id),className:"p-1.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors",children:e.jsx(Y,{className:"w-4 h-4 text-[var(--foreground)] opacity-40"})})]})]}),e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl bg-brand-cyan/10 flex items-center justify-center",children:e.jsx(c,{className:"w-6 h-6 text-brand-cyan"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-[var(--foreground)] opacity-50",children:n.label}),e.jsxs("p",{className:"text-2xl font-black text-[var(--foreground)]",children:[t.current_value.toFixed(0),e.jsxs("span",{className:"opacity-30",children:["/",t.target_value.toFixed(0)]}),e.jsx("span",{className:"text-sm font-bold opacity-30 ml-1",children:n.unit})]})]})]}),e.jsx("div",{className:"mb-3",children:e.jsx("div",{className:"h-3 bg-slate-100 dark:bg-slate-800 rounded-pill overflow-hidden",children:e.jsx("div",{className:`h-full rounded-pill transition-all duration-500 ${i>=100?"bg-emerald-500":f==="at-risk"?"bg-rose-500":f==="behind"?"bg-amber-500":"bg-brand-cyan"}`,style:{width:`${i}%`}})})}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:`font-bold ${f==="achieved"?"text-emerald-500":f==="at-risk"?"text-rose-500":f==="behind"?"text-amber-500":"text-[var(--foreground)] opacity-50"}`,children:r[f]}),h!==null&&e.jsxs("span",{className:"text-[var(--foreground)] opacity-30 flex items-center gap-1",children:[e.jsx(de,{className:"w-3 h-3"}),h===0?"Scade oggi":`${h} giorni rimasti`]})]})]})}function Xe({subject:t,quizId:u,onClose:b,onPractice:n,onReviewErrors:c}){if(!t)return null;const i=t.trend==="improving"?K:t.trend==="declining"?Me:Pe,h=t.trend==="improving"?"text-emerald-500":t.trend==="declining"?"text-rose-500":"text-[var(--foreground)] opacity-30",f={good:{label:"Buono",color:"bg-emerald-500",bgColor:"bg-emerald-500/10",textColor:"text-emerald-500"},warning:{label:"Da migliorare",color:"bg-amber-500",bgColor:"bg-amber-500/10",textColor:"text-amber-500"},critical:{label:"Critico",color:"bg-rose-500",bgColor:"bg-rose-500/10",textColor:"text-rose-500"}}[t.status],r=t.totalQuestions-t.correctAnswers,l=()=>{n?n(t.subjectId):window.location.href=`/quiz/${u}/practice?subject=${t.subjectId}`},s=()=>{c?c(t.subjectId):window.location.href=`/quiz/${u}/review?subject=${t.subjectId}`};return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-end justify-center sm:items-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40 backdrop-blur-sm",onClick:b}),e.jsxs("div",{className:"relative bg-[var(--card)] w-full max-w-lg rounded-t-3xl sm:rounded-3xl shadow-2xl max-h-[85vh] overflow-auto animate-in slide-in-from-bottom-4 duration-300 border-t sm:border border-[var(--card-border)]",children:[e.jsx("div",{className:"flex justify-center pt-3 pb-2 sm:hidden",children:e.jsx("div",{className:"w-10 h-1 bg-slate-200 dark:bg-slate-700 rounded-full"})}),e.jsxs("div",{className:"sticky top-0 bg-[var(--card)] px-6 py-4 border-b border-[var(--card-border)] flex items-center justify-between z-10",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${f.color}`}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-[var(--foreground)]",children:t.subjectName}),e.jsx("p",{className:"text-xs text-[var(--foreground)] opacity-40",children:"Analisi dettagliata"})]})]}),e.jsx("button",{onClick:b,className:"p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors",children:e.jsx(Y,{className:"w-5 h-5 text-[var(--foreground)] opacity-40"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-900/50 rounded-2xl p-4 border border-slate-100 dark:border-slate-800",children:[e.jsx("p",{className:"text-[10px] font-bold text-[var(--foreground)] opacity-40 uppercase tracking-widest mb-1",children:"Accuratezza"}),e.jsxs("p",{className:`text-3xl font-black ${f.textColor}`,children:[t.accuracy.toFixed(0),"%"]}),e.jsxs("div",{className:`flex items-center gap-1 mt-1 text-xs font-bold ${h}`,children:[e.jsx(i,{className:"w-3 h-3"}),e.jsx("span",{children:t.trend==="improving"?"In miglioramento":t.trend==="declining"?"In calo":"Stabile"})]})]}),e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-900/50 rounded-2xl p-4 border border-slate-100 dark:border-slate-800",children:[e.jsx("p",{className:"text-[10px] font-bold text-[var(--foreground)] opacity-40 uppercase tracking-widest mb-1",children:"Domande"}),e.jsx("p",{className:"text-3xl font-black text-[var(--foreground)]",children:t.totalQuestions}),e.jsxs("p",{className:"text-xs text-[var(--foreground)] opacity-40 mt-1",children:[t.correctAnswers," corrette Â· ",r," sbagliate"]})]})]}),e.jsxs("div",{className:`${f.bgColor} rounded-2xl p-4 flex items-center gap-3 border border-current opacity-90`,children:[e.jsx("div",{className:`w-10 h-10 rounded-xl ${f.color} flex items-center justify-center shadow-lg shadow-current/10`,children:e.jsx("span",{className:"text-white text-lg",children:t.status==="good"?"âœ“":t.status==="warning"?"!":"âœ—"})}),e.jsxs("div",{children:[e.jsxs("p",{className:`text-sm font-bold ${f.textColor}`,children:["Stato: ",f.label]}),e.jsx("p",{className:"text-xs text-[var(--foreground)] opacity-50",children:t.status==="good"?"Ottimo lavoro! Continua cosÃ¬.":t.status==="warning"?"Qualche errore di troppo. Ripassa questa materia.":"Attenzione! Questa materia richiede studio intensivo."})]})]}),t.avgResponseTimeMs&&e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-900/50 rounded-2xl p-4 border border-slate-100 dark:border-slate-800",children:[e.jsx("p",{className:"text-[10px] font-bold text-[var(--foreground)] opacity-40 uppercase tracking-widest mb-1",children:"Tempo medio per risposta"}),e.jsxs("p",{className:"text-2xl font-black text-[var(--foreground)]",children:[(t.avgResponseTimeMs/1e3).toFixed(1),"s"]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-[10px] font-bold text-[var(--foreground)] opacity-40 uppercase tracking-widest",children:"Azioni consigliate"}),r>0&&e.jsxs("button",{onClick:s,className:"w-full flex items-center gap-4 p-4 rounded-2xl border border-amber-100 dark:border-amber-900/30 bg-amber-50 dark:bg-amber-900/10 hover:bg-amber-100/50 dark:hover:bg-amber-900/20 transition-all text-left group",children:[e.jsx("div",{className:"w-11 h-11 rounded-xl bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 flex items-center justify-center flex-shrink-0",children:e.jsx(Ae,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"text-sm font-bold text-[var(--foreground)]",children:["Ripassa ",r," errori"]}),e.jsx("p",{className:"text-xs text-[var(--foreground)] opacity-40",children:"Rivedi le domande sbagliate"})]}),e.jsx(ae,{className:"w-5 h-5 text-[var(--foreground)] opacity-20 group-hover:opacity-100 group-hover:translate-x-0.5 transition-all"})]}),e.jsxs("button",{onClick:l,className:"w-full flex items-center gap-4 p-4 rounded-2xl border border-brand-cyan/20 bg-brand-cyan/5 dark:bg-brand-cyan/10 hover:bg-brand-cyan/10 dark:hover:bg-brand-cyan/20 transition-all text-left group",children:[e.jsx("div",{className:"w-11 h-11 rounded-xl bg-brand-cyan/20 text-brand-cyan flex items-center justify-center flex-shrink-0",children:e.jsx(M,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-bold text-[var(--foreground)]",children:"Esercitati su questa materia"}),e.jsxs("p",{className:"text-xs text-[var(--foreground)] opacity-40",children:["Quiz focalizzato solo su ",t.subjectName]})]}),e.jsx(ae,{className:"w-5 h-5 text-[var(--foreground)] opacity-20 group-hover:opacity-100 group-hover:translate-x-0.5 transition-all"})]})]})]})]})]})}const ie=[{value:"score",label:"Punteggio",description:"Raggiungi un punteggio target",icon:M,unit:"punti",placeholder:"75",min:0,max:100},{value:"accuracy",label:"Accuratezza",description:"Mantieni una percentuale di risposte corrette",icon:K,unit:"%",placeholder:"80",min:0,max:100},{value:"attempts",label:"Simulazioni",description:"Completa un numero di simulazioni",icon:J,unit:"test",placeholder:"10",min:1,max:100}];function Ze({isOpen:t,quizId:u,onClose:b,onSubmit:n}){const[c,i]=x.useState("score"),[h,a]=x.useState(""),[f,r]=x.useState(""),[l,s]=x.useState(!1),[g,m]=x.useState(""),j=ie.find(p=>p.value===c),$=async p=>{p.preventDefault(),m("");const w=parseFloat(h);if(isNaN(w)||w<j.min||w>j.max){m(`Inserisci un valore tra ${j.min} e ${j.max}`);return}s(!0);try{await n({goal_type:c,target_value:w,deadline:f||null}),b()}catch{m("Errore nel salvare l'obiettivo. Riprova.")}finally{s(!1)}};return t?e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:b}),e.jsxs("div",{className:"relative bg-[var(--card)] w-full max-w-md rounded-3xl shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200 border border-[var(--card-border)]",children:[e.jsxs("div",{className:"px-6 py-5 border-b border-[var(--card-border)] flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-[var(--foreground)]",children:"Nuovo obiettivo"}),e.jsx("p",{className:"text-xs text-[var(--foreground)] opacity-50 mt-0.5",children:"Imposta un traguardo per restare motivato"})]}),e.jsx("button",{onClick:b,className:"p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors",children:e.jsx(Y,{className:"w-5 h-5 text-[var(--foreground)] opacity-40"})})]}),e.jsxs("form",{onSubmit:$,className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold text-[var(--foreground)] opacity-40 uppercase tracking-widest block mb-3",children:"Tipo di obiettivo"}),e.jsx("div",{className:"space-y-2",children:ie.map(p=>{const w=p.icon,y=c===p.value;return e.jsxs("button",{type:"button",onClick:()=>{i(p.value),a("")},className:`w-full flex items-center gap-4 p-4 rounded-2xl border transition-all ${y?"border-brand-cyan bg-brand-cyan/5 dark:bg-brand-cyan/10":"border-slate-100 dark:border-slate-800 hover:border-slate-200 dark:hover:border-slate-700 bg-[var(--card)]"}`,children:[e.jsx("div",{className:`w-10 h-10 rounded-xl flex items-center justify-center ${y?"bg-brand-cyan text-white":"bg-slate-100 dark:bg-slate-800 text-[var(--foreground)] opacity-40"}`,children:e.jsx(w,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:`text-sm font-bold ${y?"text-brand-cyan":"text-[var(--foreground)]"}`,children:p.label}),e.jsx("p",{className:"text-xs text-[var(--foreground)] opacity-50",children:p.description})]}),e.jsx("div",{className:`w-5 h-5 rounded-full border-2 flex items-center justify-center ${y?"border-brand-cyan":"border-slate-200 dark:border-slate-700"}`,children:y&&e.jsx("div",{className:"w-2.5 h-2.5 rounded-full bg-brand-cyan"})})]},p.value)})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold text-[var(--foreground)] opacity-40 uppercase tracking-widest block mb-2",children:"Valore target"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",value:h,onChange:p=>a(p.target.value),placeholder:j.placeholder,min:j.min,max:j.max,className:"w-full px-4 py-3 pr-16 rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 focus:border-brand-cyan dark:focus:border-brand-cyan focus:ring-2 focus:ring-brand-cyan/20 outline-none text-[var(--foreground)] font-bold text-lg transition-all",required:!0}),e.jsx("span",{className:"absolute right-4 top-1/2 -translate-y-1/2 text-[var(--foreground)] opacity-40 font-bold",children:j.unit})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold text-[var(--foreground)] opacity-40 uppercase tracking-widest block mb-2",children:"Scadenza (opzionale)"}),e.jsxs("div",{className:"relative",children:[e.jsx(de,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--foreground)] opacity-40"}),e.jsx("input",{type:"date",value:f,onChange:p=>r(p.target.value),min:new Date().toISOString().split("T")[0],className:"w-full pl-12 pr-4 py-3 rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 focus:border-brand-cyan dark:focus:border-brand-cyan focus:ring-2 focus:ring-brand-cyan/20 outline-none text-[var(--foreground)] font-medium transition-all"})]})]}),g&&e.jsx("p",{className:"text-sm text-semantic-error bg-semantic-error/10 px-4 py-2 rounded-xl",children:g}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{type:"button",onClick:b,className:"flex-1 py-3 px-4 rounded-xl border border-slate-200 dark:border-slate-800 font-bold text-[var(--foreground)] opacity-60 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors",children:"Annulla"}),e.jsx("button",{type:"submit",disabled:l||!h,className:"flex-1 py-3 px-4 rounded-xl bg-brand-cyan text-white font-bold hover:bg-brand-cyan/90 disabled:opacity-50 disabled:cursor-not-allowed transition-all",children:l?"Salvataggio...":"Salva obiettivo"})]})]})]})]}):null}function lt(){const{quizId:t}=we(),u=Z(),[b,n]=x.useState(!0),[c,i]=x.useState([]),[h,a]=x.useState(!1),[f,r]=x.useState(!1),[l,s]=x.useState(null),[g,m]=x.useState(null),[j,$]=x.useState(null),[p,w]=x.useState({totalTests:0,avgScore:0,avgAccuracy:0,bestScore:0,maxPossibleScore:100}),[y,A]=x.useState([]),[W,E]=x.useState(null),[P,R]=x.useState(!1),[H,o]=x.useState(null),[k,F]=x.useState([]),[B,xe]=x.useState([]),[ue,me]=x.useState([]),[be,ge]=x.useState("Statistiche Corso"),{startOnboarding:re,hasCompletedContext:se}=Se();x.useEffect(()=>{t&&pe()},[t]),x.useEffect(()=>{if(!b&&p.totalTests>0&&!se("quizstats")){const d=setTimeout(()=>re("quizstats"),600);return()=>clearTimeout(d)}},[b,p.totalTests,se,re]);const pe=async()=>{n(!0);const{data:{user:d}}=await I.auth.getUser();if(!d){u("/login");return}try{const[S,T,C,L]=await Promise.all([I.from("quizzes").select("title, total_questions, points_correct, rule_id, simulation_rule:simulation_rules(total_questions, points_correct)").eq("id",t).single(),I.from("quiz_attempts").select("*, quiz:quizzes(title), mode").eq("user_id",d.id).eq("quiz_id",t).order("created_at",{ascending:!1}),I.from("test_goals").select("*").eq("user_id",d.id).eq("quiz_id",t).eq("status","active").maybeSingle(),I.from("concorso_leaderboard").select("score, volume_factor, accuracy_weighted, recency_score, coverage_score, reliability").eq("user_id",d.id).eq("quiz_id",t).maybeSingle()]),N=S.data,q=T.data,U=T.error,G=C.data,V=L.data;let z=0;if(N){ge(N.title);const _=N.simulation_rule;_&&_.total_questions&&_.points_correct&&(z=_.total_questions*_.points_correct),z===0&&N.total_questions&&N.points_correct&&(z=N.total_questions*N.points_correct)}if(!(N!=null&&N.rule_id)&&q&&q.length>0){const _=Math.max(...q.map(Q=>Q.total_questions||0));if(_>0){const Q=(N==null?void 0:N.points_correct)||1;z=_*Q}}z===0&&(z=100),U?console.error(U):q&&he(q,z,V),G&&E(G)}catch(S){console.error("Error loading stats:",S)}finally{n(!1)}},he=(d,S,T)=>{i(d);const C=d.length,L=d.reduce((v,D)=>v+(D.score||0),0),N=d.reduce((v,D)=>Math.max(v,D.score||0),0);let q=0;const U=d.reduce((v,D)=>D.total_questions?(q++,v+(D.correct||0)/D.total_questions):v,0),G=C?L/C:0,V=q?U/q*100:0;if(w({totalTests:C,avgScore:G,avgAccuracy:V,bestScore:N,maxPossibleScore:S}),C>=3){const v=Ce(d,7);s(v.scoreTrend),m(v.accuracyTrend)}if(C>=1){const v=ze(G,V,C,T);$(v)}const z=$e(d);F(z);const _=z.map(v=>({subject:v.subjectName,accuracy:v.accuracy,total:v.totalQuestions}));xe(_);const Q=Te(d,z,t||"");A(Q);const je=[...d].reverse().map(v=>{const D=v.total_questions>0?v.correct/v.total_questions*100:0;return{id:v.id,date:new Date(v.created_at).toLocaleDateString(),fullDate:new Date(v.created_at),score:v.score||0,accuracy:D}});me(je)},oe=()=>{R(!0)},fe=async d=>{const{data:{user:S}}=await I.auth.getUser();if(!S)return;const{data:T,error:C}=await I.from("test_goals").insert({user_id:S.id,quiz_id:t,goal_type:d.goal_type,target_value:d.target_value,deadline:d.deadline,status:"active"}).select().single();!C&&T&&(E(T),R(!1))},ve=async d=>{const{error:S}=await I.from("test_goals").delete().eq("id",d);S||E(null)};return b?e.jsx(ke,{message:"Analisi performance in corso..."}):e.jsxs("div",{className:"min-h-screen bg-[var(--background)] text-text-primary pb-24 relative overflow-hidden transition-colors duration-300",children:[e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6 px-4 md:px-8 pt-safe",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4 py-4",children:[e.jsx("button",{onClick:()=>u("/profile"),className:"p-3 bg-white dark:bg-slate-800/50 rounded-full shadow-soft hover:shadow-card hover:scale-105 transition-all text-slate-400 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white border border-transparent hover:border-slate-100 dark:hover:border-slate-700",children:e.jsx(Re,{className:"w-6 h-6"})}),e.jsxs("div",{className:"flex-1 text-center",children:[e.jsx("h1",{className:"text-xl font-black text-text-primary leading-tight line-clamp-1",children:be}),e.jsx("p",{className:"text-[10px] font-bold text-text-tertiary uppercase tracking-wider mt-0.5",children:"Statistiche Dettagliate"})]}),e.jsx("div",{className:"w-12"})," "]}),e.jsx(Le,{totalTests:p.totalTests,bestScore:p.bestScore,avgScore:p.avgScore,accuracy:p.avgAccuracy,maxPossibleScore:p.maxPossibleScore,scoreTrend:l,accuracyTrend:g,readiness:j,onOpenInfo:()=>a(!0)}),y.length>0&&e.jsx("div",{"data-onboarding":"stats-coaching",children:e.jsx(He,{recommendations:y,onSetGoal:oe})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-8",children:[e.jsxs("div",{className:"lg:col-span-5 space-y-6",children:[e.jsxs("div",{"data-onboarding":"stats-subjects",className:"bg-white dark:bg-[var(--card)] p-6 rounded-card shadow-soft flex flex-col items-center",children:[e.jsx("h3",{className:"text-lg font-bold text-text-primary mb-6 w-full",children:"Performance per Materia"}),e.jsx(Oe,{data:B}),e.jsxs("div",{className:"mt-8 w-full",children:[e.jsx("h4",{className:"text-[10px] font-bold text-text-tertiary uppercase tracking-widest mb-3",children:"Dettaglio Materie"}),e.jsx("div",{className:"space-y-3 max-h-60 overflow-y-auto pr-2 scrollbar-thin",children:B.map((d,S)=>{const T=d.accuracy>=70?"good":d.accuracy>=50?"warning":"critical",C=T==="good"?"bg-semantic-success":T==="warning"?"bg-brand-orange":"bg-semantic-error",L=k[S];return e.jsxs("button",{onClick:()=>L&&o(L),className:"w-full flex justify-between items-center text-sm border-b border-canvas-light dark:border-slate-800 pb-2 group cursor-pointer hover:bg-canvas-light/50 dark:hover:bg-slate-800/50 -mx-2 px-2 rounded-lg transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${C}`}),e.jsx("span",{className:"font-bold text-text-secondary dark:text-slate-400 truncate max-w-[120px]",title:d.subject,children:d.subject})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-text-tertiary",children:["(",d.total,")"]}),e.jsxs("span",{className:`font-black ${d.accuracy>70?"text-semantic-success":d.accuracy>50?"text-brand-orange":"text-semantic-error"}`,children:[d.accuracy.toFixed(0),"%"]})]})]},d.subject)})})]})]}),e.jsx(Ve,{goal:W,onCreateGoal:oe,onDeleteGoal:ve})]}),e.jsxs("div",{className:"lg:col-span-7 space-y-8",children:[e.jsxs("div",{className:"bg-white dark:bg-[var(--card)] p-6 rounded-card shadow-soft",children:[e.jsx("h3",{className:"text-lg font-bold text-text-primary mb-4",children:"Andamento nel Tempo"}),e.jsx(Qe,{data:ue})]}),e.jsxs("div",{className:"bg-white dark:bg-[var(--card)] p-6 rounded-card shadow-soft",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-text-primary",children:"Cronologia Tentativi"}),e.jsx("span",{className:"text-[10px] font-bold bg-canvas-light dark:bg-slate-800 text-text-tertiary px-3 py-1.5 rounded-pill uppercase tracking-wider",children:"Ultimi 50"})]}),e.jsx(Ge,{attempts:c,quizId:t})]})]})]})]}),e.jsx(Xe,{subject:H,quizId:t||"",onClose:()=>o(null)}),e.jsx(Ze,{isOpen:P,quizId:t||"",onClose:()=>R(!1),onSubmit:fe})]})}export{lt as default};
