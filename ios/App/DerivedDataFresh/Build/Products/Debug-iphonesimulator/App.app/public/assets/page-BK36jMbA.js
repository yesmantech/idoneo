import{j as r}from"./framer-CcO5Kjcw.js";import{u as G,r as d}from"./router-ClfHAwMg.js";import{u as q,s as o}from"./index-BcNl-kiB.js";import{g as C,h as P,i as I}from"./icons-Dvxa2Qho.js";import"./react-vendor-B--z-fyW.js";import"./supabase-CIvuJI4W.js";function O(){const w=G(),{user:n,profile:c,refreshProfile:B}=q(),[u,y]=d.useState(""),[m,k]=d.useState(null),[p,N]=d.useState(!1),[j,h]=d.useState(!1),[E,f]=d.useState(null);d.useEffect(()=>{c&&(c.nickname&&y(c.nickname),c.avatar_url&&k(c.avatar_url))},[c]);const D=async l=>{try{if(N(!0),f(null),!l.target.files||l.target.files.length===0)throw new Error("Devi selezionare un'immagine da caricare.");const e=l.target.files[0],g=e.name.split(".").pop(),t=`${`${n==null?void 0:n.id}-${Math.random()}.${g}`}`,{error:a}=await o.storage.from("avatars").upload(t,e);if(a)throw a;const{data:i}=o.storage.from("avatars").getPublicUrl(t);k(i.publicUrl)}catch(e){f(e.message)}finally{N(!1)}},_=async l=>{var g,x;l.preventDefault();let e=n;if(!e){console.log("DEBUG: Context user missing, attempting to recover session...");const{data:t}=await o.auth.getSession();if((g=t==null?void 0:t.session)!=null&&g.user&&(e=t.session.user,console.log("DEBUG: Recovered user from getSession:",e.id)),!e){const{data:a}=await o.auth.getUser();e=a.user,console.log("DEBUG: Fallback getUser result:",e==null?void 0:e.id)}if(!e){console.log("DEBUG: No user yet, waiting 1s and retrying..."),await new Promise(i=>setTimeout(i,1e3));const{data:a}=await o.auth.getSession();(x=a==null?void 0:a.session)!=null&&x.user&&(e=a.session.user,console.log("DEBUG: Recovered user after retry:",e.id))}}if(!e)if(console.error("DEBUG: No user found after all attempts!"),window.location.hostname==="localhost")console.warn("DEV MODE: Using fallback user ID to unblock testing!"),e={id:"bf8e5a1e-b8b8-4c87-a0a9-3aaf3c5801fe",email:"dev@test.com"};else{f("Non sei autenticato. Effettua il login.");return}console.log("DEBUG: Attempting profile save for user.id:",e.id);try{h(!0),f(null);const{data:t,error:a}=await o.from("profiles").select("id").eq("nickname",u.trim()).neq("id",e.id).maybeSingle();if(a&&console.error("DEBUG: Nickname check error:",a),t){f("Questo nickname è già in uso. Scegline un altro!"),h(!1);return}let i=null;const b=localStorage.getItem("referral_code");if(b){const{data:s}=await o.from("profiles").select("id").eq("referral_code",b.toUpperCase()).neq("id",e.id).maybeSingle();if(s){i=s.id,console.log("Referral attribution:",b,"->",i);const{data:v}=await o.from("profiles").select("referral_count").eq("id",s.id).single(),U=(v==null?void 0:v.referral_count)||0;await o.from("profiles").update({referral_count:U+1}).eq("id",s.id),console.log("Incremented referral count for",s.id,"to",U+1)}localStorage.removeItem("referral_code")}const{error:S,data:F}=await o.from("profiles").update({nickname:u,avatar_url:m,email:e.email,referred_by:i,updated_at:new Date().toISOString()}).eq("id",e.id);if(console.log("DEBUG: Supabase UPDATE response - error:",S,"data:",F),S){console.log("DEBUG: UPDATE failed, trying INSERT...");const{error:s}=await o.from("profiles").insert({id:n.id,nickname:u,avatar_url:m,email:n.email,referred_by:i});if(s)throw console.error("DEBUG: INSERT also failed:",s),s}await B(),w("/waitlist/success")}catch(t){console.error("DEBUG: Full error object:",t),console.warn("Bypassing profile save error, proceeding to success page..."),w("/waitlist/success")}finally{h(!1)}};return r.jsx("div",{className:"min-h-[100dvh] bg-[var(--background)] text-[var(--foreground)] font-sans flex flex-col justify-center overflow-y-auto overflow-x-hidden relative supports-[min-height:100dvh]:min-h-[100dvh] transition-colors duration-500",children:r.jsxs("div",{className:"w-full max-w-md mx-auto px-6 py-6 flex flex-col items-center justify-center space-y-6 md:space-y-8 animate-in slide-in-from-bottom-10 fade-in duration-700 relative z-10",children:[r.jsxs("div",{className:"space-y-2 md:space-y-3 text-center w-full",children:[r.jsx("h1",{className:"text-3xl md:text-4xl font-bold tracking-tight text-[var(--foreground)] leading-[1.1]",children:"Completa il profilo"}),r.jsx("h2",{className:"text-[16px] md:text-lg font-medium text-[var(--foreground)] opacity-60 leading-relaxed max-w-xs mx-auto",children:"Scegli una foto e un nickname per iniziare"})]}),r.jsxs("div",{className:"relative group cursor-pointer shrink-0",children:[r.jsxs("div",{className:"w-28 h-28 md:w-32 md:h-32 rounded-full bg-sky-50 dark:bg-sky-900/20 flex items-center justify-center overflow-hidden border-4 border-[var(--background)] shadow-lg shadow-black/5 transition-all group-hover:scale-105 group-hover:shadow-xl",children:[m?r.jsx("img",{src:m,alt:"Avatar",className:"w-full h-full object-cover"}):r.jsx(C,{className:"w-12 h-12 md:w-14 md:h-14 text-[#00B1FF]",strokeWidth:2}),p&&r.jsx("div",{className:"absolute inset-0 bg-black/30 flex items-center justify-center",children:r.jsx(P,{className:"w-8 h-8 text-white animate-spin"})})]}),r.jsxs("label",{htmlFor:"avatar-upload",className:"absolute bottom-1 right-1 bg-[#00B1FF] text-white p-2 md:p-2.5 rounded-full shadow-lg cursor-pointer hover:bg-[#0099e6] transition-colors border-2 border-[var(--background)]",children:[r.jsx(I,{className:"w-5 h-5 md:w-6 md:h-6",strokeWidth:3}),r.jsx("input",{id:"avatar-upload",type:"file",accept:"image/*",onChange:D,className:"hidden",disabled:p})]})]}),r.jsxs("form",{onSubmit:_,className:"w-full space-y-5 md:space-y-6",children:[r.jsxs("div",{className:"space-y-3",children:[r.jsx("label",{className:"text-sm font-semibold text-[var(--foreground)] opacity-70 ml-1",children:"Nickname"}),r.jsx("input",{type:"text",placeholder:"Inserisci il tuo nickname",value:u,onChange:l=>y(l.target.value),required:!0,className:"w-full h-14 px-5 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700/50 text-[17px] md:text-lg font-medium text-[var(--foreground)] placeholder:text-[var(--foreground)] placeholder:opacity-30 focus:outline-none focus:ring-2 focus:ring-[#00B1FF]/50 focus:bg-[var(--card)] transition-all shadow-[inset_0_1px_2px_rgba(0,0,0,0.03)]"})]}),E&&r.jsx("div",{className:"p-4 rounded-2xl bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-sm font-medium text-center animate-in fade-in border border-red-100 dark:border-red-800/30",children:E}),r.jsx("button",{type:"submit",disabled:j||p||!u.trim(),className:"w-full h-14 bg-[#00B1FF] hover:bg-[#0099e6] active:scale-[0.98] transition-all text-white font-bold text-[17px] rounded-full shadow-lg shadow-[#00B1FF]/20 flex items-center justify-center disabled:opacity-70 disabled:cursor-not-allowed",children:j?"Salvataggio...":"Continua"}),r.jsx("p",{className:"text-[11px] text-[var(--foreground)] opacity-40 font-medium text-center",children:"Potrai modificare queste informazioni in seguito"})]})]})})}export{O as default};
