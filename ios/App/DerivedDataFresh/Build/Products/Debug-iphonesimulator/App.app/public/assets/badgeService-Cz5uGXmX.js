import{s as r}from"./index-DBMi1b3R.js";const f={async getUserBadges(e){const{data:a,error:t}=await r.from("user_badges").select("badge_id").eq("user_id",e);return t?(console.error("Error fetching user badges:",t),[]):a.map(o=>o.badge_id)},async awardBadge(e,a){try{const{error:t}=await r.from("user_badges").upsert({user_id:e,badge_id:a},{onConflict:"user_id, badge_id"});t&&t.code!=="42501"&&console.warn(`Badge award skipped for ${a}:`,t.message)}catch{}},async checkAndAwardBadges(e){try{console.log("Badge Check: Starting for user",e);const{data:a,error:t}=await r.from("profiles").select("total_xp, referral_count, current_streak").eq("id",e).single();if(t){console.error("Badge Check: Profile Fetch Error",t);return}if(!a){console.warn("Badge Check: No profile found for",e);return}console.log("Badge Check: Data fetched",a),console.log("Badge Check: Total XP:",a.total_xp),console.log("Badge Check: Current Streak:",a.current_streak),(a.total_xp||0)>=1e3&&(console.log("Badge Check: Awarding veterano"),await this.awardBadge(e,"veterano")),(a.referral_count||0)>=5&&(console.log("Badge Check: Awarding social"),await this.awardBadge(e,"social")),(a.current_streak||0)>=7&&(console.log("Badge Check: Awarding costanza"),await this.awardBadge(e,"costanza")),(a.current_streak||0)>=30&&(console.log("Badge Check: Awarding inarrestabile"),await this.awardBadge(e,"inarrestabile"));const{data:o}=await r.from("quiz_attempts").select("quiz_id").eq("user_id",e);new Set(o==null?void 0:o.map(s=>s.quiz_id)).size>=5&&(console.log("Badge Check: Awarding hub_master"),await this.awardBadge(e,"hub_master"));const{data:i}=await r.from("quiz_attempts").select("created_at").eq("user_id",e);((i==null?void 0:i.filter(s=>{const n=new Date(s.created_at).getHours();return n>=1&&n<5}).length)||0)>=5&&(console.log("Badge Check: Awarding nottambulo"),await this.awardBadge(e,"nottambulo"));const{data:d}=await r.from("quiz_attempts").select("id").eq("user_id",e).filter("correct","eq","total_questions").gt("total_questions",9).limit(1).maybeSingle();d&&(console.log("Badge Check: Awarding secchione"),await this.awardBadge(e,"secchione"));const{count:c}=await r.from("quiz_attempts").select("*",{count:"exact",head:!0}).eq("user_id",e);c&&c>0&&(console.log("Badge Check: Awarding primo_passo"),await this.awardBadge(e,"primo_passo"))}catch(a){console.error("Error checking badges:",a)}}};export{f as b};
