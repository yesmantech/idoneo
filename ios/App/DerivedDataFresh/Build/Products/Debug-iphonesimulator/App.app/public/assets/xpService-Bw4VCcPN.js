import{s as o}from"./index-BcNl-kiB.js";const _={async getActiveSeasonId(){const{data:e,error:t}=await o.from("leaderboard_seasons").select("id").eq("is_active",!0).lte("start_at",new Date().toISOString()).or(`end_at.is.null,end_at.gte.${new Date().toISOString()}`).order("start_at",{ascending:!1}).limit(1).single();return t||!e?null:e.id},async awardXpForAttempt(e,t){const{data:a,error:i}=await o.from("quiz_attempts").select("answers, xp_awarded, correct").eq("id",e).eq("user_id",t).single();if(i||!a)return console.error("XP: Failed to fetch attempt",i),0;if(a.xp_awarded)return console.warn("XP: Already awarded for this attempt."),0;let r=a.correct||0;if(r===0&&Array.isArray(a.answers)&&(r=a.answers.filter(n=>n.isCorrect).length),r<=0)return await o.from("quiz_attempts").update({xp_awarded:!0}).eq("id",e),0;const{error:s}=await o.from("xp_events").insert({user_id:t,xp_amount:r,source_type:"attempt_completion",attempt_id:e});if(s)return console.error("XP: Failed to insert event",s),0;const{error:p}=await o.rpc("increment_profile_xp",{p_user_id:t,p_amount:r});p&&console.error("XP: Failed to increment profile XP",p);const c=await this.getActiveSeasonId();if(c){const{error:n}=await o.rpc("upsert_user_xp",{p_user_id:t,p_season_id:c,p_amount:r});n&&console.error("XP: Failed to upsert seasonal XP",n)}return await o.from("quiz_attempts").update({xp_awarded:!0}).eq("id",e),r},async getUserXp(e){const{data:t}=await o.from("profiles").select("total_xp").eq("id",e).single(),a=(t==null?void 0:t.total_xp)||0;let i=0;const r=await this.getActiveSeasonId();if(r){const{data:l}=await o.from("user_xp").select("xp").eq("user_id",e).eq("season_id",r).single();i=(l==null?void 0:l.xp)||0}const s=Math.floor(a/100)+1,p=s*100,c=(s-1)*100,n=Math.min(100,Math.max(0,(a-c)/(p-c)*100));return{totalXp:a,seasonXp:i,currentLevel:s,nextLevelProgress:Math.round(n)}}};export{_ as x};
