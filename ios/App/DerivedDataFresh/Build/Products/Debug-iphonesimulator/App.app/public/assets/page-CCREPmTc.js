import{j as e}from"./framer-BdaCTGm4.js";import{a as V,u as H,r}from"./router-ClfHAwMg.js";import{s as d}from"./index-DBMi1b3R.js";import{A as h}from"./AdminLayout-Bws632pn.js";import{A as J}from"./AdminPageHeader-CVyPYYOb.js";import{t as X,a1 as K,h as g,r as Y,o as Z,I as ee,J as se,a9 as te,a5 as D,q as I,a8 as ae}from"./icons-DIoLbN6D.js";import"./react-vendor-B--z-fyW.js";import"./supabase-CIvuJI4W.js";function me(){const[P]=V(),j=H(),l=P.get("quiz"),[f,E]=r.useState(null),[M,p]=r.useState(!0),[m,x]=r.useState(!1),[v,N]=r.useState(60),[w,k]=r.useState(1),[y,_]=r.useState(-.25),[q,z]=r.useState(0),[S,C]=r.useState(!1),[F,O]=r.useState([]),[i,b]=r.useState([]),[R,Q]=r.useState({});r.useEffect(()=>{l?B():p(!1)},[l]);const B=async()=>{p(!0);try{const{data:s,error:a}=await d.from("quizzes").select("*").eq("id",l).single();if(a||!s){alert("Quiz non trovato"),j("/admin/quiz");return}E(s),N(s.time_limit||60),k(s.points_correct??1),_(s.points_wrong??-.25),z(s.points_blank??0),C(s.is_official||!1);const{data:o}=await d.from("subjects").select("*").eq("quiz_id",l).eq("is_archived",!1);O(o||[]);const{data:n}=await d.from("quiz_subject_rules").select("*").eq("quiz_id",l);if(n&&b(n.map(t=>({id:t.id,subject_id:t.subject_id,question_count:t.question_count}))),o){const t={};for(const c of o){const{count:u}=await d.from("questions").select("id",{count:"exact",head:!0}).eq("subject_id",c.id).eq("is_archived",!1);t[c.id]=u||0}Q(t)}}catch(s){console.error(s)}finally{p(!1)}},T=async()=>{if(l){x(!0);try{const{error:s}=await d.from("quizzes").update({time_limit:v,points_correct:w,points_wrong:y,points_blank:q,is_official:S}).eq("id",l);if(s)throw s;alert("Impostazioni salvate!")}catch(s){alert(s.message)}finally{x(!1)}}},U=s=>{i.find(a=>a.subject_id===s)||b([...i,{subject_id:s,question_count:10}])},W=s=>{const a=[...i];a.splice(s,1),b(a)},$=(s,a)=>{const o=[...i];o[s].question_count=a,b(o)},G=async()=>{if(l){x(!0);try{const{data:s}=await d.from("quiz_subject_rules").select("id").eq("quiz_id",l),a=(s==null?void 0:s.map(t=>t.id))||[],o=i.map(t=>t.id).filter(Boolean),n=a.filter(t=>!o.includes(t));n.length>0&&await d.from("quiz_subject_rules").delete().in("id",n);for(const t of i){const c={quiz_id:l,subject_id:t.subject_id,question_count:t.question_count};t.question_count<0||(t.id?await d.from("quiz_subject_rules").update(c).eq("id",t.id):await d.from("quiz_subject_rules").insert(c))}alert("Regole materie salvate!"),B()}catch(s){alert(s.message)}finally{x(!1)}}},L=F.filter(s=>!i.find(a=>a.subject_id===s.id)),A="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 text-[var(--foreground)] placeholder-[var(--foreground)]/30 focus:outline-none focus:ring-2 focus:ring-[#00B1FF]/30 focus:border-[#00B1FF] transition-all";return l?M?e.jsx(h,{children:e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx(g,{className:"w-8 h-8 text-[#00B1FF] animate-spin"})})}):e.jsxs(h,{children:[e.jsx(J,{title:`Regole: ${(f==null?void 0:f.title)||"Caricamento..."}`,subtitle:"Configura tempo, punteggi e distribuzione domande per materia",breadcrumb:[{label:"Quiz",path:"/admin/quiz"},{label:"Regole Simulazione"}]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-[var(--card)] rounded-[20px] border border-[var(--card-border)] shadow-sm overflow-hidden text-[var(--foreground)]",children:[e.jsxs("div",{className:"p-6 border-b border-[var(--card-border)] bg-slate-50/50 dark:bg-slate-900/50 flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-emerald-50 dark:bg-emerald-500/10 flex items-center justify-center",children:e.jsx(Y,{className:"w-5 h-5 text-emerald-500"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold",children:"Impostazioni Globali"}),e.jsx("p",{className:"text-sm opacity-40",children:"Tempo e punteggi"})]})]}),e.jsxs("div",{className:"p-6 space-y-6 bg-slate-50/30 dark:bg-slate-900/10",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium opacity-60 mb-1.5 flex items-center gap-2",children:[e.jsx(Z,{className:"w-4 h-4 opacity-40"}),"Durata (minuti)"]}),e.jsx("input",{type:"number",className:A,value:v,onChange:s=>N(Number(s.target.value))})]}),e.jsxs("div",{className:"bg-white dark:bg-slate-900 rounded-2xl p-5 border border-slate-100 dark:border-slate-800",children:[e.jsx("h4",{className:"text-sm font-bold opacity-60 mb-4",children:"Punteggi"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-emerald-600 dark:text-emerald-400 mb-1.5 flex items-center gap-1",children:[e.jsx(ee,{className:"w-3 h-3"})," Esatta"]}),e.jsx("input",{type:"number",step:"0.01",className:"w-full px-4 py-3 rounded-xl border-2 border-emerald-200 dark:border-emerald-500/20 bg-emerald-50 dark:bg-emerald-500/10 text-emerald-700 dark:text-emerald-400 font-bold text-center focus:outline-none focus:border-emerald-400 transition-all",value:w,onChange:s=>k(Number(s.target.value))})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-red-600 dark:text-rose-400 mb-1.5 flex items-center gap-1",children:[e.jsx(se,{className:"w-3 h-3"})," Errata"]}),e.jsx("input",{type:"number",step:"0.01",className:"w-full px-4 py-3 rounded-xl border-2 border-red-200 dark:border-rose-500/20 bg-red-50 dark:bg-rose-500/10 text-red-700 dark:text-rose-400 font-bold text-center focus:outline-none focus:border-red-400 transition-all",value:y,onChange:s=>_(Number(s.target.value))})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium opacity-40 mb-1.5 flex items-center gap-1",children:[e.jsx(te,{className:"w-3 h-3"})," Vuota"]}),e.jsx("input",{type:"number",step:"0.01",className:"w-full px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-[var(--foreground)] font-bold text-center focus:outline-none focus:border-slate-400 transition-all",value:q,onChange:s=>z(Number(s.target.value))})]})]})]}),e.jsx("div",{className:"bg-white dark:bg-slate-900 rounded-xl p-4 border border-slate-100 dark:border-slate-800",children:e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer select-none",children:[e.jsxs("div",{className:"relative flex items-center",children:[e.jsx("input",{type:"checkbox",checked:S,onChange:s=>C(s.target.checked),className:"peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-slate-300 dark:border-slate-700 transition-all checked:border-emerald-500 checked:bg-emerald-500"}),e.jsx("div",{className:"pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white opacity-0 peer-checked:opacity-100",children:e.jsx("svg",{className:"h-3.5 w-3.5",viewBox:"0 0 14 14",fill:"none",children:e.jsx("path",{d:"M11.6666 3.5L5.24992 9.91667L2.33325 7",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]}),e.jsx("span",{className:"text-sm font-medium opacity-60",children:"Simulazione Ufficiale"})]})}),e.jsxs("button",{onClick:T,disabled:m,className:"w-full py-3 bg-[#00B1FF] hover:bg-[#00a0e6] text-white font-bold rounded-xl shadow-lg shadow-blue-500/20 transition-all disabled:opacity-50 flex items-center justify-center gap-2",children:[m?e.jsx(g,{className:"w-4 h-4 animate-spin"}):e.jsx(D,{className:"w-4 h-4"}),"Salva Impostazioni"]})]})]}),e.jsxs("div",{className:"bg-[var(--card)] rounded-[20px] border border-[var(--card-border)] shadow-sm overflow-hidden flex flex-col text-[var(--foreground)]",children:[e.jsxs("div",{className:"p-6 border-b border-[var(--card-border)] bg-slate-50/50 dark:bg-slate-900/50 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-violet-50 dark:bg-violet-500/10 flex items-center justify-center",children:e.jsx(I,{className:"w-5 h-5 text-violet-500"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold",children:"Distribuzione Materie"}),e.jsx("p",{className:"text-sm opacity-40",children:"Domande per materia"})]})]}),e.jsxs("div",{className:"px-3 py-1.5 rounded-full bg-[#00B1FF]/10 text-[#00B1FF] font-bold text-sm",children:[i.reduce((s,a)=>s+a.question_count,0)," totali"]})]}),e.jsxs("div",{className:"p-6 flex-1 space-y-4 bg-slate-50/30 dark:bg-slate-900/10 overflow-y-auto max-h-[400px]",children:[L.length>0&&e.jsx("div",{className:"flex gap-2",children:e.jsxs("select",{className:`${A} flex-1`,onChange:s=>{s.target.value&&(U(s.target.value),s.target.value="")},children:[e.jsx("option",{value:"",children:"+ Aggiungi materia..."}),L.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),i.length===0?e.jsxs("div",{className:"text-center py-12 bg-white dark:bg-slate-900 rounded-xl border border-dashed border-slate-200 dark:border-slate-700",children:[e.jsx(I,{className:"w-8 h-8 text-slate-300 dark:text-slate-700 mx-auto mb-2"}),e.jsx("p",{className:"text-[var(--foreground)] opacity-40 text-sm",children:"Nessuna materia configurata"})]}):i.map((s,a)=>{var c;const o=((c=F.find(u=>u.id===s.subject_id))==null?void 0:c.name)||"Unknown",n=R[s.subject_id]||0,t=s.question_count>n;return e.jsxs("div",{className:"bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-800 flex items-center justify-between gap-4 group",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-semibold text-[var(--foreground)] truncate",children:o}),e.jsxs("p",{className:"text-xs opacity-40 mt-0.5",children:["Disponibili: ",e.jsx("span",{className:"font-medium opacity-100",children:n})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsx("input",{type:"number",className:`w-20 px-3 py-2 rounded-lg border-2 text-center font-bold focus:outline-none transition-all ${t?"border-red-300 bg-red-50 dark:bg-rose-900/20 text-red-600 dark:text-rose-400":"border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-[var(--foreground)] focus:border-[#00B1FF]"}`,value:s.question_count,onChange:u=>$(a,parseInt(u.target.value)||0)}),t&&e.jsxs("span",{className:"text-[10px] text-red-500 font-bold mt-1",children:["Max ",n,"!"]})]}),e.jsx("button",{onClick:()=>W(a),className:"w-9 h-9 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-red-50 dark:hover:bg-rose-900/20 flex items-center justify-center text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100",children:e.jsx(ae,{className:"w-4 h-4"})})]})]},s.subject_id)})]}),e.jsx("div",{className:"p-6 border-t border-[var(--card-border)] bg-slate-50/50 dark:bg-slate-900/50",children:e.jsxs("button",{onClick:G,disabled:m||i.some(s=>s.question_count>(R[s.subject_id]||0)),className:"w-full py-3 bg-violet-500 hover:bg-violet-600 text-white font-bold rounded-xl shadow-lg shadow-violet-500/20 transition-all disabled:opacity-50 flex items-center justify-center gap-2",children:[m?e.jsx(g,{className:"w-4 h-4 animate-spin"}):e.jsx(D,{className:"w-4 h-4"}),"Salva Regole Materie"]})})]})]})]}):e.jsx(h,{children:e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("div",{className:"w-16 h-16 rounded-2xl bg-amber-50 dark:bg-amber-500/10 flex items-center justify-center mb-4",children:e.jsx(X,{className:"w-8 h-8 text-amber-500"})}),e.jsx("h2",{className:"text-xl font-bold text-[var(--foreground)] mb-2",children:"Nessun concorso selezionato"}),e.jsx("p",{className:"text-[var(--foreground)] opacity-40 mb-6",children:"Seleziona un concorso dalla lista per configurare le regole."}),e.jsxs("button",{onClick:()=>j("/admin/quiz"),className:"px-6 py-3 bg-[#00B1FF] hover:bg-[#00a0e6] text-white font-bold rounded-xl shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2",children:[e.jsx(K,{className:"w-4 h-4"}),"Vai ai Concorsi"]})]})})}export{me as default};
