import{j as t}from"./framer-CcO5Kjcw.js";import{r as h,L as M}from"./router-ClfHAwMg.js";import{s as j}from"./index-Z19V86or.js";import{R as T,ad as E,_ as I,an as F,h as V,I as D,t as H}from"./icons-Dvxa2Qho.js";import"./react-vendor-B--z-fyW.js";import"./supabase-CIvuJI4W.js";function K(){const[w,N]=h.useState("import"),[U,k]=h.useState(!1),[y,C]=h.useState(!1),[u,g]=h.useState(null),b=h.useRef(null),S=["title","ente_name","category_name","seats_total","seats_reserved","contract_type","salary_range","education_level","age_min","age_max","region","province","city","is_remote","publication_date","deadline","exam_date","application_url","application_method","description","short_description","status","is_featured","source_urls"],$=async s=>{var l;const o=(l=s.target.files)==null?void 0:l[0];if(o){if(!o.name.endsWith(".csv")){alert("Seleziona un file CSV");return}k(!0),g(null);try{const r=await o.text(),e=B(r);if(e.length===0){g({success:0,errors:["Il file Ã¨ vuoto"]});return}const m=e[0].map(i=>i.trim().toLowerCase()),d=e.slice(1),{data:c}=await j.from("enti").select("id, name"),{data:p}=await j.from("bandi_categories").select("id, name"),a=new Map((c==null?void 0:c.map(i=>[i.name.toLowerCase(),i.id]))||[]),v=new Map((p==null?void 0:p.map(i=>[i.name.toLowerCase(),i.id]))||[]);let L=0;const f=[];for(let i=0;i<d.length;i++){const _=d[i];if(!(_.length===0||_.length===1&&!_[0]))try{const x=O(m,_,a,v);if(!x.title||!x.deadline){f.push(`Riga ${i+2}: titolo e scadenza sono obbligatori`);continue}const{error:R}=await j.from("bandi").insert(x);R?f.push(`Riga ${i+2}: ${R.message}`):L++}catch(x){f.push(`Riga ${i+2}: ${x.message}`)}}g({success:L,errors:f})}catch(r){g({success:0,errors:[r.message]})}finally{k(!1),b.current&&(b.current.value="")}}},B=s=>s.split(`
`).map(l=>{const r=[];let e="",m=!1;for(const d of l)d==='"'?m=!m:d===","&&!m?(r.push(e.trim()),e=""):e+=d;return r.push(e.trim()),r}),O=(s,o,l,r)=>{const e=c=>{var a;const p=s.indexOf(c);return p>=0&&((a=o[p])==null?void 0:a.trim())||""},m=e("ente_name"),d=e("category_name");return{title:e("title"),ente_id:m&&l.get(m.toLowerCase())||null,category_id:d&&r.get(d.toLowerCase())||null,seats_total:e("seats_total")?parseInt(e("seats_total")):null,seats_reserved:e("seats_reserved")?parseInt(e("seats_reserved")):null,contract_type:e("contract_type")||null,salary_range:e("salary_range")||null,education_level:e("education_level")?e("education_level").split(",").map(c=>c.trim()):null,age_min:e("age_min")?parseInt(e("age_min")):null,age_max:e("age_max")?parseInt(e("age_max")):null,region:e("region")||null,province:e("province")||null,city:e("city")||null,is_remote:e("is_remote").toLowerCase()==="true",publication_date:e("publication_date")||null,deadline:e("deadline"),exam_date:e("exam_date")||null,application_url:e("application_url")||null,application_method:e("application_method")||null,description:e("description")||null,short_description:e("short_description")||null,status:e("status")||"draft",is_featured:e("is_featured").toLowerCase()==="true",source_urls:e("source_urls")?e("source_urls").split(",").map(c=>c.trim()):null}},z=async()=>{var s,o;C(!0);try{const{data:l,error:r}=await j.from("bandi").select(`
                    *,
                    ente:enti(name),
                    category:bandi_categories(name)
                `).order("created_at",{ascending:!1});if(r)throw r;if(!l||l.length===0){alert("Nessun bando da esportare");return}const e=[S.join(",")];for(const a of l){const v=[n(a.title),n(((s=a.ente)==null?void 0:s.name)||""),n(((o=a.category)==null?void 0:o.name)||""),a.seats_total||"",a.seats_reserved||"",n(a.contract_type||""),n(a.salary_range||""),n((a.education_level||[]).join(", ")),a.age_min||"",a.age_max||"",n(a.region||""),n(a.province||""),n(a.city||""),a.is_remote?"true":"false",a.publication_date||"",a.deadline||"",a.exam_date||"",n(a.application_url||""),n(a.application_method||""),n(a.description||""),n(a.short_description||""),a.status,a.is_featured?"true":"false",n((a.source_urls||[]).join(", "))];e.push(v.join(","))}const m=e.join(`
`),d=new Blob([m],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(d),p=document.createElement("a");p.href=c,p.download=`bandi_export_${new Date().toISOString().split("T")[0]}.csv`,p.click(),URL.revokeObjectURL(c)}catch(l){alert("Errore durante l'esportazione: "+l.message)}finally{C(!1)}},n=s=>s.includes(",")||s.includes('"')||s.includes(`
`)?`"${s.replace(/"/g,'""')}"`:s,A=()=>{const s=S.join(",")+`
`,o=new Blob([s],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(o),r=document.createElement("a");r.href=l,r.download="bandi_template.csv",r.click(),URL.revokeObjectURL(l)};return t.jsxs("div",{className:"min-h-screen bg-slate-50 dark:bg-slate-950 p-6",children:[t.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[t.jsx(M,{to:"/admin/bandi",className:"p-2 hover:bg-white dark:hover:bg-slate-800 rounded-lg",children:t.jsx(T,{className:"w-5 h-5 text-slate-600 dark:text-slate-300"})}),t.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:"Import / Export Bandi"})]}),t.jsxs("div",{className:"flex gap-2 mb-6",children:[t.jsxs("button",{onClick:()=>N("import"),className:`px-4 py-2 rounded-lg font-medium transition-colors ${w==="import"?"bg-emerald-500 text-white":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300"}`,children:[t.jsx(E,{className:"w-4 h-4 inline mr-2"}),"Import"]}),t.jsxs("button",{onClick:()=>N("export"),className:`px-4 py-2 rounded-lg font-medium transition-colors ${w==="export"?"bg-emerald-500 text-white":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300"}`,children:[t.jsx(I,{className:"w-4 h-4 inline mr-2"}),"Export"]})]}),w==="import"?t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl p-6",children:[t.jsx("h2",{className:"text-lg font-semibold text-slate-900 dark:text-white mb-4",children:"Importa Bandi da CSV"}),t.jsx("p",{className:"text-slate-600 dark:text-slate-400 mb-4",children:"Carica un file CSV con i bandi da importare. Assicurati che il file rispetti il formato del template."}),t.jsx("div",{className:"flex gap-3 mb-6",children:t.jsxs("button",{onClick:A,className:"flex items-center gap-2 px-4 py-2 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700",children:[t.jsx(F,{className:"w-4 h-4"}),"Scarica Template"]})}),t.jsxs("div",{className:"border-2 border-dashed border-slate-200 dark:border-slate-600 rounded-xl p-8 text-center cursor-pointer hover:border-emerald-400 transition-colors",onClick:()=>{var s;return(s=b.current)==null?void 0:s.click()},children:[t.jsx("input",{ref:b,type:"file",accept:".csv",onChange:$,className:"hidden"}),U?t.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t.jsx(V,{className:"w-10 h-10 text-emerald-500 animate-spin"}),t.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"Importazione in corso..."})]}):t.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t.jsx(E,{className:"w-10 h-10 text-slate-400"}),t.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"Clicca o trascina un file CSV"})]})]})]}),u&&t.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl p-6",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[u.errors.length===0?t.jsx(D,{className:"w-6 h-6 text-emerald-500"}):t.jsx(H,{className:"w-6 h-6 text-amber-500"}),t.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-white",children:"Risultato Importazione"})]}),t.jsxs("p",{className:"text-slate-600 dark:text-slate-400 mb-4",children:[u.success," bandi importati con successo"]}),u.errors.length>0&&t.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 rounded-lg p-4",children:[t.jsxs("h4",{className:"text-sm font-semibold text-red-700 dark:text-red-400 mb-2",children:["Errori (",u.errors.length,")"]}),t.jsx("ul",{className:"space-y-1 max-h-40 overflow-y-auto",children:u.errors.map((s,o)=>t.jsx("li",{className:"text-sm text-red-600 dark:text-red-400",children:s},o))})]})]})]}):t.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl p-6",children:[t.jsx("h2",{className:"text-lg font-semibold text-slate-900 dark:text-white mb-4",children:"Esporta Bandi in CSV"}),t.jsx("p",{className:"text-slate-600 dark:text-slate-400 mb-6",children:"Esporta tutti i bandi presenti nel database in formato CSV."}),t.jsxs("button",{onClick:z,disabled:y,className:"flex items-center gap-2 px-6 py-3 bg-emerald-500 text-white rounded-lg font-medium hover:bg-emerald-600 disabled:opacity-50",children:[y?t.jsx(V,{className:"w-5 h-5 animate-spin"}):t.jsx(I,{className:"w-5 h-5"}),"Esporta CSV"]})]})]})}export{K as default};
