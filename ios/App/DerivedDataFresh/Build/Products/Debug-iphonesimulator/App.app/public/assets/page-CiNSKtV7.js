import{j as e}from"./framer-CcO5Kjcw.js";import{r as l,u as O}from"./router-ClfHAwMg.js";import{s as d,u as q,g as B,h as j}from"./index-BcNl-kiB.js";import{h as T,T as $,a6 as Q,X as V,R as X,aB as Z,k as I,aC as G,aD as H,aE as J}from"./icons-Dvxa2Qho.js";import"./react-vendor-B--z-fyW.js";import"./supabase-CIvuJI4W.js";async function K(){try{const{data:{user:a}}=await d.auth.getUser();if(!a)return{success:!1,error:"Utente non autenticato"};try{const{data:s}=await d.storage.from("avatars").list("",{search:a.id});if(s&&s.length>0){const t=s.map(n=>n.name);await d.storage.from("avatars").remove(t)}}catch(s){console.warn("Could not delete avatar:",s)}const{error:o}=await d.rpc("delete_user_account");return o?(console.error("Delete account error:",o),{success:!1,error:"Impossibile eliminare l'account. Riprova piÃ¹ tardi."}):(await d.auth.signOut(),{success:!0})}catch(a){return console.error("Unexpected error during account deletion:",a),{success:!1,error:"Si Ã¨ verificato un errore imprevisto."}}}function W({isOpen:a,onClose:o,onConfirm:s,isDeleting:t=!1,error:n=null}){const[u,i]=l.useState(""),x=u==="ELIMINA";if(!a)return null;const b=async h=>{h.preventDefault(),x&&!t&&(await s(),i(""))},m=()=>{t||(i(""),o())};return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 animate-in fade-in duration-200",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:m}),e.jsxs("div",{className:"relative bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200",children:[e.jsxs("div",{className:"pt-8 pb-4 px-6 text-center",children:[e.jsx("div",{className:`mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-5 ${t?"bg-amber-100 dark:bg-amber-900/30":"bg-rose-100 dark:bg-rose-900/30"}`,children:t?e.jsx(T,{className:"w-8 h-8 text-amber-500 animate-spin"}):e.jsx($,{className:"w-8 h-8 text-rose-500"})}),e.jsx("h2",{className:"text-xl font-bold text-slate-900 dark:text-white mb-2",children:t?"Eliminazione in corso...":"Sei davvero sicuro di voler eliminare l'account?"}),e.jsx("p",{className:"text-[14px] text-slate-500 dark:text-slate-400",children:t?"Stiamo eliminando tutti i tuoi dati. Non chiudere questa finestra.":"Tutti i dati andranno persi per sempre."}),n&&e.jsx("div",{className:"mt-4 p-3 bg-rose-50 dark:bg-rose-900/30 border border-rose-200 dark:border-rose-800 rounded-xl",children:e.jsx("p",{className:"text-[13px] text-rose-600 dark:text-rose-400 font-medium",children:n})})]}),!t&&e.jsxs("form",{onSubmit:b,className:"px-6 pb-6",children:[e.jsxs("p",{className:"text-[12px] text-slate-400 mb-2 text-center",children:["Digita ",e.jsx("span",{className:"font-bold text-rose-500",children:"ELIMINA"})," per confermare"]}),e.jsx("input",{type:"text",value:u,onChange:h=>i(h.target.value.toUpperCase()),placeholder:"ELIMINA",className:"w-full px-4 py-3.5 bg-slate-50 dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-xl text-center font-bold text-lg tracking-widest placeholder-slate-300 dark:placeholder-slate-500 text-slate-900 dark:text-white focus:outline-none focus:border-rose-300 dark:focus:border-rose-500 focus:ring-4 focus:ring-rose-100 dark:focus:ring-rose-900/30 transition-all",autoComplete:"off",autoFocus:!0}),e.jsxs("div",{className:"flex flex-col gap-3 mt-6",children:[e.jsx("button",{type:"button",onClick:m,className:"w-full py-4 rounded-2xl font-bold text-[15px] bg-slate-900 dark:bg-slate-700 hover:bg-slate-800 dark:hover:bg-slate-600 text-white shadow-lg transition-all active:scale-[0.98]",children:"Annulla"}),e.jsxs("button",{type:"submit",disabled:!x,className:`w-full py-3 text-[14px] font-semibold transition-colors flex items-center justify-center gap-1.5 ${x?"text-rose-500 hover:text-rose-600":"text-slate-300 dark:text-slate-600 cursor-not-allowed"}`,children:[e.jsx(Q,{className:"w-4 h-4"}),"Elimina"]})]})]}),t&&e.jsx("div",{className:"px-6 pb-8",children:e.jsx("div",{className:"w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-500 rounded-full animate-pulse",style:{width:"60%"}})})}),!t&&e.jsx("button",{onClick:m,className:"absolute top-4 right-4 p-2 rounded-full bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors",children:e.jsx(V,{className:"w-4 h-4 text-slate-500 dark:text-slate-400"})})]})]})}function oe(){const{user:a,profile:o,loading:s,refreshProfile:t}=q(),{theme:n,setTheme:u}=B(),i=O(),[x,b]=l.useState(""),[m,h]=l.useState(null),[N,f]=l.useState(!1),[U,k]=l.useState(!1),[p,g]=l.useState(null),[M,y]=l.useState(!1),[D,S]=l.useState(!1),[L,v]=l.useState(null),C=l.useRef(null);l.useEffect(()=>{if(!s&&!a){i("/login");return}o&&(b(o.nickname||""),h(o.avatar_url))},[a,o,s,i]);const P=async r=>{if(!r.target.files||r.target.files.length===0)return;const c=r.target.files[0];try{f(!0);const w=c.name.split(".").pop(),E=`${`${a==null?void 0:a.id}-${Date.now()}.${w}`}`,{error:A}=await d.storage.from("avatars").upload(E,c);if(A)throw A;const{data:_}=d.storage.from("avatars").getPublicUrl(E);h(_.publicUrl),g({type:"success",text:"Immagine caricata. Ricordati di salvare!"})}catch(w){console.error("Upload Error:",w),g({type:"error",text:"Errore durante il caricamento immagine."})}finally{f(!1)}},z=async r=>{r.preventDefault(),f(!0),g(null);try{const{error:c}=await d.from("profiles").upsert({id:a==null?void 0:a.id,email:a==null?void 0:a.email,nickname:x,avatar_url:m,updated_at:new Date().toISOString()});if(c)throw c;await t(),k(!0),setTimeout(()=>k(!1),2e3)}catch(c){console.error(c),g({type:"error",text:`Errore: ${c.message||"Salvataggio fallito"}`})}finally{f(!1)}},R=()=>{v(null),y(!0)},F=async()=>{S(!0),v(null);const r=await K();r.success?i("/",{replace:!0}):(v(r.error||"Errore durante l'eliminazione"),S(!1))};return s?e.jsx("div",{className:"min-h-screen bg-[var(--background)] flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin"})}):e.jsxs("div",{className:"min-h-screen bg-[var(--background)] pb-28 transition-colors duration-300",children:[e.jsx("header",{className:"sticky top-0 z-20 bg-[var(--background)]/80 backdrop-blur-md pt-safe",children:e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 max-w-md mx-auto",children:[e.jsx("button",{onClick:()=>i("/profile"),className:"w-10 h-10 rounded-full bg-[var(--card)] flex items-center justify-center transition-all hover:opacity-80 active:scale-95 border border-[var(--card-border)] shadow-sm",children:e.jsx(X,{className:"w-5 h-5 text-[var(--foreground)]"})}),e.jsx("h1",{className:"text-[17px] font-bold text-[var(--foreground)]",children:"Impostazioni Profilo"}),e.jsx("div",{className:"w-10"})]})}),e.jsxs("div",{className:"max-w-md mx-auto px-5 pt-8",children:[e.jsxs("div",{className:"flex flex-col items-center mb-10",children:[e.jsxs("div",{className:"relative cursor-pointer group",onClick:()=>{var r;return(r=C.current)==null?void 0:r.click()},children:[e.jsx("div",{className:"w-28 h-28 rounded-[32px] bg-[var(--card)] shadow-lg overflow-hidden transition-all group-hover:shadow-xl group-active:scale-95",children:m?e.jsx("img",{src:m,alt:"Avatar",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-4xl bg-slate-100 dark:bg-slate-700",children:"ðŸ‘¤"})}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-9 h-9 bg-emerald-500 rounded-full flex items-center justify-center shadow-lg shadow-emerald-500/30 border-[3px] border-[var(--background)] transition-all group-hover:scale-110",children:e.jsx(Z,{className:"w-4 h-4 text-white"})})]}),e.jsx("input",{type:"file",ref:C,className:"hidden",accept:"image/*",onChange:P}),e.jsx("p",{className:"text-[13px] text-[var(--foreground)] opacity-50 mt-4 font-medium",children:"Tocca per cambiare foto"})]}),p&&e.jsxs("div",{className:`mb-6 p-4 rounded-2xl text-[14px] text-center font-semibold flex items-center justify-center gap-2 ${p.type==="success"?"bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 border border-emerald-100 dark:border-emerald-800":"bg-rose-50 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 border border-rose-100 dark:border-rose-800"}`,children:[p.type==="success"?e.jsx(I,{className:"w-4 h-4"}):e.jsx($,{className:"w-4 h-4"}),p.text]}),e.jsxs("div",{className:"bg-[var(--card)] rounded-2xl p-5 shadow-sm border border-[var(--card-border)] mb-6",children:[e.jsx("label",{className:"block text-[11px] font-bold text-[var(--foreground)] opacity-50 uppercase tracking-widest mb-4",children:"Tema"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("button",{onClick:()=>{j(),u("light")},className:`flex flex-col items-center gap-2 p-3 rounded-xl transition-all ${n==="light"?"bg-emerald-500 text-white shadow-lg shadow-emerald-500/30":"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"}`,children:[e.jsx(G,{className:"w-5 h-5"}),e.jsx("span",{className:"text-[11px] font-bold",children:"Chiaro"})]}),e.jsxs("button",{onClick:()=>{j(),u("dark")},className:`flex flex-col items-center gap-2 p-3 rounded-xl transition-all ${n==="dark"?"bg-emerald-500 text-white shadow-lg shadow-emerald-500/30":"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"}`,children:[e.jsx(H,{className:"w-5 h-5"}),e.jsx("span",{className:"text-[11px] font-bold",children:"Scuro"})]}),e.jsxs("button",{onClick:()=>{j(),u("system")},className:`flex flex-col items-center gap-2 p-3 rounded-xl transition-all ${n==="system"?"bg-emerald-500 text-white shadow-lg shadow-emerald-500/30":"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"}`,children:[e.jsx(J,{className:"w-5 h-5"}),e.jsx("span",{className:"text-[11px] font-bold",children:"Auto"})]})]})]}),e.jsxs("form",{onSubmit:z,className:"space-y-8",children:[e.jsxs("div",{className:"bg-[var(--card)] rounded-2xl p-5 shadow-sm border border-[var(--card-border)]",children:[e.jsx("label",{className:"block text-[11px] font-bold text-[var(--foreground)] opacity-50 uppercase tracking-widest mb-3",children:"Nickname"}),e.jsx("input",{type:"text",value:x,onChange:r=>b(r.target.value),className:"w-full px-0 py-2 bg-transparent border-b-2 border-slate-200 dark:border-slate-600 focus:border-emerald-400 outline-none transition-all text-[18px] font-bold text-[var(--foreground)] placeholder-slate-400",placeholder:"Come vuoi chiamarti?",required:!0,minLength:3,maxLength:20}),e.jsx("p",{className:"text-[12px] text-[var(--foreground)] opacity-50 mt-3",children:"Questo nome sarÃ  visibile nelle classifiche."})]}),e.jsx("button",{type:"submit",disabled:N,className:"w-full py-4 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-2xl transition-all shadow-lg shadow-emerald-500/20 disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center gap-2 text-[16px] active:scale-[0.98]",children:N?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"w-5 h-5 animate-spin"}),"Salvataggio..."]}):U?e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"w-5 h-5"}),"Salvato!"]}):"Salva modifiche"})]}),e.jsxs("div",{className:"mt-12 pt-8 border-t border-slate-200 dark:border-slate-700",children:[e.jsx("h3",{className:"text-[12px] font-bold text-[var(--foreground)] opacity-50 uppercase tracking-widest mb-4",children:"Zona pericolo"}),e.jsx("button",{onClick:R,className:"w-full py-3.5 bg-[var(--card)] border-2 border-rose-200 dark:border-rose-800 text-rose-500 font-bold rounded-2xl hover:bg-rose-50 dark:hover:bg-rose-900/30 transition-all active:scale-[0.98]",children:"Elimina account"})]})]}),e.jsx(W,{isOpen:M,onClose:()=>y(!1),onConfirm:F,isDeleting:D,error:L})]})}export{oe as default};
