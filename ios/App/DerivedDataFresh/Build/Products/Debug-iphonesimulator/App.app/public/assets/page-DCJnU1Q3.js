import{j as e}from"./framer-CcO5Kjcw.js";import{b as O,a as T,u as $,r as i}from"./router-ClfHAwMg.js";import{s as c,b as D}from"./index-BcNl-kiB.js";import{t as B,j as U,w as R,q as W,v as F}from"./icons-Dvxa2Qho.js";import"./react-vendor-B--z-fyW.js";import"./supabase-CIvuJI4W.js";function v(a){return a?a.replace(/[.,:;()[\]]/g,"").trim().toLowerCase():null}function G(a){return a?a.correct_option?v(a.correct_option):a.correct_answer?v(a.correct_answer):a.answer?v(a.answer):null:null}function Z(){const{quizId:a}=O(),[C]=T(),g=C.get("subject"),u=$(),[b,m]=i.useState(null),[q,p]=i.useState(!0),[N,y]=i.useState(!1),[k,E]=i.useState("Quiz"),[x,P]=i.useState([]),[o,f]=i.useState([]),[j,A]=i.useState(10);i.useEffect(()=>{(async()=>{if(!a){m("Quiz non specificato"),p(!1);return}try{const{data:{user:r}}=await c.auth.getUser();if(!r){u("/login");return}const{data:d}=await c.from("quizzes").select("id, title").eq("id",a).single();if(!d)throw new Error("Quiz non trovato");E(d.title);const{data:l}=await c.from("subjects").select("id, name").eq("quiz_id",a).eq("is_archived",!1);if(!(l!=null&&l.length))throw new Error("Nessuna materia trovata");const S=await Promise.all(l.map(async n=>{const{count:h}=await c.from("questions").select("*",{count:"exact",head:!0}).eq("subject_id",n.id).eq("is_archived",!1);return{id:n.id,name:n.name,questionCount:h||0}}));P(S.filter(n=>n.questionCount>0)),g&&f([g]),p(!1)}catch(r){console.error("Practice page error:",r),m(r.message),p(!1)}})()},[a,u,g]);const L=t=>{f(r=>r.includes(t)?r.filter(d=>d!==t):[...r,t])},Q=()=>{f(x.map(t=>t.id))},I=()=>{f([])},w=x.filter(t=>o.includes(t.id)).reduce((t,r)=>t+r.questionCount,0),M=async()=>{if(o.length===0){m("Seleziona almeno una materia");return}y(!0),m(null);try{const{data:{user:t}}=await c.auth.getUser();if(!t)throw new Error("Utente non autenticato");const{data:r,error:d}=await c.from("questions").select("*, subject:subjects(name)").in("subject_id",o).eq("is_archived",!1);if(d||!(r!=null&&r.length))throw new Error("Nessuna domanda disponibile");const l=r.sort(()=>Math.random()-.5),n=l.slice(0,Math.min(j,l.length)).map(s=>{var z;return{questionId:s.id,text:s.text,subjectId:s.subject_id,subjectName:((z=s.subject)==null?void 0:z.name)||"Materia",selectedOption:null,correctOption:G(s),isCorrect:!1,isSkipped:!1,explanation:s.explanation||null,options:{a:s.option_a,b:s.option_b,c:s.option_c,d:s.option_d}}}),{data:h,error:_}=await c.from("quiz_attempts").insert({quiz_id:a,user_id:t.id,score:0,answers:n,total_questions:n.length,correct:0,wrong:0,blank:0,started_at:new Date().toISOString(),mode:"custom",config_snapshot:{type:"practice",subjects:o,questionCount:j,subjectNames:x.filter(s=>o.includes(s.id)).map(s=>s.name)}}).select().single();if(_||!h)throw _;D.track("quiz_started",{quiz_id:a,title:k,mode:"practice",subjects_count:o.length,questions_count:n.length}),u(`/quiz/run/${h.id}?mode=practice&time=0`)}catch(t){console.error("Start error:",t),m(t.message),y(!1)}};return q?e.jsx("div",{className:"min-h-screen bg-[var(--background)] flex items-center justify-center transition-colors",children:e.jsx("div",{className:"w-8 h-8 border-2 border-brand-cyan border-t-transparent rounded-full animate-spin"})}):b&&x.length===0?e.jsx("div",{className:"min-h-screen bg-[var(--background)] flex flex-col items-center justify-center p-4 transition-colors",children:e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 p-4 rounded-xl max-w-sm text-center border border-red-100 dark:border-red-800/30",children:[e.jsx(B,{className:"w-8 h-8 mx-auto mb-2"}),e.jsx("p",{className:"font-medium",children:b}),e.jsx("button",{onClick:()=>u(-1),className:"mt-4 text-sm font-bold underline",children:"Torna indietro"})]})}):e.jsxs("div",{className:"min-h-screen bg-[var(--background)] flex flex-col transition-colors duration-500",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-[var(--card)] border-b border-[var(--card-border)] pt-safe",children:e.jsxs("div",{className:"px-4 h-14 flex items-center gap-3 max-w-3xl mx-auto w-full",children:[e.jsx("button",{onClick:()=>u(-1),className:"w-10 h-10 -ml-2 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors",children:e.jsx(U,{className:"w-5 h-5 text-slate-400 rotate-180"})}),e.jsx("span",{className:"font-semibold text-[var(--foreground)]",children:"Allenamento"})]})}),e.jsxs("main",{className:"flex-1 px-5 py-6 max-w-lg mx-auto w-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-12 h-12 rounded-2xl bg-brand-cyan/10 flex items-center justify-center",children:e.jsx(R,{className:"w-6 h-6 text-brand-cyan"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-[var(--foreground)]",children:k}),e.jsx("p",{className:"text-sm text-[var(--foreground)] opacity-50",children:"Pratica personalizzata"})]})]}),e.jsxs("div",{className:"bg-[var(--card)] rounded-3xl p-5 shadow-sm border border-[var(--card-border)] mt-6 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"font-bold text-[var(--foreground)] flex items-center gap-2",children:[e.jsx(W,{className:"w-5 h-5 text-brand-cyan"}),"Seleziona Materie"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:Q,className:"text-xs font-bold text-brand-cyan hover:underline",children:"Tutte"}),e.jsx("span",{className:"text-slate-300",children:"|"}),e.jsx("button",{onClick:I,className:"text-xs font-bold text-[var(--foreground)] opacity-40 hover:opacity-100 hover:underline",children:"Nessuna"})]})]}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:x.map(t=>{const r=o.includes(t.id);return e.jsxs("button",{onClick:()=>L(t.id),className:`w-full flex items-center justify-between p-3 rounded-xl transition-all ${r?"bg-brand-cyan/10 border border-brand-cyan/30":"bg-slate-50 dark:bg-slate-800/50 border border-transparent hover:bg-slate-100 dark:hover:bg-slate-800"}`,children:[e.jsx("span",{className:`font-medium ${r?"text-brand-cyan":"text-[var(--foreground)]"}`,children:t.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-[var(--foreground)] opacity-40",children:[t.questionCount," domande"]}),e.jsx("div",{className:`w-5 h-5 rounded-full border-2 flex items-center justify-center ${r?"border-brand-cyan bg-brand-cyan":"border-slate-300 dark:border-slate-700"}`,children:r&&e.jsx("svg",{className:"w-3 h-3 text-white",viewBox:"0 0 14 14",fill:"none",children:e.jsx("path",{d:"M11.6666 3.5L5.24992 9.91667L2.33325 7",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]})]},t.id)})})]}),e.jsxs("div",{className:"bg-[var(--card)] rounded-3xl p-5 shadow-sm border border-[var(--card-border)] mb-6",children:[e.jsx("h3",{className:"font-bold text-[var(--foreground)] mb-4",children:"Numero di Domande"}),e.jsx("div",{className:"flex gap-2",children:[5,10,20,30,50].map(t=>e.jsx("button",{onClick:()=>A(t),disabled:t>w,className:`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${j===t?"bg-brand-cyan text-white":t>w?"bg-slate-100 dark:bg-slate-800 text-slate-300 dark:text-slate-700 cursor-not-allowed":"bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700"}`,children:t},t))}),e.jsxs("p",{className:"text-xs text-[var(--foreground)] opacity-40 mt-2 text-center",children:[w," domande disponibili"]})]}),b&&e.jsx("div",{className:"bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 p-3 rounded-xl text-sm mb-4 text-center border border-red-100 dark:border-red-800/30",children:b}),e.jsx("button",{onClick:M,disabled:N||o.length===0,className:"mt-auto w-full py-4 rounded-2xl bg-brand-cyan text-white font-bold text-lg shadow-lg shadow-cyan-500/20 active:scale-[0.98] transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",children:N?e.jsx("div",{className:"w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsxs(e.Fragment,{children:["Inizia Allenamento ",e.jsx(F,{className:"w-5 h-5 fill-current"})]})})]})]})}export{Z as default};
